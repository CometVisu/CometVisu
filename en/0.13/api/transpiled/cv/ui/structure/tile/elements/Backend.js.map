{
  "version": 3,
  "names": [
    "qx",
    "Bootstrap",
    "executePendingDefers",
    "$$dbClassInfo",
    "Class",
    "define",
    "extend",
    "cv",
    "ui",
    "structure",
    "tile",
    "elements",
    "AbstractCustomElement",
    "members",
    "_name",
    "__applyValues",
    "_init",
    "_this",
    "element",
    "_element",
    "type",
    "getAttribute",
    "startsWith",
    "className",
    "split",
    "pop",
    "io",
    "BackendConnections",
    "isRegistered",
    "addClassLoadedListener",
    "uriString",
    "hasAttribute",
    "uri",
    "URL",
    "window",
    "location",
    "origin",
    "pathname",
    "e",
    "error",
    "credentials",
    "username",
    "password",
    "model",
    "data",
    "Model",
    "getInstance",
    "backendUrl",
    "toString",
    "backendUrlConfigKey",
    "Config",
    "server",
    "name",
    "hasClient",
    "getClient",
    "configuredIn",
    "log",
    "Logger",
    "warn",
    "concat",
    "debug",
    "notification",
    "topic",
    "title",
    "locale",
    "Manager",
    "tr",
    "message",
    "severity",
    "unique",
    "deletable",
    "core",
    "notifications",
    "Router",
    "dispatchMessage",
    "client",
    "addBackendClient",
    "_client",
    "update",
    "updateFrom",
    "_iterator",
    "_createForOfIteratorHelper",
    "querySelectorAll",
    "_step",
    "s",
    "n",
    "done",
    "value",
    "setResourcePath",
    "textContent",
    "trim",
    "err",
    "f",
    "login",
    "setDefaultBackendName",
    "doSubscribe",
    "_iterator2",
    "_step2",
    "_step2$value",
    "_slicedToArray",
    "address",
    "onUpdate",
    "startInitialRequest",
    "TemplateEngine",
    "isDomFinished",
    "event",
    "Bus",
    "subscribe",
    "_disconnected",
    "resetDefaultBackendName",
    "terminate",
    "removeClient",
    "dispose",
    "defer",
    "Clazz",
    "customElements",
    "Controller",
    "PREFIX",
    "_QxConnector",
    "_inherits",
    "_class",
    "_super",
    "_createSuper",
    "_classCallCheck",
    "call",
    "_createClass",
    "QxConnector",
    "Backend"
  ],
  "sources": [
    "/home/runner/work/CometVisu/CometVisu/source/class/cv/ui/structure/tile/elements/Backend.js"
  ],
  "sourcesContent": [
    "/* Backend.js\n *\n * copyright (c) 2010-2022, Christian Mayer and the CometVisu contributers.\n *\n * This program is free software; you can redistribute it and/or modify it\n * under the terms of the GNU General Public License as published by the Free\n * Software Foundation; either version 3 of the License, or (at your option)\n * any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for\n * more details.\n *\n * You should have received a copy of the GNU General Public License along\n * with this program; if not, write to the Free Software Foundation, Inc.,\n * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA\n */\n\n/**\n * <cv-backend> Custom element to define a backend connection\n */\nqx.Class.define('cv.ui.structure.tile.elements.Backend', {\n  extend: cv.ui.structure.tile.elements.AbstractCustomElement,\n\n  /*\n  ***********************************************\n    MEMBERS\n  ***********************************************\n  */\n  members: {\n    _name: null,\n    __applyValues: null,\n\n    _init() {\n      const element = this._element;\n      let type = element.getAttribute('type');\n      if (type && type.startsWith('class:')) {\n        const className = type.split(':').pop();\n        if (!cv.io.BackendConnections.isRegistered(className)) {\n          // wait until client class has been loaded\n          cv.io.BackendConnections.addClassLoadedListener(className, () => {\n            this._init();\n          });\n          return;\n        }\n        type = className;\n      }\n      const uriString = element.hasAttribute('uri') ? element.getAttribute('uri') : '';\n      let uri;\n      if (uriString) {\n        try {\n          uri = new URL(uriString, window.location.origin + window.location.pathname);\n        } catch (e) {\n          this.error('Error parsing uri: ' + uriString);\n        }\n      }\n\n      if (type) {\n        let credentials = null;\n        if (element.hasAttribute('username')) {\n          credentials = {\n            username: element.getAttribute('username'),\n            password: element.getAttribute('password') || ''\n          };\n        } else if (uri && uri.username) {\n          credentials = {\n            username: uri.username,\n            password: uri.password\n          };\n        }\n        const model = cv.data.Model.getInstance();\n        let backendUrl = uri ? uri.toString() : null;\n        let backendUrlConfigKey;\n        switch (type) {\n          case 'knxd':\n            backendUrlConfigKey = 'backendKnxdUrl';\n            break;\n          case 'openhab':\n            backendUrlConfigKey = 'backendOpenHABUrl';\n            break;\n          case 'mqtt':\n            backendUrlConfigKey = 'backendMQTTUrl';\n            break;\n        }\n\n        if (backendUrlConfigKey) {\n          // override by URL settings\n          if (cv.Config.URL[backendUrlConfigKey]) {\n            backendUrl = cv.Config.URL[backendUrlConfigKey];\n          } else if (!backendUrl && cv.Config.server[backendUrlConfigKey]) {\n            backendUrl = cv.Config.server[backendUrlConfigKey];\n          }\n        }\n        let name = type;\n        if (element.hasAttribute('name')) {\n          name = element.getAttribute('name');\n        } else if (!cv.io.BackendConnections.hasClient('main')) {\n          // we need one main backend\n          name = 'main';\n        } else if (cv.io.BackendConnections.getClient('main').configuredIn === 'config') {\n          qx.log.Logger.warn(\n            this,\n            `there is already a backend registered with name \"main\" and type ${type} skipping this one`\n          );\n\n          return;\n        }\n        qx.log.Logger.debug(this, 'init backend', name);\n        if (cv.io.BackendConnections.hasClient(name)) {\n          const notification = {\n            topic: 'cv.config.error',\n            title: qx.locale.Manager.tr('Config error'),\n            message: qx.locale.Manager.tr('There already exists a backend named: \"%1\"', name),\n\n            severity: 'urgent',\n            unique: true,\n            deletable: true\n          };\n\n          cv.core.notifications.Router.dispatchMessage(notification.topic, notification);\n\n          return;\n        }\n        const client = cv.io.BackendConnections.addBackendClient(name, type, backendUrl, 'config');\n\n        this._client = client;\n        this._name = name;\n        this.__applyValues = [];\n        client.update = data => model.updateFrom(name, data); // override clients update function\n\n        for (const data of element.querySelectorAll(':scope > cv-resource')) {\n          client.setResourcePath(data.getAttribute('name'), data.textContent.trim());\n        }\n\n        client.login(true, credentials, () => {\n          this.debug(name, 'connected');\n          if (element.hasAttribute('default') && element.getAttribute('default') === 'true') {\n            model.setDefaultBackendName(name);\n          }\n          const doSubscribe = () => {\n            for (const [address, value] of this.__applyValues) {\n              this.debug(name, 'apply update', address, value);\n              model.onUpdate(address, value, name);\n            }\n            cv.io.BackendConnections.startInitialRequest(name);\n          };\n          if (cv.TemplateEngine.getInstance().isDomFinished()) {\n            doSubscribe();\n          } else {\n            qx.event.message.Bus.subscribe(\n              'setup.dom.finished',\n              function () {\n                doSubscribe();\n              },\n              this\n            );\n          }\n        });\n      } else {\n        this.error('<cv-backend> must have a type attribute');\n      }\n    },\n\n    _disconnected() {\n      if (this._client) {\n        const model = cv.data.Model.getInstance();\n        if (this._element.hasAttribute('default') && this._element.getAttribute('default') === 'true') {\n          model.resetDefaultBackendName();\n        }\n        this._client.terminate();\n        cv.io.BackendConnections.removeClient(this._client);\n        this._client.dispose();\n        this._client = null;\n      }\n    }\n  },\n\n  defer(Clazz) {\n    customElements.define(\n      cv.ui.structure.tile.Controller.PREFIX + 'backend',\n      class extends QxConnector {\n        constructor() {\n          super(Clazz);\n        }\n      }\n    );\n  }\n});\n"
  ],
  "mappings": "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"
}