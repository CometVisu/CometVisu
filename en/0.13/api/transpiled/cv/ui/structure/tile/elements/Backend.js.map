{
  "version": 3,
  "names": [
    "qx",
    "Bootstrap",
    "executePendingDefers",
    "$$dbClassInfo",
    "Class",
    "define",
    "extend",
    "cv",
    "ui",
    "structure",
    "tile",
    "elements",
    "AbstractCustomElement",
    "members",
    "_name",
    "__applyValues",
    "_init",
    "_this",
    "element",
    "_element",
    "type",
    "getAttribute",
    "uriString",
    "hasAttribute",
    "uri",
    "URL",
    "window",
    "location",
    "origin",
    "pathname",
    "e",
    "error",
    "credentials",
    "username",
    "password",
    "model",
    "data",
    "Model",
    "getInstance",
    "backendUrl",
    "toString",
    "backendUrlConfigKey",
    "Config",
    "server",
    "name",
    "io",
    "BackendConnections",
    "hasClient",
    "getClient",
    "configuredIn",
    "log",
    "Logger",
    "warn",
    "concat",
    "debug",
    "notification",
    "topic",
    "title",
    "locale",
    "Manager",
    "tr",
    "message",
    "severity",
    "unique",
    "deletable",
    "core",
    "notifications",
    "Router",
    "dispatchMessage",
    "client",
    "addBackendClient",
    "_client",
    "update",
    "updateFrom",
    "_iterator",
    "_createForOfIteratorHelper",
    "querySelectorAll",
    "_step",
    "s",
    "n",
    "done",
    "value",
    "setResourcePath",
    "textContent",
    "trim",
    "err",
    "f",
    "login",
    "setDefaultBackendName",
    "doSubscribe",
    "_iterator2",
    "_step2",
    "_step2$value",
    "_slicedToArray",
    "address",
    "onUpdate",
    "addressesToSubscribe",
    "getAddresses",
    "length",
    "subscribe",
    "TemplateEngine",
    "isDomFinished",
    "event",
    "Bus",
    "_disconnected",
    "resetDefaultBackendName",
    "terminate",
    "removeClient",
    "dispose",
    "defer",
    "Clazz",
    "customElements",
    "Controller",
    "PREFIX",
    "_QxConnector",
    "_inherits",
    "_class",
    "_super",
    "_createSuper",
    "_classCallCheck",
    "call",
    "_createClass",
    "QxConnector",
    "Backend"
  ],
  "sources": [
    "/home/runner/work/CometVisu/CometVisu/source/class/cv/ui/structure/tile/elements/Backend.js"
  ],
  "sourcesContent": [
    "/* Backend.js\n *\n * copyright (c) 2010-2022, Christian Mayer and the CometVisu contributers.\n *\n * This program is free software; you can redistribute it and/or modify it\n * under the terms of the GNU General Public License as published by the Free\n * Software Foundation; either version 3 of the License, or (at your option)\n * any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for\n * more details.\n *\n * You should have received a copy of the GNU General Public License along\n * with this program; if not, write to the Free Software Foundation, Inc.,\n * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA\n */\n\n/**\n * <cv-backend> Custom element to define a backend connection\n */\nqx.Class.define('cv.ui.structure.tile.elements.Backend', {\n  extend: cv.ui.structure.tile.elements.AbstractCustomElement,\n\n  /*\n  ***********************************************\n    MEMBERS\n  ***********************************************\n  */\n  members: {\n    _name: null,\n    __applyValues: null,\n\n    _init() {\n      const element = this._element;\n      const type = element.getAttribute('type');\n      const uriString = element.hasAttribute('uri') ? element.getAttribute('uri') : '';\n      let uri;\n      if (uriString) {\n        try {\n          uri = new URL(uriString, window.location.origin + window.location.pathname);\n        } catch (e) {\n          this.error('Error parsing uri: ' + uriString);\n        }\n      }\n\n      if (type) {\n        let credentials = null;\n        if (element.hasAttribute('username')) {\n          credentials = {\n            username: element.getAttribute('username'),\n            password: element.getAttribute('password') || ''\n          };\n        } else if (uri && uri.username) {\n          credentials = {\n            username: uri.username,\n            password: uri.password\n          };\n        }\n        const model = cv.data.Model.getInstance();\n        let backendUrl = uri ? uri.toString() : null;\n        let backendUrlConfigKey;\n        switch (type) {\n          case 'knxd':\n            backendUrlConfigKey = 'backendKnxdUrl';\n            break;\n          case 'openhab':\n            backendUrlConfigKey = 'backendOpenHABUrl';\n            break;\n          case 'mqtt':\n            backendUrlConfigKey = 'backendMQTTUrl';\n            break;\n        }\n\n        if (backendUrlConfigKey) {\n          // override by URL settings\n          if (cv.Config.URL[backendUrlConfigKey]) {\n            backendUrl = cv.Config.URL[backendUrlConfigKey];\n          } else if (!backendUrl && cv.Config.server[backendUrlConfigKey]) {\n            backendUrl = cv.Config.server[backendUrlConfigKey];\n          }\n        }\n        let name = type;\n        if (element.hasAttribute('name')) {\n          name = element.getAttribute('name');\n        } else if (!cv.io.BackendConnections.hasClient('main')) {\n          // we need one main backend\n          name = 'main';\n        } else if (cv.io.BackendConnections.getClient('main').configuredIn === 'config') {\n          qx.log.Logger.warn(\n            this,\n            `there is already a backend registered with name \"main\" and type ${type} skipping this one`\n          );\n\n          return;\n        }\n        qx.log.Logger.debug(this, 'init backend', name);\n        if (cv.io.BackendConnections.hasClient(name)) {\n          const notification = {\n            topic: 'cv.config.error',\n            title: qx.locale.Manager.tr('Config error'),\n            message: qx.locale.Manager.tr('There already exists a backend named: \"%1\"', name),\n\n            severity: 'urgent',\n            unique: true,\n            deletable: true\n          };\n\n          cv.core.notifications.Router.dispatchMessage(notification.topic, notification);\n\n          return;\n        }\n        const client = cv.io.BackendConnections.addBackendClient(name, type, backendUrl, 'config');\n\n        this._client = client;\n        this._name = name;\n        this.__applyValues = [];\n        client.update = data => model.updateFrom(name, data); // override clients update function\n\n        for (const data of element.querySelectorAll(':scope > cv-resource')) {\n          client.setResourcePath(data.getAttribute('name'), data.textContent.trim());\n        }\n\n        client.login(true, credentials, () => {\n          this.debug(name, 'connected');\n          if (element.hasAttribute('default') && element.getAttribute('default') === 'true') {\n            model.setDefaultBackendName(name);\n          }\n          const doSubscribe = () => {\n            for (const [address, value] of this.__applyValues) {\n              this.debug(name, 'apply update', address, value);\n              model.onUpdate(address, value, name);\n            }\n            const addressesToSubscribe = model.getAddresses(name);\n            this.debug(name, 'subscribing to', addressesToSubscribe.length, 'addresses');\n\n            if (addressesToSubscribe.length !== 0) {\n              client.subscribe(addressesToSubscribe);\n            }\n          };\n          if (cv.TemplateEngine.getInstance().isDomFinished()) {\n            doSubscribe();\n          } else {\n            qx.event.message.Bus.subscribe(\n              'setup.dom.finished',\n              function () {\n                doSubscribe();\n              },\n              this\n            );\n          }\n        });\n      } else {\n        this.error('<cv-backend> must have a type attribute');\n      }\n    },\n\n    _disconnected() {\n      if (this._client) {\n        const model = cv.data.Model.getInstance();\n        if (this._element.hasAttribute('default') && this._element.getAttribute('default') === 'true') {\n          model.resetDefaultBackendName();\n        }\n        this._client.terminate();\n        cv.io.BackendConnections.removeClient(this._client);\n        this._client.dispose();\n        this._client = null;\n      }\n    }\n  },\n\n  defer(Clazz) {\n    customElements.define(\n      cv.ui.structure.tile.Controller.PREFIX + 'backend',\n      class extends QxConnector {\n        constructor() {\n          super(Clazz);\n        }\n      }\n    );\n  }\n});\n"
  ],
  "mappings": "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"
}