{
  "version": 3,
  "names": [
    "qx",
    "Bootstrap",
    "executePendingDefers",
    "$$dbClassInfo",
    "Mixin",
    "define",
    "construct",
    "cv",
    "TemplateEngine",
    "getInstance",
    "isDomFinished",
    "setupRefreshAction",
    "event",
    "message",
    "Bus",
    "subscribe",
    "addListener",
    "_maintainTimerState",
    "properties",
    "refresh",
    "check",
    "init",
    "cachecontrol",
    "restartOnVisible",
    "apply",
    "members",
    "_timer",
    "__timerId",
    "__setup",
    "__lastRun",
    "__restartTimer",
    "__restartOnVisible",
    "_applyRestartOnVisible",
    "value",
    "debug",
    "getPath",
    "stop",
    "dispose",
    "isRestartOnVisible",
    "isVisible",
    "delta",
    "getRefresh",
    "Date",
    "now",
    "start",
    "fireEvent",
    "Timer",
    "once",
    "isEnabled",
    "_this",
    "_setupRefreshAction",
    "element",
    "getDomElement",
    "target",
    "querySelector",
    "src",
    "getAttribute",
    "indexOf",
    "nodeName",
    "getCachecontrol",
    "refreshAction",
    "setRestartOnVisible",
    "_refreshAction",
    "parenthost",
    "window",
    "location",
    "protocol",
    "host",
    "setAttribute",
    "util",
    "Uri",
    "appendParamsToUrl",
    "getTime",
    "ui",
    "common",
    "Refresh",
    "__forceImgReload",
    "destruct",
    "_disposeObjects",
    "statics",
    "fetch",
    "cache",
    "mode",
    "then",
    "document",
    "body",
    "querySelectorAll",
    "concat",
    "forEach",
    "img"
  ],
  "sources": [
    "/home/runner/work/CometVisu/CometVisu/source/class/cv/ui/common/Refresh.js"
  ],
  "sourcesContent": [
    "/* Refresh.js\n *\n * copyright (c) 2010-2022, Christian Mayer and the CometVisu contributers.\n *\n * This program is free software; you can redistribute it and/or modify it\n * under the terms of the GNU General Public License as published by the Free\n * Software Foundation; either version 3 of the License, or (at your option)\n * any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for\n * more details.\n *\n * You should have received a copy of the GNU General Public License along\n * with this program; if not, write to the Free Software Foundation, Inc.,\n * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA\n */\n\n/**\n * @ignore(fetch)\n */\nqx.Mixin.define('cv.ui.common.Refresh', {\n  /*\n   ******************************************************\n   CONSTRUCTOR\n   ******************************************************\n   */\n  construct() {\n    if (cv.TemplateEngine.getInstance().isDomFinished()) {\n      this.setupRefreshAction();\n    } else {\n      qx.event.message.Bus.subscribe(\n        'setup.dom.finished',\n        function () {\n          this.setupRefreshAction();\n        },\n        this\n      );\n    }\n\n    this.addListener('changeVisible', this._maintainTimerState, this);\n  },\n\n  /*\n   ******************************************************\n   PROPERTIES\n   ******************************************************\n   */\n  properties: {\n    refresh: {\n      check: 'Number',\n      init: 0\n    },\n\n    cachecontrol: {\n      check: 'String',\n      init: 'full'\n    },\n\n    restartOnVisible: {\n      check: 'Boolean',\n      init: false,\n      apply: '_applyRestartOnVisible'\n    }\n  },\n\n  /*\n   ******************************************************\n   MEMBERS\n   ******************************************************\n   */\n  members: {\n    _timer: null,\n    __timerId: null,\n    __setup: false,\n    __lastRun: null,\n    __restartTimer: null,\n    __restartOnVisible: false,\n\n    _applyRestartOnVisible(value) {\n      if (value) {\n        this._maintainTimerState();\n      }\n    },\n\n    /**\n     * Stop the while invisible\n     */\n    _maintainTimerState() {\n      if (this.__restartTimer) {\n        this.debug('aborting restart timer ' + this.getPath());\n        this.__restartTimer.stop();\n        this.__restartTimer.dispose();\n        this.__restartTimer = null;\n      }\n      if (!this.isRestartOnVisible()) {\n        return;\n      }\n      if (this._timer) {\n        if (this.isVisible()) {\n          const delta = this.getRefresh() - (Date.now() - this.__lastRun);\n          if (delta <= 0) {\n            // run immediately\n            this.debug('immediate refresh because refresh time has been reached ' + this.getPath());\n\n            this._timer.start();\n            this._timer.fireEvent('interval');\n          } else {\n            this.debug('starting refresh ' + this.getPath() + ' in ' + delta + 'ms');\n\n            // start when interval is finished\n            this.__restartTimer = qx.event.Timer.once(\n              function () {\n                this._timer.start();\n                this._timer.fireEvent('interval');\n                this.__restartTimer = null;\n              },\n              this,\n              delta\n            );\n          }\n        } else if (this._timer.isEnabled()) {\n          this.debug('stop refreshing ' + this.getPath());\n          this._timer.stop();\n        }\n      }\n    },\n\n    setupRefreshAction() {\n      if (this.getRefresh() && this.getRefresh() > 0) {\n        if (this.__setup === true) {\n          return;\n        }\n        this.__setup = true;\n        if (this._setupRefreshAction) {\n          // overridden by inheriting class\n          this._setupRefreshAction();\n          if (this._timer) {\n            // listen to foreign timer to get the last execution time;\n            this._timer.addListener('interval', () => {\n              this.__lastRun = Date.now();\n            });\n          }\n        } else if (!this._timer || !this._timer.isEnabled()) {\n          const element = this.getDomElement();\n          const target = element.querySelector('img') || element.querySelector('iframe');\n          let src = target.getAttribute('src');\n          if (\n            src.indexOf('?') < 0 &&\n            ((target.nodeName === 'IMG' && this.getCachecontrol() === 'full') || target.nodeName !== 'IMG')\n          ) {\n            src += '?';\n          }\n          this._timer = new qx.event.Timer(this.getRefresh());\n          this._timer.addListener('interval', () => {\n            this.refreshAction(target, src);\n          });\n          this._timer.start();\n        }\n        if (this._timer && this._timer.isEnabled()) {\n          this.__lastRun = Date.now();\n          this.setRestartOnVisible(true);\n        }\n      }\n    },\n\n    refreshAction(target, src) {\n      this.__lastRun = Date.now();\n      if (this._refreshAction) {\n        this._refreshAction();\n      } else {\n        /*\n         * Special treatment for (external) iframes: we need to clear it and reload\n         * it in another thread as otherwise stays blank for some targets/sites and\n         * src = src doesnt work anyway on external This creates though some\n         * \"flickering\" so we avoid to use it on images, internal iframes and others\n         */\n        const parenthost = window.location.protocol + '//' + window.location.host;\n        if (target.nodeName === 'IFRAME' && src.indexOf(parenthost) !== 0) {\n          target.setAttribute('src', '');\n          qx.event.Timer.once(\n            function () {\n              target.setAttribute('src', src);\n            },\n            this,\n            0\n          );\n        } else {\n          let cachecontrol = this.getCachecontrol();\n\n          // force is only implied for images\n          if (target.nodeName !== 'IMG' && cachecontrol === 'force') {\n            cachecontrol = 'full';\n          }\n\n          switch (cachecontrol) {\n            case 'full':\n              target.setAttribute('src', qx.util.Uri.appendParamsToUrl(src, '' + new Date().getTime()));\n\n              break;\n\n            case 'weak':\n              target.setAttribute('src', src + '#' + new Date().getTime());\n              break;\n\n            case 'force':\n              cv.ui.common.Refresh.__forceImgReload(src);\n\n            // not needed as those are NOP:\n            // case 'none':\n            // default:\n          }\n        }\n      }\n    }\n  },\n\n  /*\n  ******************************************************\n    DESTRUCTOR\n  ******************************************************\n  */\n  destruct() {\n    if (this._timer) {\n      this._timer.stop();\n      this._disposeObjects('_timer');\n    }\n  },\n\n  /*\n   ******************************************************\n   STATICS\n   ******************************************************\n   */\n  statics: {\n    // based on https://stackoverflow.com/questions/1077041/refresh-image-with-a-new-one-at-the-same-url\n    __forceImgReload(src) {\n      window\n        .fetch(src, { cache: 'reload', mode: 'no-cors' })\n        .then(() => document.body.querySelectorAll(`img[src='${src}']`).forEach(img => (img.src = src)));\n    }\n  }\n});\n"
  ],
  "mappings": "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",
  "ignoreList": []
}