{
  "version": 3,
  "names": [
    "qx",
    "Bootstrap",
    "executePendingDefers",
    "$$dbClassInfo",
    "Class",
    "define",
    "extend",
    "cv",
    "io",
    "timeseries",
    "AbstractTimeSeriesSource",
    "members",
    "_backendUrl",
    "_baseRequestConfig",
    "_queryTemplate",
    "_isInline",
    "isInline",
    "_init",
    "config",
    "getConfig",
    "bucket",
    "name",
    "options",
    "method",
    "searchParams",
    "org",
    "authority",
    "parts",
    "path",
    "substring",
    "split",
    "measurement",
    "shift",
    "field",
    "queryParts",
    "concat",
    "additional",
    "allowedAg",
    "key",
    "params",
    "startsWith",
    "includes",
    "Object",
    "prototype",
    "hasOwnProperty",
    "call",
    "aggregateWindow",
    "error",
    "push",
    "join",
    "url",
    "_url",
    "proxy",
    "setQueryTemplate",
    "template",
    "_getAgWindowEveryForSeries",
    "series",
    "getRequestConfig",
    "start",
    "end",
    "assign",
    "timeRange",
    "getTimeRange",
    "range",
    "toISOString",
    "encodeURIComponent",
    "requestData",
    "replace",
    "ConfigCache",
    "hashCode",
    "processResponse",
    "response",
    "lines",
    "trim",
    "fields",
    "res",
    "timeIndex",
    "indexOf",
    "valueIndex",
    "log",
    "Logger",
    "value",
    "lineEntries",
    "date",
    "_iterator",
    "_createForOfIteratorHelper",
    "_step",
    "s",
    "n",
    "done",
    "line",
    "parseFloat",
    "isNaN",
    "Date",
    "getTime",
    "err",
    "e",
    "f",
    "FluxSource"
  ],
  "sources": [
    "/home/runner/work/CometVisu/CometVisu/source/class/cv/io/timeseries/FluxSource.js"
  ],
  "sourcesContent": [
    "/*\n * Copyright (c) 2023, Christian Mayer and the CometVisu contributors.\n *\n * This program is free software; you can redistribute it and/or modify it\n * under the terms of the GNU General Public License as published by the Free\n * Software Foundation; either version 3 of the License, or (at your option)\n * any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for\n * more details.\n *\n * You should have received a copy of the GNU General Public License along\n * with this program; if not, write to the Free Software Foundation, Inc.,\n * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA\n *\n */\n/**\n * Handle queries to an InfluxDB over the flux API\n */\nqx.Class.define('cv.io.timeseries.FluxSource', {\n  extend: cv.io.timeseries.AbstractTimeSeriesSource,\n\n  /*\n  ***********************************************\n    MEMBERS\n  ***********************************************\n  */\n  members: {\n    _backendUrl: null,\n    _baseRequestConfig: null,\n    _queryTemplate: null,\n    _isInline: null,\n\n    isInline() {\n      return this._isInline;\n    },\n\n    _init() {\n      const config = this.getConfig();\n      if (config) {\n        const bucket = config.name;\n        const options = {\n          method: 'POST',\n          'config-section': 'influx',\n          searchParams: {\n            org: config.authority\n          }\n        };\n        // for inline bucket the query template is defined in the config and is provided externally\n        if (bucket !== 'inline') {\n          const parts = config.path.substring(1).split('/');\n          const measurement = parts.shift();\n          const field = parts.shift() || 'value';\n          const queryParts = [\n            `from(bucket:\"${bucket}\")`,\n            '|> range($$RANGE$$)',\n            `|> filter(fn: (r) => r._measurement == \"${measurement}\" and r._field == \"${field}\")`\n          ];\n          const additional = {};\n          const allowedAg = ['fn', 'every', 'column', 'createEmpty', 'location', 'offset', 'period', 'timeDst', 'timeSrc'];\n          for (const key in config.params) {\n            if (key.startsWith('ag-')) {\n              if (allowedAg.includes(key.substring(3))) {\n                if (!Object.prototype.hasOwnProperty.call(additional, 'aggregateWindow')) {\n                  additional.aggregateWindow = {};\n                }\n                additional.aggregateWindow[key.substring(3)] = config.params[key];\n              } else {\n                this.error(`skipping invalid aggregationWindow parameter ${key.substring(3)}`);\n              }\n            }\n          }\n          if (Object.prototype.hasOwnProperty.call(additional, 'aggregateWindow')) {\n            if (Object.prototype.hasOwnProperty.call(additional.aggregateWindow, 'every')) {\n              let parts = [];\n              for (const key in additional.aggregateWindow) {\n                parts.push(`${key}: ${additional.aggregateWindow[key]}`);\n              }\n              // use default\n              if (!Object.prototype.hasOwnProperty.call(additional.aggregateWindow, 'fn')) {\n                parts.push('fn: mean');\n              }\n              queryParts.push(`|> aggregateWindow(${parts.join(', ')})`);\n            } else {\n              this.error('aggregateWindow is missing \"every\" and/or \"fn\" parameter -> skipped.');\n            }\n          }\n\n          this._queryTemplate = queryParts.join('\\n  ');\n        } else {\n          this._isInline = true;\n        }\n        this._baseRequestConfig = {\n          url: this._url,\n          proxy: true,\n          options: options\n        };\n      } else {\n        this._baseRequestConfig = {\n          url: '',\n          proxy: false,\n          options: {}\n        };\n      }\n    },\n\n    setQueryTemplate(template) {\n      this._queryTemplate = template;\n    },\n\n    _getAgWindowEveryForSeries(series) {\n      switch (series) {\n        case 'hour':\n          return '1m';\n        case 'day':\n          return '1h';\n        case 'week':\n          return '6h';\n        case 'month':\n          return '1d';\n        case 'year':\n          return '1mo';\n        default:\n          return '1d';\n      }\n    },\n\n    getRequestConfig(start, end, series) {\n      const config = Object.assign({}, this._baseRequestConfig);\n      const timeRange = this.getTimeRange(start, end);\n      let range = 'start: -1d';\n      if (timeRange.start) {\n        range = `start: ${timeRange.start.toISOString().split('.')[0]+'Z'}, stop: ${timeRange.end.toISOString().split('.')[0]+'Z'}`;\n      }\n      // add time range to the resource url to make the request cache work\n      config.url += `&range=${encodeURIComponent(range)}`;\n      config.options.requestData = this._queryTemplate.replace('$$RANGE$$', range);\n      if (!config.options.requestData.includes('aggregateWindow')) {\n        // get aggregation from series\n        config.options.requestData += `\\n  |> aggregateWindow(every: ${this._getAgWindowEveryForSeries(series)}, fn: mean)`;\n      }\n      config.url += `&h=${cv.ConfigCache.hashCode(config.options.requestData)}`;\n      return config;\n    },\n\n    /**\n     * Converts response from openHAB persistence service\n     * @param response {String}\n     * @returns {(number|number)[][]|*[]}\n     */\n    processResponse(response) {\n      const lines = response.replace(/\\r/g, '').trim().split('\\n');\n      let fields = lines.shift().split(',');\n      const res = [];\n      const timeIndex = fields.indexOf('_time');\n      const valueIndex = fields.indexOf('_value');\n      if (timeIndex < 0 || valueIndex < 0) {\n        qx.log.Logger.error(this, 'missing _time or _value field in flux response: ' + fields.join(','));\n        return res;\n      }\n      let value;\n      let lineEntries;\n      let date;\n      for (let line of lines) {\n        lineEntries = line.split(',');\n        if (lineEntries[valueIndex]) {\n          value = parseFloat(lineEntries[valueIndex]);\n          if (isNaN(value)) {\n            value = 0;\n          }\n          date = new Date(lineEntries[timeIndex]);\n          res.push([date.getTime(), value]);\n        }\n      }\n      return res;\n    }\n  }\n});\n"
  ],
  "mappings": "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",
  "ignoreList": []
}