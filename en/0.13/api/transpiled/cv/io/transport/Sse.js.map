{
  "version": 3,
  "names": [
    "qx",
    "Bootstrap",
    "executePendingDefers",
    "$$dbClassInfo",
    "Class",
    "define",
    "extend",
    "core",
    "Object",
    "construct",
    "client",
    "__additionalTopics",
    "members",
    "running",
    "sessionId",
    "eventSource",
    "handleSession",
    "args",
    "connect",
    "json",
    "getResponse",
    "s",
    "version",
    "v",
    "split",
    "parseInt",
    "error",
    "setDataReceived",
    "EventSource",
    "util",
    "Uri",
    "appendParamsToUrl",
    "getResourcePath",
    "buildRequest",
    "addEventListener",
    "handleMessage",
    "bind",
    "handleError",
    "getOwnPropertyNames",
    "forEach",
    "__addRecordedEventListener",
    "onerror",
    "setConnected",
    "onopen",
    "debug",
    "e",
    "record",
    "data",
    "JSON",
    "parse",
    "d",
    "update",
    "dispatchTopicMessage",
    "topic",
    "message",
    "entry",
    "call",
    "subscribe",
    "callback",
    "context",
    "push",
    "isConnectionRunning",
    "readyState",
    "CLOSED",
    "OPEN",
    "restart",
    "doFullReload",
    "abort",
    "close",
    "cv",
    "io",
    "transport",
    "Sse"
  ],
  "sources": [
    "/home/runner/work/CometVisu/CometVisu/client/source/class/cv/io/transport/Sse.js"
  ],
  "sourcesContent": [
    "/* Sse.js\n *\n * copyright (c) 2010-2016, Christian Mayer and the CometVisu contributers.\n *\n * This program is free software; you can redistribute it and/or modify it\n * under the terms of the GNU General Public License as published by the Free\n * Software Foundation; either version 3 of the License, or (at your option)\n * any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for\n * more details.\n *\n * You should have received a copy of the GNU General Public License along\n * with this program; if not, write to the Free Software Foundation, Inc.,\n * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA\n */\n\n/**\n * @ignore(EventSource)\n */\nqx.Class.define('cv.io.transport.Sse', {\n  extend: qx.core.Object,\n\n  /*\n   ******************************************************\n   CONSTRUCTOR\n   ******************************************************\n   */\n  /**\n   *\n   * @param client {cv.io.Client}\n   */\n  construct(client) {\n    this.client = client;\n    this.__additionalTopics = {};\n  },\n\n  /*\n   ******************************************************\n   MEMBERS\n   ******************************************************\n   */\n  members: {\n    running: false,\n    sessionId: null,\n    client: null,\n    eventSource: null,\n    __additionalTopics: null,\n    /**\n     * This function gets called once the communication is established\n     * and session information is available\n     *\n     * @param args {Array} arguments from the XHR response callback\n     * @param connect {Boolean} whether to start the connection or not\n     */\n    handleSession(args, connect) {\n      var json = this.client.getResponse(args);\n      this.sessionId = json.s;\n      this.version = json.v.split('.', 3);\n\n      if (parseInt(this.version[0]) > 0 || parseInt(this.version[1]) > 1) {\n        this.error('ERROR CometVisu Client: too new protocol version (' + json.v + ') used!');\n      }\n      if (connect) {\n        this.connect();\n      }\n    },\n\n    /**\n     * Establish the SSE connection\n     */\n    connect() {\n      // send first request\n      this.running = true;\n      this.client.setDataReceived(false);\n      this.eventSource = new EventSource(\n        qx.util.Uri.appendParamsToUrl(this.client.getResourcePath('read'), this.client.buildRequest(null, true))\n      );\n\n      // add default listeners\n      this.eventSource.addEventListener('message', this.handleMessage.bind(this), false);\n\n      this.eventSource.addEventListener('error', this.handleError.bind(this), false);\n\n      // add additional listeners\n      Object.getOwnPropertyNames(this.__additionalTopics).forEach(this.__addRecordedEventListener, this);\n\n      this.eventSource.onerror = function () {\n        this.error('connection lost');\n        this.client.setConnected(false);\n      }.bind(this);\n      this.eventSource.onopen = function () {\n        this.debug('connection established');\n        this.client.setConnected(true);\n      }.bind(this);\n    },\n\n    /**\n     * Handle messages send from server as Server-Sent-Event\n     * @param e\n     */\n    handleMessage(e) {\n      this.client.record('read', e.data);\n      var json = JSON.parse(e.data);\n      var data = json.d;\n      this.client.update(data);\n      this.client.setDataReceived(true);\n    },\n\n    dispatchTopicMessage(topic, message) {\n      this.client.record(topic, message);\n      if (this.__additionalTopics[topic]) {\n        this.__additionalTopics[topic].forEach(function (entry) {\n          entry[0].call(entry[1], message);\n        });\n      }\n    },\n\n    /**\n     * Subscribe to SSE events of a certain topic\n     * @param topic {String}\n     * @param callback {Function}\n     * @param context {Object}\n     */\n    subscribe(topic, callback, context) {\n      if (!this.__additionalTopics[topic]) {\n        this.__additionalTopics[topic] = [];\n      }\n      this.__additionalTopics[topic].push([callback, context]);\n      if (this.isConnectionRunning()) {\n        this.__addRecordedEventListener(topic);\n      }\n    },\n\n    __addRecordedEventListener(topic) {\n      this.debug('subscribing to topic ' + topic);\n      this.eventSource.addEventListener(\n        topic,\n        function (e) {\n          this.dispatchTopicMessage(topic, e);\n        }.bind(this),\n        false\n      );\n    },\n\n    /**\n     * Handle errors\n     * @param e\n     */\n    handleError(e) {\n      if (e.readyState === EventSource.CLOSED) {\n        // Connection was closed.\n        this.running = false;\n        // reconnect\n        this.connect();\n      }\n    },\n\n    /**\n     * Check if the connection is still running.\n     *\n     * @return {Boolean}\n     */\n    isConnectionRunning() {\n      return this.eventSource && this.eventSource.readyState === EventSource.OPEN;\n    },\n\n    /**\n     * Restart the read request\n     * @param doFullReload\n     */\n    restart(doFullReload) {\n      if (doFullReload || this.eventSource.readyState === EventSource.CLOSED) {\n        this.abort();\n        this.connect();\n      }\n    },\n\n    /**\n     * Abort the read request properly\n     *\n     *\n     */\n    abort() {\n      if (this.isConnectionRunning() === true) {\n        this.eventSource.close();\n      }\n    }\n  }\n});\n"
  ],
  "mappings": ";;;;;;;;;;;;;EAAAA,EAAE,CAACC,SAAH,CAAaC,oBAAb,CAAkCC,aAAlC;;EAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;EAEA;AACA;AACA;EACAH,EAAE,CAACI,KAAH,CAASC,MAAT,CAAgB,qBAAhB,EAAuC;IACrCC,MAAM,EAAEN,EAAE,CAACO,IAAH,CAAQC,MADqB;;IAGrC;AACF;AACA;AACA;AACA;;IACE;AACF;AACA;AACA;IACEC,SAZqC,qBAY3BC,MAZ2B,EAYnB;MAChB,KAAKA,MAAL,GAAcA,MAAd;MACA,KAAKC,SAAL,GAA0B,EAA1B;IACD,CAfoC;;IAiBrC;AACF;AACA;AACA;AACA;IACEC,OAAO,EAAE;MACPC,OAAO,EAAE,KADF;MAEPC,SAAS,EAAE,IAFJ;MAGPJ,MAAM,EAAE,IAHD;MAIPK,WAAW,EAAE,IAJN;MAKPJ,SAAkB,EAAE,IALb;;MAMP;AACJ;AACA;AACA;AACA;AACA;AACA;MACIK,aAbO,yBAaOC,IAbP,EAaaC,OAbb,EAasB;QAC3B,IAAIC,IAAI,GAAG,KAAKT,MAAL,CAAYU,WAAZ,CAAwBH,IAAxB,CAAX;QACA,KAAKH,SAAL,GAAiBK,IAAI,CAACE,CAAtB;QACA,KAAKC,OAAL,GAAeH,IAAI,CAACI,CAAL,CAAOC,KAAP,CAAa,GAAb,EAAkB,CAAlB,CAAf;;QAEA,IAAIC,QAAQ,CAAC,KAAKH,OAAL,CAAa,CAAb,CAAD,CAAR,GAA4B,CAA5B,IAAiCG,QAAQ,CAAC,KAAKH,OAAL,CAAa,CAAb,CAAD,CAAR,GAA4B,CAAjE,EAAoE;UAClE,KAAKI,KAAL,CAAW,uDAAuDP,IAAI,CAACI,CAA5D,GAAgE,SAA3E;QACD;;QACD,IAAIL,OAAJ,EAAa;UACX,KAAKA,OAAL;QACD;MACF,CAxBM;;MA0BP;AACJ;AACA;MACIA,OA7BO,qBA6BG;QACR;QACA,KAAKL,OAAL,GAAe,IAAf;QACA,KAAKH,MAAL,CAAYiB,eAAZ,CAA4B,KAA5B;QACA,KAAKZ,WAAL,GAAmB,IAAIa,WAAJ,CACjB5B,EAAE,CAAC6B,IAAH,CAAQC,GAAR,CAAYC,iBAAZ,CAA8B,KAAKrB,MAAL,CAAYsB,eAAZ,CAA4B,MAA5B,CAA9B,EAAmE,KAAKtB,MAAL,CAAYuB,YAAZ,CAAyB,IAAzB,EAA+B,IAA/B,CAAnE,CADiB,CAAnB,CAJQ,CAQR;;QACA,KAAKlB,WAAL,CAAiBmB,gBAAjB,CAAkC,SAAlC,EAA6C,KAAKC,aAAL,CAAmBC,IAAnB,CAAwB,IAAxB,CAA7C,EAA4E,KAA5E;QAEA,KAAKrB,WAAL,CAAiBmB,gBAAjB,CAAkC,OAAlC,EAA2C,KAAKG,WAAL,CAAiBD,IAAjB,CAAsB,IAAtB,CAA3C,EAAwE,KAAxE,EAXQ,CAaR;;QACA5B,MAAM,CAAC8B,mBAAP,CAA2B,KAAK3B,SAAhC,EAAoD4B,OAApD,CAA4D,KAAKC,SAAjE,EAA6F,IAA7F;;QAEA,KAAKzB,WAAL,CAAiB0B,OAAjB,GAA2B,YAAY;UACrC,KAAKf,KAAL,CAAW,iBAAX;UACA,KAAKhB,MAAL,CAAYgC,YAAZ,CAAyB,KAAzB;QACD,CAH0B,CAGzBN,IAHyB,CAGpB,IAHoB,CAA3B;;QAIA,KAAKrB,WAAL,CAAiB4B,MAAjB,GAA0B,YAAY;UACpC,KAAKC,KAAL,CAAW,wBAAX;UACA,KAAKlC,MAAL,CAAYgC,YAAZ,CAAyB,IAAzB;QACD,CAHyB,CAGxBN,IAHwB,CAGnB,IAHmB,CAA1B;MAID,CArDM;;MAuDP;AACJ;AACA;AACA;MACID,aA3DO,yBA2DOU,CA3DP,EA2DU;QACf,KAAKnC,MAAL,CAAYoC,MAAZ,CAAmB,MAAnB,EAA2BD,CAAC,CAACE,IAA7B;QACA,IAAI5B,IAAI,GAAG6B,IAAI,CAACC,KAAL,CAAWJ,CAAC,CAACE,IAAb,CAAX;QACA,IAAIA,IAAI,GAAG5B,IAAI,CAAC+B,CAAhB;QACA,KAAKxC,MAAL,CAAYyC,MAAZ,CAAmBJ,IAAnB;QACA,KAAKrC,MAAL,CAAYiB,eAAZ,CAA4B,IAA5B;MACD,CAjEM;MAmEPyB,oBAnEO,gCAmEcC,KAnEd,EAmEqBC,OAnErB,EAmE8B;QACnC,KAAK5C,MAAL,CAAYoC,MAAZ,CAAmBO,KAAnB,EAA0BC,OAA1B;;QACA,IAAI,KAAK3C,SAAL,CAAwB0C,KAAxB,CAAJ,EAAoC;UAClC,KAAK1C,SAAL,CAAwB0C,KAAxB,EAA+Bd,OAA/B,CAAuC,UAAUgB,KAAV,EAAiB;YACtDA,KAAK,CAAC,CAAD,CAAL,CAASC,IAAT,CAAcD,KAAK,CAAC,CAAD,CAAnB,EAAwBD,OAAxB;UACD,CAFD;QAGD;MACF,CA1EM;;MA4EP;AACJ;AACA;AACA;AACA;AACA;MACIG,SAlFO,qBAkFGJ,KAlFH,EAkFUK,QAlFV,EAkFoBC,OAlFpB,EAkF6B;QAClC,IAAI,CAAC,KAAKhD,SAAL,CAAwB0C,KAAxB,CAAL,EAAqC;UACnC,KAAK1C,SAAL,CAAwB0C,KAAxB,IAAiC,EAAjC;QACD;;QACD,KAAK1C,SAAL,CAAwB0C,KAAxB,EAA+BO,IAA/B,CAAoC,CAACF,QAAD,EAAWC,OAAX,CAApC;;QACA,IAAI,KAAKE,mBAAL,EAAJ,EAAgC;UAC9B,KAAKrB,SAAL,CAAgCa,KAAhC;QACD;MACF,CA1FM;MA4FPb,SA5FO,qBA4FoBa,KA5FpB,EA4F2B;QAChC,KAAKT,KAAL,CAAW,0BAA0BS,KAArC;QACA,KAAKtC,WAAL,CAAiBmB,gBAAjB,CACEmB,KADF,EAEE,UAAUR,CAAV,EAAa;UACX,KAAKO,oBAAL,CAA0BC,KAA1B,EAAiCR,CAAjC;QACD,CAFD,CAEET,IAFF,CAEO,IAFP,CAFF,EAKE,KALF;MAOD,CArGM;;MAuGP;AACJ;AACA;AACA;MACIC,WA3GO,uBA2GKQ,CA3GL,EA2GQ;QACb,IAAIA,CAAC,CAACiB,UAAF,KAAiBlC,WAAW,CAACmC,MAAjC,EAAyC;UACvC;UACA,KAAKlD,OAAL,GAAe,KAAf,CAFuC,CAGvC;;UACA,KAAKK,OAAL;QACD;MACF,CAlHM;;MAoHP;AACJ;AACA;AACA;AACA;MACI2C,mBAzHO,iCAyHe;QACpB,OAAO,KAAK9C,WAAL,IAAoB,KAAKA,WAAL,CAAiB+C,UAAjB,KAAgClC,WAAW,CAACoC,IAAvE;MACD,CA3HM;;MA6HP;AACJ;AACA;AACA;MACIC,OAjIO,mBAiICC,YAjID,EAiIe;QACpB,IAAIA,YAAY,IAAI,KAAKnD,WAAL,CAAiB+C,UAAjB,KAAgClC,WAAW,CAACmC,MAAhE,EAAwE;UACtE,KAAKI,KAAL;UACA,KAAKjD,OAAL;QACD;MACF,CAtIM;;MAwIP;AACJ;AACA;AACA;AACA;MACIiD,KA7IO,mBA6IC;QACN,IAAI,KAAKN,mBAAL,OAA+B,IAAnC,EAAyC;UACvC,KAAK9C,WAAL,CAAiBqD,KAAjB;QACD;MACF;IAjJM;EAtB4B,CAAvC;EAtBAC,EAAE,CAACC,EAAH,CAAMC,SAAN,CAAgBC,GAAhB,CAAoBrE,aAApB,GAAoCA,aAApC"
}