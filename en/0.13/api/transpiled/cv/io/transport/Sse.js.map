{
  "version": 3,
  "names": [
    "qx",
    "Bootstrap",
    "executePendingDefers",
    "$$dbClassInfo",
    "Class",
    "define",
    "extend",
    "core",
    "Object",
    "construct",
    "client",
    "__additionalTopics",
    "members",
    "running",
    "sessionId",
    "eventSource",
    "handleSession",
    "args",
    "connect",
    "json",
    "getResponse",
    "s",
    "version",
    "v",
    "split",
    "parseInt",
    "error",
    "setDataReceived",
    "EventSource",
    "util",
    "Uri",
    "appendParamsToUrl",
    "getResourcePath",
    "buildRequest",
    "addEventListener",
    "handleMessage",
    "bind",
    "handleError",
    "getOwnPropertyNames",
    "forEach",
    "__addRecordedEventListener",
    "onerror",
    "setConnected",
    "onopen",
    "debug",
    "e",
    "record",
    "data",
    "JSON",
    "parse",
    "d",
    "update",
    "dispatchTopicMessage",
    "topic",
    "message",
    "entry",
    "call",
    "subscribe",
    "callback",
    "context",
    "push",
    "isConnectionRunning",
    "__P_556_1",
    "readyState",
    "CLOSED",
    "OPEN",
    "restart",
    "doFullReload",
    "abort",
    "close",
    "cv",
    "io",
    "transport",
    "Sse"
  ],
  "sources": [
    "/home/runner/work/CometVisu/CometVisu/client/source/class/cv/io/transport/Sse.js"
  ],
  "sourcesContent": [
    "/* Sse.js\n *\n * copyright (c) 2010-2016, Christian Mayer and the CometVisu contributers.\n *\n * This program is free software; you can redistribute it and/or modify it\n * under the terms of the GNU General Public License as published by the Free\n * Software Foundation; either version 3 of the License, or (at your option)\n * any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for\n * more details.\n *\n * You should have received a copy of the GNU General Public License along\n * with this program; if not, write to the Free Software Foundation, Inc.,\n * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA\n */\n\n/**\n * @ignore(EventSource)\n */\nqx.Class.define('cv.io.transport.Sse', {\n  extend: qx.core.Object,\n\n  /*\n   ******************************************************\n   CONSTRUCTOR\n   ******************************************************\n   */\n  /**\n   *\n   * @param client {cv.io.Client}\n   */\n  construct(client) {\n    this.client = client;\n    this.__additionalTopics = {};\n  },\n\n  /*\n   ******************************************************\n   MEMBERS\n   ******************************************************\n   */\n  members: {\n    running: false,\n    sessionId: null,\n    client: null,\n    eventSource: null,\n    __additionalTopics: null,\n    /**\n     * This function gets called once the communication is established\n     * and session information is available\n     *\n     * @param args {Array} arguments from the XHR response callback\n     * @param connect {Boolean} whether to start the connection or not\n     */\n    handleSession(args, connect) {\n      var json = this.client.getResponse(args);\n      this.sessionId = json.s;\n      this.version = json.v.split('.', 3);\n\n      if (parseInt(this.version[0]) > 0 || parseInt(this.version[1]) > 1) {\n        this.error('ERROR CometVisu Client: too new protocol version (' + json.v + ') used!');\n      }\n      if (connect) {\n        this.connect();\n      }\n    },\n\n    /**\n     * Establish the SSE connection\n     */\n    connect() {\n      // send first request\n      this.running = true;\n      this.client.setDataReceived(false);\n      this.eventSource = new EventSource(\n        qx.util.Uri.appendParamsToUrl(this.client.getResourcePath('read'), this.client.buildRequest(null, true))\n      );\n\n      // add default listeners\n      this.eventSource.addEventListener('message', this.handleMessage.bind(this), false);\n\n      this.eventSource.addEventListener('error', this.handleError.bind(this), false);\n\n      // add additional listeners\n      Object.getOwnPropertyNames(this.__additionalTopics).forEach(this.__addRecordedEventListener, this);\n\n      this.eventSource.onerror = function () {\n        this.error('connection lost');\n        this.client.setConnected(false);\n      }.bind(this);\n      this.eventSource.onopen = function () {\n        this.debug('connection established');\n        this.client.setConnected(true);\n      }.bind(this);\n    },\n\n    /**\n     * Handle messages send from server as Server-Sent-Event\n     * @param e\n     */\n    handleMessage(e) {\n      this.client.record('read', e.data);\n      var json = JSON.parse(e.data);\n      var data = json.d;\n      this.client.update(data);\n      this.client.setDataReceived(true);\n    },\n\n    dispatchTopicMessage(topic, message) {\n      this.client.record(topic, message);\n      if (this.__additionalTopics[topic]) {\n        this.__additionalTopics[topic].forEach(function (entry) {\n          entry[0].call(entry[1], message);\n        });\n      }\n    },\n\n    /**\n     * Subscribe to SSE events of a certain topic\n     * @param topic {String}\n     * @param callback {Function}\n     * @param context {Object}\n     */\n    subscribe(topic, callback, context) {\n      if (!this.__additionalTopics[topic]) {\n        this.__additionalTopics[topic] = [];\n      }\n      this.__additionalTopics[topic].push([callback, context]);\n      if (this.isConnectionRunning()) {\n        this.__addRecordedEventListener(topic);\n      }\n    },\n\n    __addRecordedEventListener(topic) {\n      this.debug('subscribing to topic ' + topic);\n      this.eventSource.addEventListener(\n        topic,\n        function (e) {\n          this.dispatchTopicMessage(topic, e);\n        }.bind(this),\n        false\n      );\n    },\n\n    /**\n     * Handle errors\n     * @param e\n     */\n    handleError(e) {\n      if (e.readyState === EventSource.CLOSED) {\n        // Connection was closed.\n        this.running = false;\n        // reconnect\n        this.connect();\n      }\n    },\n\n    /**\n     * Check if the connection is still running.\n     *\n     * @return {Boolean}\n     */\n    isConnectionRunning() {\n      return this.eventSource && this.eventSource.readyState === EventSource.OPEN;\n    },\n\n    /**\n     * Restart the read request\n     * @param doFullReload\n     */\n    restart(doFullReload) {\n      if (doFullReload || this.eventSource.readyState === EventSource.CLOSED) {\n        this.abort();\n        this.connect();\n      }\n    },\n\n    /**\n     * Abort the read request properly\n     *\n     *\n     */\n    abort() {\n      if (this.isConnectionRunning() === true) {\n        this.eventSource.close();\n      }\n    }\n  }\n});\n"
  ],
  "mappings": "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"
}