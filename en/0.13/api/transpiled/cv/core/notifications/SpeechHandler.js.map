{
  "version": 3,
  "names": [
    "qx",
    "Bootstrap",
    "executePendingDefers",
    "$$dbClassInfo",
    "Class",
    "define",
    "extend",
    "core",
    "Object",
    "implement",
    "cv",
    "notifications",
    "IHandler",
    "type",
    "construct",
    "constructor",
    "call",
    "__lastSpeech",
    "members",
    "handleMessage",
    "message",
    "config",
    "text",
    "title",
    "skipInitial",
    "topic",
    "time",
    "Date",
    "now",
    "Router",
    "evaluateCondition",
    "length",
    "debug",
    "substring",
    "repeatTimeout",
    "Math",
    "round",
    "say",
    "language",
    "window",
    "speechSynthesis",
    "warn",
    "synth",
    "locale",
    "Manager",
    "getInstance",
    "getLocale",
    "utterThis",
    "SpeechSynthesisUtterance",
    "selectedVoice",
    "defaultVoice",
    "voices",
    "getVoices",
    "onvoiceschanged",
    "bind",
    "i",
    "l",
    "lang",
    "substr",
    "toLowerCase",
    "voice",
    "name",
    "speak",
    "SpeechHandler"
  ],
  "sources": [
    "/home/runner/work/CometVisu/CometVisu/source/class/cv/core/notifications/SpeechHandler.js"
  ],
  "sourcesContent": [
    "/* SpeechHandler.js\n *\n * copyright (c) 2010-2022, Christian Mayer and the CometVisu contributers.\n *\n * This program is free software; you can redistribute it and/or modify it\n * under the terms of the GNU General Public License as published by the Free\n * Software Foundation; either version 3 of the License, or (at your option)\n * any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for\n * more details.\n *\n * You should have received a copy of the GNU General Public License along\n * with this program; if not, write to the Free Software Foundation, Inc.,\n * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA\n */\n\n/**\n * SpeechHandler\n *\n * @author tobiasb\n * @since 2017\n *\n * @ignore(SpeechSynthesisUtterance)\n */\n\nqx.Class.define('cv.core.notifications.SpeechHandler', {\n  extend: qx.core.Object,\n  implement: cv.core.notifications.IHandler,\n  type: 'singleton',\n\n  /*\n  ******************************************************\n    CONSTRUCTOR\n  ******************************************************\n  */\n  construct() {\n    super();\n    this.__lastSpeech = {};\n  },\n\n  /*\n  ******************************************************\n    MEMBERS\n  ******************************************************\n  */\n  members: {\n    __lastSpeech: null,\n\n    handleMessage(message, config) {\n      let text = message.message || message.title;\n      if (config.skipInitial && !this.__lastSpeech[message.topic]) {\n        this.__lastSpeech[message.topic] = {\n          text: text,\n          time: Date.now()\n        };\n\n        return;\n      }\n      if (cv.core.notifications.Router.evaluateCondition(message)) {\n        if (!text || text.length === 0) {\n          // nothing to say\n          this.debug('no text to speech given');\n          return;\n        }\n\n        if (text.substring(0, 1) === '!') {\n          // override repeatTimeout, force saying this\n          text = text.substring(1);\n        } else if (config.repeatTimeout >= 0) {\n          // do not repeat (within timeout when this.repeatTimeout > 0)\n          if (\n            this.__lastSpeech[message.topic] &&\n            this.__lastSpeech[message.topic].text === text &&\n            (config.repeatTimeout === 0 ||\n              config.repeatTimeout >= Math.round((Date.now() - this.__lastSpeech[message.topic].time) / 1000))\n          ) {\n            // update time\n            this.__lastSpeech[message.topic].time = Date.now();\n            // do not repeat\n            this.debug('skipping TTS because of repetition ' + text);\n            return;\n          }\n        }\n\n        this.__lastSpeech[message.topic] = {\n          text: text,\n          time: Date.now()\n        };\n\n        this.say(text);\n      }\n    },\n\n    say(text, language) {\n      if (!window.speechSynthesis) {\n        this.warn(this, 'this browser does not support the Web Speech API');\n        return;\n      }\n      const synth = window.speechSynthesis;\n\n      if (!language) {\n        language = qx.locale.Manager.getInstance().getLocale();\n      }\n\n      // speak\n      const utterThis = new SpeechSynthesisUtterance(text);\n\n      let selectedVoice;\n      let defaultVoice;\n      const voices = synth.getVoices();\n      if (voices.length === 0) {\n        synth.onvoiceschanged = function () {\n          this.say(text, language);\n        }.bind(this);\n        return;\n      }\n      synth.onvoiceschanged = null;\n\n      let i = 0;\n      const l = voices.length;\n      for (; i < l; i++) {\n        if (language && voices[i].lang.substr(0, 2).toLowerCase() === language) {\n          selectedVoice = voices[i];\n        }\n        if (voices[i]['default']) {\n          defaultVoice = voices[i];\n        }\n      }\n      if (!selectedVoice) {\n        selectedVoice = defaultVoice;\n      }\n      utterThis.voice = selectedVoice;\n      this.debug('saying \\'' + text + '\\' in voice ' + selectedVoice.name);\n      synth.speak(utterThis);\n    }\n  }\n});\n"
  ],
  "mappings": "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"
}