{
  "version": 3,
  "names": [
    "qx",
    "Bootstrap",
    "executePendingDefers",
    "$$dbClassInfo",
    "Class",
    "define",
    "extend",
    "core",
    "Object",
    "implement",
    "cv",
    "notifications",
    "IHandler",
    "type",
    "construct",
    "__lastSpeech",
    "members",
    "handleMessage",
    "message",
    "config",
    "text",
    "title",
    "skipInitial",
    "topic",
    "time",
    "Date",
    "now",
    "Router",
    "evaluateCondition",
    "length",
    "debug",
    "substring",
    "repeatTimeout",
    "Math",
    "round",
    "say",
    "language",
    "window",
    "speechSynthesis",
    "warn",
    "synth",
    "locale",
    "Manager",
    "getInstance",
    "getLocale",
    "utterThis",
    "SpeechSynthesisUtterance",
    "selectedVoice",
    "defaultVoice",
    "voices",
    "getVoices",
    "onvoiceschanged",
    "bind",
    "i",
    "l",
    "lang",
    "substr",
    "toLowerCase",
    "voice",
    "name",
    "speak",
    "SpeechHandler"
  ],
  "sources": [
    "/home/runner/work/CometVisu/CometVisu/source/class/cv/core/notifications/SpeechHandler.js"
  ],
  "sourcesContent": [
    "/* SpeechHandler.js\n *\n * copyright (c) 2010-2022, Christian Mayer and the CometVisu contributers.\n *\n * This program is free software; you can redistribute it and/or modify it\n * under the terms of the GNU General Public License as published by the Free\n * Software Foundation; either version 3 of the License, or (at your option)\n * any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for\n * more details.\n *\n * You should have received a copy of the GNU General Public License along\n * with this program; if not, write to the Free Software Foundation, Inc.,\n * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA\n */\n\n/**\n * SpeechHandler\n *\n * @author tobiasb\n * @since 2017\n *\n * @ignore(SpeechSynthesisUtterance)\n */\n\nqx.Class.define('cv.core.notifications.SpeechHandler', {\n  extend: qx.core.Object,\n  implement: cv.core.notifications.IHandler,\n  type: 'singleton',\n\n  /*\n  ******************************************************\n    CONSTRUCTOR\n  ******************************************************\n  */\n  construct() {\n    super();\n    this.__lastSpeech = {};\n  },\n\n  /*\n  ******************************************************\n    MEMBERS\n  ******************************************************\n  */\n  members: {\n    __lastSpeech: null,\n\n    handleMessage(message, config) {\n      let text = message.message || message.title;\n      if (config.skipInitial && !this.__lastSpeech[message.topic]) {\n        this.__lastSpeech[message.topic] = {\n          text: text,\n          time: Date.now()\n        };\n\n        return;\n      }\n      if (cv.core.notifications.Router.evaluateCondition(message)) {\n        if (!text || text.length === 0) {\n          // nothing to say\n          this.debug('no text to speech given');\n          return;\n        }\n\n        if (text.substring(0, 1) === '!') {\n          // override repeatTimeout, force saying this\n          text = text.substring(1);\n        } else if (config.repeatTimeout >= 0) {\n          // do not repeat (within timeout when this.repeatTimeout > 0)\n          if (\n            this.__lastSpeech[message.topic] &&\n            this.__lastSpeech[message.topic].text === text &&\n            (config.repeatTimeout === 0 ||\n              config.repeatTimeout >= Math.round((Date.now() - this.__lastSpeech[message.topic].time) / 1000))\n          ) {\n            // update time\n            this.__lastSpeech[message.topic].time = Date.now();\n            // do not repeat\n            this.debug('skipping TTS because of repetition ' + text);\n            return;\n          }\n        }\n\n        this.__lastSpeech[message.topic] = {\n          text: text,\n          time: Date.now()\n        };\n\n        this.say(text);\n      }\n    },\n\n    say(text, language) {\n      if (!window.speechSynthesis) {\n        this.warn(this, 'this browser does not support the Web Speech API');\n        return;\n      }\n      const synth = window.speechSynthesis;\n\n      if (!language) {\n        language = qx.locale.Manager.getInstance().getLocale();\n      }\n\n      // speak\n      const utterThis = new SpeechSynthesisUtterance(text);\n\n      let selectedVoice;\n      let defaultVoice;\n      const voices = synth.getVoices();\n      if (voices.length === 0) {\n        synth.onvoiceschanged = function () {\n          this.say(text, language);\n        }.bind(this);\n        return;\n      }\n      synth.onvoiceschanged = null;\n\n      let i = 0;\n      const l = voices.length;\n      for (; i < l; i++) {\n        if (language && voices[i].lang.substr(0, 2).toLowerCase() === language) {\n          selectedVoice = voices[i];\n        }\n        if (voices[i]['default']) {\n          defaultVoice = voices[i];\n        }\n      }\n      if (!selectedVoice) {\n        selectedVoice = defaultVoice;\n      }\n      utterThis.voice = selectedVoice;\n      this.debug('saying \\'' + text + '\\' in voice ' + selectedVoice.name);\n      synth.speak(utterThis);\n    }\n  }\n});\n"
  ],
  "mappings": "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"
}