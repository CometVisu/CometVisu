<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>CometVisu Source: lib/IconTools.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.spacelab.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">CometVisu</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-lib_CometVisuClient.html">lib/CometVisuClient</a></li><li><a href="module-lib_TemplateEngine.html">lib/TemplateEngine</a></li><li><a href="module-plugins_powerspectrum_structure_plugin.html">plugins/powerspectrum/structure_plugin</a></li><li><a href="module-structure_pure.html">structure/pure</a></li><li><a href="module-structure_pure_Audio.html">structure/pure/Audio</a></li><li><a href="module-structure_pure_Break.html">structure/pure/Break</a></li><li><a href="module-structure_pure_DesignToggle.html">structure/pure/DesignToggle</a></li><li><a href="module-structure_pure_Group.html">structure/pure/Group</a></li><li><a href="module-structure_pure_Image.html">structure/pure/Image</a></li><li><a href="module-structure_pure_ImageTrigger.html">structure/pure/ImageTrigger</a></li><li><a href="module-structure_pure_Include.html">structure/pure/Include</a></li><li><a href="module-structure_pure_Info.html">structure/pure/Info</a></li><li><a href="module-structure_pure_InfoAction.html">structure/pure/InfoAction</a></li><li><a href="module-structure_pure_InfoTrigger.html">structure/pure/InfoTrigger</a></li><li><a href="module-structure_pure_Line.html">structure/pure/Line</a></li><li><a href="module-structure_pure_Multitrigger.html">structure/pure/Multitrigger</a></li><li><a href="module-structure_pure_NavBar.html">structure/pure/NavBar</a></li><li><a href="module-structure_pure_Page.html">structure/pure/Page</a></li><li><a href="module-structure_pure_PageJump.html">structure/pure/PageJump</a></li><li><a href="module-structure_pure_PushButton.html">structure/pure/PushButton</a></li><li><a href="module-structure_pure_Refresh.html">structure/pure/Refresh</a></li><li><a href="module-structure_pure_Reload.html">structure/pure/Reload</a></li><li><a href="module-structure_pure_Rgb.html">structure/pure/Rgb</a></li><li><a href="module-structure_pure_Slide.html">structure/pure/Slide</a></li><li><a href="module-structure_pure_Switch.html">structure/pure/Switch</a></li><li><a href="module-structure_pure_Text.html">structure/pure/Text</a></li><li><a href="module-structure_pure_Toggle.html">structure/pure/Toggle</a></li><li><a href="module-structure_pure_Trigger.html">structure/pure/Trigger</a></li><li><a href="module-structure_pure_Unknown.html">structure/pure/Unknown</a></li><li><a href="module-structure_pure_UrlTrigger.html">structure/pure/UrlTrigger</a></li><li><a href="module-structure_pure_Video.html">structure/pure/Video</a></li><li><a href="module-structure_pure_Web.html">structure/pure/Web</a></li><li><a href="module-structure_pure_WgPluginInfo.html">structure/pure/WgPluginInfo</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="-_anonymous_-EventHandler-Dispatcher.html"><anonymous>~EventHandler~Dispatcher</a></li><li><a href="FOO.html">FOO</a></li><li><a href="module-cometvisu-client.html">cometvisu-client</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html#debug">debug</a></li><li><a href="global.html#fadeNavbar">fadeNavbar</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#handleRead">handleRead</a></li><li><a href="global.html#initializeNavbars">initializeNavbars</a></li><li><a href="global.html#jOWM">jOWM</a></li><li><a href="global.html#list">list</a></li><li><a href="global.html#navbarSetSize">navbarSetSize</a></li><li><a href="global.html#subscribe">subscribe</a></li><li><a href="global.html#updatePageParts">updatePageParts</a></li><li><a href="global.html#write">write</a></li>
				</ul>
			</li>
			
		</ul>
		<div class="col-sm-3 col-md-3">
            <form class="navbar-form" role="search">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                    <div class="input-group-btn">
                        <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                    </div>
                </div>
            </form>
        </div>
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: lib/IconTools.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">/* IconTools.js 
 * 
 * copyright (c) 2010-2016, Christian Mayer and the CometVisu contributers.
 * 
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 3 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA
 */


/**
 * @author Christian Mayer
 * @since 2015
 */
define([ 'jquery' ], function( $ ) {
  "use strict";

  (function( window, undefined ){
  // "global" functions (=> state less)
  var hexColorRegEx = /#[0-9a-fA-F]{6}/,
      colorMapping = { // as a convenience, definition of a few colors
        white:  '#ffffff', 
        orange: '#ff8000',
        red:    '#ff4444',
        green:  '#44ff44',
        blue:   '#4444ff',
        purple: '#ff44ff',
        yellow: '#ffff00',
        grey:   '#777777',
        black:  '#000000'
      },
      iconCache = {},    // the Image() of all knows (i.e. used) icons
      iconCacheMap = [], // mapping of ID to Cache entry (URL)
      iconDelay = [],    // array of all icons to fill where the Image is not ready yet
      iconDelayFn,       // handler for dealy function
      iconDelayed = function( icon, colors, color ) {
        iconDelay.push( [ icon, colors, color ] );
        if( !iconDelayFn )
          iconDelayFn = setInterval( function(){
            while( iconDelay.length )
            {
              // it should be enough to test only the first element - the other
              // elements will be covered anyway...
              if( iconDelay[0][2] in iconDelay[0][1] )
                window.fillRecoloredIcon( iconDelay.shift()[0] ); 
              else
                break;
            }
            
            if( 0 === iconDelay.length )
            {
              clearInterval( iconDelayFn );
              iconDelayFn = 0;
            }
          }, 10 );
      },
      /**
       * Create the HTML for the canvas element and return it.
       */
      createCanvas = function( iconId, styling, classes )
      {
        return '&lt;canvas class="' + iconId + ' ' + classes + '" ' + styling + '/>';
      },
      /**
       * Fill the canvas with the ImageData. Also resize the 
       * canvas at the same time.
       */
      fillCanvas = function( canvas, imageData )
      {
        canvas.width  = imageData.width;
        canvas.height = imageData.height;
        canvas.getContext('2d').putImageData( imageData, 0, 0 );
      },
      /**
       * Two versions of a recoloring funtion to work around an Android bug:
       * http://stackoverflow.com/questions/14969496/html5-canvas-pixel-manipulation-problems-on-mobile-devices-when-setting-the-alph
       * https://code.google.com/p/android/issues/detail?id=17565
       * 
       */
      innerRecolorLoop = navigator.userAgent.toLowerCase().indexOf('android') > -1 &amp;&amp; parseFloat(navigator.userAgent.slice(navigator.userAgent.toLowerCase().indexOf('android')+8)) &lt; 4.4 ?
        function( r, g, b, data, length ) // for Android version &lt; 4.4
        {
          for( var i = 0; i &lt; length; i += 4 )
          {
            var a = data[ i+3 ];
            if( a > 127 )
            {
              data[ i   ] = r;
              data[ i+1 ] = g;
              data[ i+2 ] = b;
              data[ i+3 ] = 255;
            } else { // brute force it...
              data[ i   ] = 0;
              data[ i+1 ] = 0;
              data[ i+2 ] = 0;
              data[ i+3 ] = 0;
            }
          }
        } :
        function( r, g, b, data, length ) // the normal version
        {
          for( var i = 0; i &lt; length; i += 4 )
          {
            if( 0 != data[ i+3 ] )
            {
              data[ i   ] = r;
              data[ i+1 ] = g;
              data[ i+2 ] = b;
            }
          }
        },
      tmpCanvas = $('&lt;canvas/>')[0],
      tmpCtx    = tmpCanvas.getContext('2d'),
      /**
       * Do the recoloring based on @param thisIcon and store it in the 
       * hash @param thisIconColors.
       */
      doRecolorNonTransparent = function( color, thisIcon, thisIconColors )
      {
        if( thisIconColors[color] )
          return; // done, already recolored
          
        var
          width  = tmpCanvas.width  = thisIcon.width,
          height = tmpCanvas.height = thisIcon.height;
        tmpCtx.drawImage( thisIcon, 0, 0 );
    
        var imageData = tmpCtx.getImageData( 0, 0, width, height );
        if( color !== undefined )
        {
          if( !hexColorRegEx.test( color ) )
            alert( 'Error! "' + color + '" is not a valid color for icon recoloring! It must have a shape like "#aabbcc".' );
          
          var r      = parseInt( color.substr( 1, 2 ), 16 ),
              g      = parseInt( color.substr( 3, 2 ), 16 ),
              b      = parseInt( color.substr( 5, 2 ), 16 );
          innerRecolorLoop( r, g, b, imageData.data, width * height * 4 );
        }
        thisIconColors[color] = imageData;
      };
  
  /**
   * Funtion to call for each icon that should be dynamically recolored.
   * This will be called for each known URL, so only remember the string but
   * don't load the image yet as it might not be needed.
   */
  window.recolorNonTransparent = function( url ) {
    var
      loadHandler = function(){
        var
          toFill         = iconCache[url].toFill,
          thisIcon       = iconCache[url].icon,
          thisIconColors = iconCache[url].colors,
          thisFillColor;
        while( thisFillColor = toFill.pop() )
        {
          doRecolorNonTransparent( thisFillColor, thisIcon, thisIconColors );
        }
      };

    /**
     * will be called for each color that is actually used
     * => load image for all colors
     * => transform image
     * @return {Function} a function that will append the recolored image to
     *         the jQuery element passed to that function 
     */
    return function( color, styling, classes, asText )
    {
      if( undefined === iconCache[url] )
      {
        var thisIcon = new Image();
        thisIcon.onload = loadHandler;
        thisIcon.src = url;
        
        iconCache[url] = {
          icon  : thisIcon,            // the original Image() of the icon
          id    : iconCacheMap.length, // the unique ID for this icon
          colors: {},                  // cache all the transformed ImageDatas
          toFill: []                   // all the icon colors to fill once the image was loaded
        };
        iconCacheMap.push( url );
      }

      if( color === undefined )
        color = '#ffffff';
      
      if( color in colorMapping )
        color = colorMapping[ color ];
      
      var c = 'icon' + iconCache[url].id + '_' + color.substr( 1, 6 );
      iconCache[url].toFill.push( color );
      
      // when already available - fill it now. Otherwise the onLoad will do it.
      if( iconCache[url].icon.complete )
        loadHandler();
      
      var newCanvas = createCanvas( c, styling, classes );
      if( asText )
        return newCanvas;
      
      var newElement = $(newCanvas)[0];
      if( iconCache[url].icon.complete )
        fillCanvas( newElement, iconCache[url].colors[ color ] );
      else
        iconDelayed( newElement, iconCache[url].colors, color );
      
      return newElement;
    }
  };
  
  /**
   * This function must be called to fill a specific icon that was created
   */
  window.fillRecoloredIcon = function( icon ) {
    var 
      parameters = (icon.className.split ? icon.className.split(' ') : icon.className.baseVal.split(' '))[0].substring(4).split('_');
    if( 2 === parameters.length )
    { 
      var 
        cacheEntry = iconCache[ iconCacheMap[ parameters[0] ] ],
        coloredIcon = cacheEntry.colors[ '#' + parameters[1] ];
        
      if( undefined === coloredIcon )
        iconDelayed( icon, cacheEntry.colors, '#' + parameters[1] );
      else
        fillCanvas( icon, coloredIcon );
    }
  };
  
  window.svgKUF = function( iconID ) {
    return function( color, styling, classes, asText )
    {
      if( color in colorMapping )
        color = colorMapping[ color ];
      
      var style='';
      if( color )
        style = 'style="color:' + color + '" ';
      
      return '&lt;svg ' + style + 'class="' + classes + '">&lt;use xlink:href="icon/knx-uf-iconset.svg#kuf-' + iconID + '">&lt;/use>&lt;/svg>';
    }
  };
})(window);

});
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>

<div class="modal fade" id="searchResults">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Search results</h4>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div>

<footer>


	<span class="copyright">
	CometVisu Copyright © 2010-2016, Christian Mayer and the CometVisu contributers.
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
	
		on Fri Jan 6th 2017
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>
<script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			var id = $( heading ).attr( "id" );
			return id && id.replace(/\~/g, '-inner-').replace(/\./g, '-static-') || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


<script type="text/javascript">
	$(document).ready(function() {
		SearcherDisplay.init();
	});
</script>

</body>
</html>
