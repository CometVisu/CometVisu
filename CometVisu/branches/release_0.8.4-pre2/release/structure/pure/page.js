/* page.js (c) 2012 by Christian Mayer [CometVisu at ChristianMayer dot de]
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 3 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA
 */

define(["_common"],function(e){var t=e.basicdesign;e.basicdesign.addCreator("page",{create:function(e,n,r,i){var s=$(e),o={};s.attr("ga")&&(src=s.attr("ga"),templateEngine.addAddress(s.attr("ga")),o["_"+s.attr("ga")]=["DPT:1.001",0]);var u=s.attr("name"),i=s.attr("type")||"text",a=s.attr("backdrop"),f=s.attr("showtopnavigation"),l=s.attr("showfooter");switch(i){case"2d":case"3d":break;default:i="text"}var c={top:"id"===n?"false":"inherit",bottom:"id"===n?"false":"inherit",left:"id"===n?"false":"inherit",right:"id"===n?"false":"inherit"};s.children("navbar").each(function(){c[$(this).attr("position")||"left"]="true"}),c.top=s.attr("shownavbar-top")||c.top,c.bottom=s.attr("shownavbar-bottom")||c.bottom,c.left=s.attr("shownavbar-left")||c.left,c.right=s.attr("shownavbar-right")||c.right;var h=templateEngine.bindClickToWidget;s.attr("bind_click_to_widget")&&(h=s.attr("bind_click_to_widget")=="true"),s.attr("flavour")&&(r=s.attr("flavour"));var p="";s.attr("align")&&(p+="text-align:"+s.attr("align")+";"),p!=""&&(p='style="'+p+'"');var d;if(s.attr("visible")=="false")d=$("");else{var v=s.children("layout")[0],m=v?'style="'+t.extractLayout(v,i)+'"':"";d=$('<div class="widget clearfix link pagelink" '+m+"/>"),t.setWidgetLayout(d,s);var g=$("<div "+p+'><a href="javascript:">'+u+"</a></div>"),y=h?d:g;y.bind("click",function(){templateEngine.scrollToPage(u)}),d.append(g)}var b=s.children().not("layout"),w=$('<div class="page type_'+i+'" id="'+n+'_"/>');w.data({name:u,showtopnavigation:f,showfooter:l,shownavbar:c});var E=$('<div class="clearfix" style="height:100%;position:relative;" />');for(var S in o)E.bind(S,this.update);var x=E;x.append("<h1>"+u+"</h1>");if("2d"==i){var T="width:100%;height:100%;";s.attr("size")=="fixed"&&(T="");if(undefined!=a){var N=".svg"==a.substring(a.length-4)?"embed":"img";x.append("<"+N+' src="'+a+'" style="position: absolute; top: 0px; left: 0px;z-index:-1;'+T+'"/>')}}else if("3d"==i&&!1){var C=JSFloorPlan3D(x,a);C.moveToRoom("Underground",!1,!0,!1),x.data("JSFloorPlan3D",C),x.find("canvas").css({position:"absolute",top:"0px",left:"0px","z-index":"-1",width:"100%",height:"100%"}),w.click({JSFloorPlan3D:C,callback:function(e){var t=this.JSFloorPlan3D;t.moveToRoom(t.getState("showFloor"),e.room.room,!0,!0,function(){x.trigger("update3d",t)})}},C.translateMouseEvent),$(window).bind("resize",function(){C.resize($(".page").width(),$(".page").height(),!0)}),s.attr("azimut")&&(templateEngine.addAddress(s.attr("azimut")),o["_"+s.attr("azimut")]=["DPT:9.001",0,"azimut"],x.bind("_"+s.attr("azimut"),this.update)),s.attr("elevation")&&(templateEngine.addAddress(s.attr("elevation")),o["_"+s.attr("elevation")]=["DPT:9.001",0,"elevation"],x.bind("_"+s.attr("elevation"),this.update)),s.attr("floor")&&(templateEngine.addAddress(s.attr("floor")),o["_"+s.attr("floor")]=["DPT:5.004",0,"floor"],x.bind("_"+s.attr("floor"),this.update)),$(b).each(function(e,t){if(this.tagName=="filter"){var n=$(this).attr("floor"),r=$(this).attr("room");b.splice(e,1),$(this).children().each(function(t){$(this).find("layout").attr({floorFilter:n,roomFilter:r}),b.splice(e+t,0,this)})}})}return x.data("address",o),$(b).each(function(e){x.append(templateEngine.create_pages(b[e],n+"_"+e,r,i))}),w.append(x),r&&w.addClass("flavour_"+r),$("#pages").prepend(w),d},update:function(e,n){var r=$(this),i=t.defaultValueHandling(e,n,r.data()),s=r.data().address[e.type][2];switch(s){case"azimut":r.data().JSFloorPlan3D.setState("currentAzimut",i,!0),r.trigger("update3d",r.data().JSFloorPlan3D);break;case"elevation":r.data().JSFloorPlan3D.setState("currentElevation",i,!0),r.trigger("update3d",r.data().JSFloorPlan3D);break;case"floor":r.data().JSFloorPlan3D.moveToRoom(i,!1,!0,!0,function(){r.trigger("update3d",r.data().JSFloorPlan3D)});break;default:n==1&&(templateEngine.scrollToPage(r.context.firstChild.textContent),templateEngine.visu.write(e.type.substr(1),templateEngine.transformEncode("DPT:1.001",0)))}}})});