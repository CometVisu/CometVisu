/* cometvisu.js (c) 2010 by Christian Mayer [CometVisu at ChristianMayer dot de]
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 3 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA
 */

function CometVisu(e){var t=this;this.urlPrefix=null==e?"":e,this.addresses=[],this.initialAddresses=[],this.filters=[],this.user="",this.pass="",this.device="",this.running=!1,this.doRestart=!1,this.xhr=!1,this.watchdogTimer=5,this.maxConnectionAge=60,this.maxDataAge=3200,this.lastIndex=-1,this.resendHeaders=[],this.headers=[],this.setInitialAddresses=function(e){this.initialAddresses=e},this.handleSession=function(e){this.session=e.s,this.version=e.v.split(".",3),(0<parseInt(this.version[0])||1<parseInt(this.version[1]))&&alert("ERROR CometVisu Client: too new protocol version ("+e.v+") used!"),this.running=!0,this.initialAddresses.length?this.xhr=$.ajax({url:this.urlPrefix+"r",dataType:"json",context:this,data:this.buildRequest(this.initialAddresses)+"&t=0",success:this.handleReadStart,beforeSend:this.beforeSend}):this.xhr=$.ajax({url:this.urlPrefix+"r",dataType:"json",context:this,data:this.buildRequest()+"&t=0",success:this.handleRead,error:this.handleError,beforeSend:this.beforeSend})},this.handleRead=function(e){if(!e&&-1==this.lastIndex){this.running&&(this.xhr=$.ajax({url:this.urlPrefix+"r",dataType:"json",context:this,data:this.buildRequest()+"&t=0",success:this.handleRead,error:this.handleError,beforeSend:this.beforeSend}),n.ping());return}if(e&&!this.doRestart){this.lastIndex=e.i;var t=e.d;this.readResendHeaderValues(),this.update(t)}this.running&&(this.xhr=$.ajax({url:this.urlPrefix+"r",dataType:"json",context:this,data:this.buildRequest()+"&i="+this.lastIndex,success:this.handleRead,error:this.handleError,beforeSend:this.beforeSend}),n.ping())},this.handleReadStart=function(e){if(!e&&-1==this.lastIndex){this.running&&(this.xhr=$.ajax({url:this.urlPrefix+"r",dataType:"json",context:this,data:this.buildRequest(this.startPageAddresses)+"&t=0",success:this.handleReadStart,beforeSend:this.beforeSend}),n.ping());return}e&&!this.doRestart&&(this.readResendHeaderValues(),this.update(e.d)),this.running&&(this.xhr=$.ajax({url:this.urlPrefix+"r",dataType:"json",context:this,data:this.buildRequest()+"&t=0",success:this.handleRead,error:this.handleError,beforeSend:this.beforeSend}),n.ping())},this.handleError=function(e,t,n){if(this.running&&e.readyState!=4&&!this.doRestart&&e.status!==0){var r="UNKNOWN";switch(e.readyState){case 0:r="UNINITIALIZED";break;case 1:r="LOADING";break;case 2:r="LOADED";break;case 3:r="INTERACTIVE";break;case 4:r="COMPLETED"}alert('Error! Type: "'+t+'" ExceptionObject: "'+n+'" readyState: '+r)}},this.beforeSend=function(e){for(var t in this.resendHeaders)this.resendHeaders[t]!=undefined&&e.setRequestHeader(t,this.resendHeaders[t]);for(var t in this.headers)this.headers[t]!=undefined&&e.setRequestHeader(t,this.headers[t])},this.readResendHeaderValues=function(){for(var e in this.resendHeaders)this.resendHeaders[e]=this.xhr.getResponseHeader(e)},this.buildRequest=function(e){e=e?e:this.addresses;var t=e.length?"a="+e.join("&a="):"",n=this.filters.length?"f="+this.filters.join("&f="):"";return"s="+this.session+"&"+t+(e.length&&this.filters.length?"&":"")+n},this.subscribe=function(e,t){var n=!this.addresses.length;this.addresses=e?e:[],this.filters=t?t:[],e.length?n&&this.login():this.stop()},this.login=function(){var e={};""!=this.user&&(e.u=this.user),""!=this.pass&&(e.p=this.pass),""!=this.device&&(e.d=this.device),$.ajax({url:this.urlPrefix+"l",dataType:"json",context:this,data:e,success:this.handleSession})},this.stop=function(){this.running=!1,this.abort()},this.write=function(e,t){var n=(new Date).getTime(),r="a="+e+"&v="+t+"&ts="+n;$.ajax({url:this.urlPrefix+"w",dataType:"json",context:this,data:r})},this.restart=function(){this.doRestart=!0,this.abort(),this.handleRead(),this.doRestart=!1},this.abort=function(){if(this.xhr.abort){this.xhr.abort();if(this.urlPrefix=="/services/cv/"){var e=this.headers["X-Atmosphere-Transport"];this.headers["X-Atmosphere-Transport"]="close",$.ajax({url:this.urlPrefix+"r",dataType:"json",context:this,beforeSend:this.beforeSend}),e!=undefined?this.headers["X-Atmosphere-Transport"]=e:delete this.headers["X-Atmosphere-Transport"]}}};var n=function(){var e=new Date,n=e,r=function(){var r=new Date;if(r-e<t.maxConnectionAge*1e3)return;r-n>t.maxDataAge*1e3&&(t.lastIndex=-1),t.restart(),e=r},i=setInterval(r,t.watchdogTimer*1e3);return{ping:function(){delete e,e=new Date,t.doRestart||(delete n,n=e)}}}()}CometVisu.prototype.update=function(e){};