/**
 * The Browser-Represenation-Layer of the Editor.
 * 
 * Uses a Configuration-object to display and make editable a configuration in the browser
 *
 *
 * LICENSE: This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 3
 * of the License, or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://opensource.org/licenses/gpl-license.php>;.
 *
 * @category    editor
 * @package     CometVisu
 * @author      Julian Makowski (julian at makowskis dot de)
 * @copyright   2012 Julian Makowski
 * @license     GPLv3 or later, http://opensource.org/licenses/gpl-license.php
 * @version     SVN: $Id$
 * @link        http://cometvisu.de
 * @since       2012-10-28
 * @requires    Schema.js, Configuration.js, Result.js, Messages.js, DataProvider.js
 */

var Editor=function(e){if(e==undefined||e==""||!e.rootNodes)throw"no, empty or invalid Configuration given, can not instantiate without one";var t=this,n=e,r="previewtemp",i=!1,s=!1;if($.cookie("editor_complex")==1||$.cookie("editor_complex")=="true")s=!0;var o=function(e){var t=$(this);if(t.is(".save")){if(!1===n.isValid()){alert(Messages.editor.notSavingInvalidConfiguration);return}n.save()}if(t.is(".preview")){if($("iframe#preview").length>0){$("iframe#preview").remove(),$("ul#config").show(),$(".menu .button.preview").removeClass("active");return}if(!1===n.isValid()){alert(Messages.editor.notSavingInvalidConfiguration);return}i=!0,$(document).one("configuration_saving_success",a),n.save("config/visu_config_"+r+".xml")}t.is(".expert")&&($("#config").find(".expert").toggle(),t.toggleClass("active"),s=t.hasClass("active"),$.cookie("editor_complex",s,{expires:365}))},u=function(e,t){switch(e.type){case"configuration_saving_error":alert(t.message);break;case"configuration_saving_success":if(!1===i){var n=new Result(!1,Messages.configuration.saved);alert(n.message)}}i=!1},a=function(){$("iframe#preview").remove(),$(".menu .button.preview").addClass("active"),$("ul#config").hide();var e=$("<iframe />");e.attr({id:"preview",src:"index.html?config="+r});var t=$(window).height()-$("#editor .menu").height()-$("#editor .menu").position().top;e.css({width:"100%",height:t+"px",border:"none"}),$("#editor").append(e)};t.render=function(e){var r=$(e),i=$("<ul />").attr("id","config");$.each(n.rootNodes,function(e,n){var r=new EditorConfigurationElement(t,n);i.append(r.getAsHTML())}),i.click(function(){$(".submenu:visible").hide(),$(".toggleSubmenu.active").removeClass("active")});var a=$("<div />").attr("id","editor"),f=$("<div />").addClass("menu"),l=$("<span />").addClass("button").addClass("save").html(Messages.editor.ui.save.text).attr("title",Messages.editor.ui.save.tooltip).click(o);f.append(l);var c=$("<span />").addClass("button").addClass("expert").html(Messages.editor.ui.expert.text).attr("title",Messages.editor.ui.expert.tooltip).click(o);f.append(c),s==1&&c.addClass("active");var h=$("<span />").addClass("button").addClass("preview").html(Messages.editor.ui.preview.text).attr("title",Messages.editor.ui.preview.tooltip).click(o);f.append(h),a.append(f),a.append(i),r.append(a),$(document).bind("configuration_saving_error",u),$(document).bind("configuration_saving_success",u)};var f={element:undefined,options:undefined};t.rememberElement=function(e,t){f.element=e,f.options=t},t.getRememberedElement=function(){return f.element},t.getRememberedElementOptions=function(){return f.options},t.areExpertAttributesVisible=function(){return s}},EditorConfigurationElement=function(e,t){var n=this,r=e,i=t,s=undefined,o=13,u=27,a={},f={cache:{$submenu:undefined},getGenericButton:function(){return $("<span />").addClass("button").append($("<span />").addClass("image"))},getButtonOfType:function(e){var t;switch(e){case"children":t=f.getGenericButton().addClass("children").click(f.clickHandler),t.attr("title",Messages.editor.ui.children.tooltip);break;case"toggleSubmenu":t=f.getGenericButton().addClass("toggleSubmenu").click(f.clickHandler),t.attr("title",Messages.editor.ui.toggleSubmenu.tooltip);break;default:throw"programming error, no button of type known, type: "+e}return t},getSubMenuHTML:function(e){if(f.cache.$submenu!=undefined)return f.cache.$submenu;var n=$("<span />").addClass("submenu");e=$.extend({remove:!0},e||{});var s=f.getGenericButton(),o=$("<span />").addClass("menuitem"),u;!0===e.children&&(u=o.clone(),u.addClass("addchild").click(f.clickHandler),u.attr("title",Messages.editor.ui.addChild.tooltip),u.text(Messages.editor.ui.addChild.text),n.append(u),delete u),u=o.clone(),u.addClass("remove").click(f.clickHandler),u.attr("title",Messages.editor.ui.remove.tooltip),u.text(Messages.editor.ui.remove.text),!1===e.remove&&u.addClass("disabled"),n.append(u),delete u,n.append(o.clone().addClass("spacer")),$.each(["cut","copy","paste"],function(e,t){u=o.clone(),u.addClass(t).click(f.clickHandler),u.attr("title",Messages.editor.ui[t].tooltip),u.text(Messages.editor.ui[t].text),n.append(u),delete u}),!0===t.getSchemaElement().isSortable()&&(u=o.clone(),u.addClass("sort").click(f.clickHandler),u.attr("title",Messages.editor.ui.sort.tooltip),u.text(Messages.editor.ui.sort.text),n.append(u),delete u);var a=n.find(".menuitem.paste");$.each(i.getAllowedElements(),function(e){a.addClass("paste_allows_"+e)}),a.addClass("disabled");var l=r.getRememberedElementOptions();return undefined!=l&&(l.type=="copy"||l.type=="cut")&&undefined!=l&&name==l.nodeType&&a.is(".paste_allows_"+l.nodeType)&&a.removeClass("disabled"),delete a,n.hide(),f.cache.$submenu=n,n},hideSubMenu:function(){f.cache.$submenu.hide()},hideAllSubMenus:function(){$(".submenu:visible").hide(),$(".toggleSubmenu.active").removeClass("active")},toggleSubMenu:function(){$(".submenu:visible").not(f.cache.$submenu).hide(),f.cache.$submenu.slideToggle()},clickHandler:function(e){var t=$(this);if(t.is(".disabled"))return;t.is(".toggleSubmenu")&&(f.toggleSubMenu(),t.addClass("active"),e.stopPropagation()),t.is(".attributes")&&(c.toggleDisplay(),t.toggleClass("active"));if(t.is(".addchild")){var o=l.getAsHTML();if(o==undefined){alert(Messages.validity.noMoreChildrenAllowed);return}f.cache.$submenu.hide(),t.closest("span.element").find("> span.name").after(o)}t.is(".remove")&&(f.hideSubMenu(),window.confirm("delete node?")&&n.remove());if(t.is(".children")){if(!0===t.is(".disabled"))return;t.closest("li").find("span.element").first().children("ul.children").slideToggle("fast"),t.toggleClass("active")}t.is(".copy")&&(r.rememberElement(n,{type:"copy",nodeType:i.name}),$("ul#config .paste.paste_allows_"+i.name).removeClass("disabled"),f.hideSubMenu());if(t.is(".cut")){if(!1===i.isRemovable()){alert(Messages.editor.elementNotCuttable);return}f.cancelSort(),f.cancelCut(),r.rememberElement(n,{type:"cut",nodeType:i.name}),$("ul#config .paste.paste_allows_"+i.name).removeClass("disabled"),s.addClass("cutout"),f.hideSubMenu()}if(t.is(".paste")){if(t.is(".disabled"))return;var u=r.getRememberedElement(),a=r.getRememberedElementOptions();if(u==undefined||a==undefined)return;var h=u.getConfigurationElement(),p=h.getDuplicateForParent(i);i.appendChildNode(p),n.redrawHTML(),a.type=="cut"&&u.remove(),r.rememberElement(undefined,undefined),$("ul#config .paste").addClass("disabled"),f.hideSubMenu()}if(t.is(".sort")){f.cancelSort(),f.cancelCut();var d=s.siblings().filter(".sortable"),v=s.parent(),m=$("<li />").addClass("dropzone");m.click(f.clickHandler),d.before(m.clone(!0)),v.append(m.clone(!0)),v.find(".dropzone + .dropzone").remove(),s.next(".dropzone").hide(),s.addClass("cutout"),f.hideSubMenu()}if(t.is(".dropzone")){var g=t.parent().find(".dropzone").index(t),y=t.prevAll(".element:not(.sortable)").length;g+=y,f.cancelSort();var b=n.getConfigurationElement();b.remove();var w=b.getDuplicateForParent(i.getParentElement());r.getConfigurationElement().addChildAtPosition(w,g),n.remove(),r.redrawHTML(),r.rememberElement(undefined,undefined)}},cancelSort:function(){$(".cutout").removeClass("cutout"),$(".dropzone").remove()},cancelCut:function(){var e=r.getRememberedElement();e!=undefined&&e.getAsHTML().removeClass("cutout"),r.rememberElement(undefined,undefined)}},l={settings:{textDefault:"- select -",valueDefault:"",cssClass:"addChildContainer"},getAsHTML:function(){var e=$("<span />").addClass(l.settings.cssClass),t=i.getAllowedElements();if(t==undefined)throw"no list of allowed elements available, programmer: no schemaElement?";var n=$("<select />"),r=$("<option />");r.attr("value",l.settings.valueDefault),r.html(l.settings.textDefault),n.append(r),delete r,$.each(t,function(e,t){if(!0===i.isChildCreatable(e)){var r=$("<option />");r.attr("value",e),r.html(e),n.append(r)}});if(n.children().length==1)return undefined;var s=n.find("option");s.sort(function(e,t){return e.text>t.text?1:e.text<t.text?-1:0}),n.empty().append(s),delete s,n.val(l.settings.valueDefault),e.append(n);var o=f.getGenericButton();o.addClass("addchild"),o.bind("click",l.saveHandler),e.append(o),delete o;var u=f.getGenericButton();return u.addClass("cancel"),u.bind("click",l.cancelHandler),e.append(u),delete u,e},saveHandler:function(){var e=$(this).closest("."+l.settings.cssClass).find("select"),t=e.val();if(t==l.settings.valueDefault)return;i.createChildNode(t),e.closest("span."+l.settings.cssClass).remove(),n.redrawHTML()},cancelHandler:function(){var e=$(this).closest("."+l.settings.cssClass).find("select");e.closest("span."+l.settings.cssClass).remove()}},c={$attributes:undefined,$htmlPlaceholder:undefined,getPlaceholderAsHTML:function(){return typeof c.$attributes!="undefined"?c.$attributes:(c.$htmlPlaceholder=$("<span />"),c.$htmlPlaceholder)},getAsHTML:function(){var e=$.extend({},i.attributes),t=i.getSchemaElement();t!=undefined&&(e=$.extend({},t.allowedAttributes,i.attributes));var n=$("<ul />").addClass("attributes");return $.each(e,function(e,i){var s=undefined,o=!1,u="";if(t!=undefined){var a=t.allowedAttributes[e];if(typeof a=="undefined")throw"unknown attribute "+e+" for element "+t.name;s=a.isOptional;var f=a.getAppinfo();o=f.indexOf("level:expert")!=-1,delete f;var l=a.getDocumentation();l.length>0&&(u=l[0]),delete l}var h=$("<li />").addClass("attribute");h.addClass("attributeType_"+e),!0===o&&(h.addClass("expert"),r.areExpertAttributesVisible()==0&&h.hide());var p=$("<span />").addClass("name").html(e);!0===s?p.addClass("optional"):p.addClass("required"),h.append(p),delete p;var d;typeof i=="string"&&i.trim()!=""?d=$("<span />").addClass("value").html(i):d=$("<span />").addClass("value").addClass("notset"),d.attr("title",Messages.editor.ui.clickToEdit.tooltip),h.append(d);if(u!=""){var v=$("<span />");v.addClass("documentation"),v.html(u),h.append(v),delete v}d.bind("click",c.clickHandler),delete d,n.append(h),delete h}),delete e,n.is(":empty")?undefined:(n.hide(),c.$attributes=n,n)},clickHandler:function(e){var t=$(this),n=t.html(),r=t.width(),s=t.height();t.hide();var o=t.siblings("span.name").text(),u=i.getSchemaElement().allowedAttributes[o].getEnumeration(),a=i.getSchemaElement().allowedAttributes[o].isOptional,f=!1;if(u==undefined||u.length==0){var l=DataProviderManager.getProvider(i.name,o);undefined!=l&&(u=l.getEnumeration(),f=l.isUserInputAllowed())}var h=p(n,u,f,a);t.before(h),h.width(r),h.height(s),h.bind("cancel",c.cancelHandler),h.bind("blur",c.saveHandler),h.bind("keyup",c.keypressHandler),h.get(0).focus()},keypressHandler:function(e){e.which==o&&$(this).triggerHandler("blur"),e.keyCode==u&&$(this).triggerHandler("cancel")},cancelHandler:function(e){var t=$(this),n=t.siblings("span.value");t.remove(),n.show()},saveHandler:function(e){var t=$(this),n=t.siblings("span.value"),r=t.find("input, textarea, select").andSelf().filter("input, textarea, select").val(),i=t.siblings("span.name").text();if(!1===c.saveValue(i,r))return;t.remove(),n.show()},saveValue:function(e,t){var n=c.$attributes,r=n.find("li.attribute.attributeType_"+e).find(".value");if(r.length==0)return!1;var s=i.setAttributeValue(e,t);return s.success!==!0?(alert(s.message),!1):($.trim(t)==""?r.addClass("notset"):r.removeClass("notset"),r.html(t),!0)},renderHTML:function(){var e=c.$attributes;typeof e=="undefined"&&(e=c.getAsHTML(),c.$htmlPlaceholder.replaceWith(e),c.$htmlPlaceholder=undefined)},toggleDisplay:function(){c.renderHTML();var e=c.$attributes;$("ul.attributes:visible").not(e).length>0?$("ul.attributes:visible").not(e).slideToggle("fast",function(){typeof e!="undefined"&&e.slideToggle("fast")}):typeof e!="undefined"&&e.slideToggle("fast");return},hideAll:function(){$("ul.attributes:visible").slideToggle("fast")},markAttributeInvalid:function(e){c.renderHTML();var t=c.$attributes,n=t.find("span.name:contains("+e+")").closest("li.attribute");t.parents("li.element").addClass("invalidChildAttribute"),t.closest("li.element").removeClass("invalidChildAttribute").addClass("invalidAttribute"),n.addClass("invalid"),n.bind("valid",c.markAttributeValid)},markValueChanged:function(e){var t=c.$attributes,n=t.find("span.name:contains("+e+")").closest("li.attribute");if(!1===n.is(".invalid"))return;n.removeClass("invalid");if(t.find("li.attribute.invalid").length>0)return;t.parents("li.element").each(function(){0==$(this).find("li.attribute.invalid").length&&$(this).removeClass("invalidChildAttribute").removeClass("invalidAttribute")})},updateHintedAttributes:function(e,t){var n=DataProviderManager.getProvider(i.name,e);if(undefined==n)return;var r=n.getHintsForValue(t);if(undefined==r)return;$.each(r,function(e,t){c.saveValue(e,t)})}},h={getAsHTML:function(){var e=i.value,t=$("<span />").addClass("content"),n=$("<span />").addClass("value").html(e);return $.trim(e)==""&&n.addClass("notset"),n.attr("title",Messages.editor.ui.clickToEdit.tooltip),t.append(n),n.bind("click",h.clickHandler),t},clickHandler:function(e){var t=$(this),n=t.html(),r=t.width(),s=t.height();t.hide();var o=[],u;0==i.getSchemaElement().isMixed?(o=i.getSchemaElement().getAllowedContent()._text.getEnumeration(),u=!1):u=!0;if(o==undefined||o.length==0){var a=DataProviderManager.getProvider(i.name,"_nodeValue");undefined!=a&&(o=a.getEnumeration(),u=a.isUserInputAllowed())}var f=p(n,o,u);t.after(f),f.width(r),f.height(s),f.bind("cancel",h.cancelHandler),f.bind("blur",h.saveHandler),f.bind("keyup",h.keypressHandler),f.get(0).focus()},keypressHandler:function(e){e.which==o&&$(this).triggerHandler("blur"),e.keyCode==u&&$(this).triggerHandler("cancel")},cancelHandler:function(e){var t=$(this),n=t.siblings("span.value");t.remove(),n.show()},saveHandler:function(e){var t=$(this),n=t.siblings("span.value"),r=t.find("input, textarea, select").andSelf().filter("input, textarea, select").val(),s=i.setTextValue(r);if(s.success!==!0){alert(s.message);return}n.html(r),$.trim(r)==""?n.addClass("notset"):n.removeClass("notset"),t.remove(),n.show()},updateHintedAttributes:function(e){var t=i.name,n=DataProviderManager.getProvider(t,"_nodeValue");if(undefined==n)return;var r=n.getHintsForValue(e);if(undefined==r)return;var s=c.$attributes;$.each(r,function(e,t){c.saveValue(e,t)})}},p=function(e,t,n,r){var i;if(typeof t=="undefined"||t==undefined||t.length==0)e.length>30?i=$("<textarea />"):i=$("<input />"),i.val(e);else{var s=$.extend([],t);!0===r&&s.unshift({label:"- not set -",value:undefined});if(!0===n){var o=new ActiveInput;o.setValue(e),o.setEnumeration(s),i=o.getAsHTML()}else{i=$("<select />");var u=d(e,s)}i.append(u)}return i},d=function(e,t){var n=[];return $.each(t,function(t,r){var i=$("<option />"),s,o;if(typeof r=="string")s=o=r;else{if(typeof r.group!="undefined"){$.each(r.group,function(t,r){var i=r.label,s=r.elements,o=$("<optgroup />").attr("label",i),u=d(e,s);o.append(u),n.push(o)});return}s=r.label,o=r.value,o!=s&&(s+=" ("+r.value+")")}i.attr("value",o),i.html(s),o==e&&i.prop("selected",!0),n.push(i)}),n},v=function(){var e=s.find(".name").first();$(".name.active").not(e).removeClass("active"),e.toggleClass("active"),c.toggleDisplay()},m=function(e){switch(e.which){case 1:v();break;case 2:break;case 3:f.toggleSubMenu(),e.stopPropagation()}};n.rememberElement=function(e,t){r.rememberElement(e,t)},n.getRememberedElement=function(){return r.getRememberedElement()},n.areExpertAttributesVisible=function(){return r.areExpertAttributesVisible()},n.getRememberedElementOptions=function(){return r.getRememberedElementOptions()},n.remove=function(){if(!1===i.isRemovable()){alert(Messages.editor.elementNotRemovable);return}i.remove(),$(s).remove(),r.redrawChildrenButton(),delete i},n.redrawChildrenButton=function(){var e=s.find("ul.children > li").length>0,t=s.find(".button.children").first();e?t.removeClass("disabled"):(t.addClass("disabled").removeClass("active"),s.find("ul.children > li").hide())},n.getConfigurationElement=function(){return i},n.ConfigurationElementEventListener=function(e){switch(e.event){case"invalid":switch(e.params.type){case"attribute_missing":c.markAttributeInvalid(e.params.item);break;default:alert("unknown invalidity: "+e.params.type)}break;case"attributeChangedValue":if(e.params.item=="name"){var t=s.find(".name").first().find(".nameValue");e.params.newValue.trim()!=""?t.addClass("set"):t.removeClass("set"),t.text(e.params.newValue),delete t}c.markValueChanged(e.params.item),c.updateHintedAttributes(e.params.item,e.params.newValue);break;case"elementChangedValue":h.updateHintedAttributes(e.params.newValue);break;default:throw"programmer error, unknown event: "+e.event}},n.redrawHTML=function(){s.replaceWith(n.getAsHTML(!1,!0))},n.getAsHTML=function(e,t){if(typeof e=="undefined"||e==undefined)e=!0;if(typeof t=="undefined"||t==undefined)t=!1;if(!0===e&&s!=undefined)return s;s=$("<li />").addClass("element"),s.append($("<span />").addClass("tree").append(f.getButtonOfType("children"))),!0===i.getSchemaElement().isSortable()&&s.addClass("sortable");var r=$("<span />").addClass("element");s.append(r);var o=$("<span />").addClass("name").html(i.name).addClass("nodeType_"+i.name),u=$("<span />").addClass("nameValue"),l=i.getSchemaElement().getAppinfo(),p="name";$.each(l,function(e,t){/^descriptor:/.test(t)&&(p=t.replace(/^descriptor:/,""))}),delete l,p=="#text"?i.value!=undefined&&i.value.trim()!=""&&(u.text(i.value),u.addClass("set")):typeof i.attributes[p]!="undefined"&&i.attributes[p].trim()!=""&&(u.text(i.attributes[p]),u.addClass("set")),o.append(u),delete u,r.append(o);var d=c.getPlaceholderAsHTML(),v=i.getSchemaElement(),g=v.getAllowedElements(),y={children:!$.isEmptyObject(g),remove:i.isRemovable()};r.append(f.getButtonOfType("toggleSubmenu")),o.mouseup(m).bind("contextmenu",function(e){e.preventDefault()});var b=f.getSubMenuHTML(y);r.append(b),delete y,delete b,!v.isMixed&&v.getAllowedContent()._text!=0&&r.append(h.getAsHTML()),d!=undefined&&d.length>0&&r.append(d),o.css({cursor:"pointer"});var w=$("<ul />").addClass("children"),E={};return $.each(i.getChildren(),function(e,t){var r,i=t.getUID();typeof a[i]!="undefined"?r=a[i]:(r=new EditorConfigurationElement(n,t),i=r.getConfigurationElement().getUID()),w.append(r.getAsHTML(!0)),E[i]=r}),a=E,delete E,!1===t&&w.hide(),r.append(w),delete w,n.redrawChildrenButton(),s},i.attachListener(n)};