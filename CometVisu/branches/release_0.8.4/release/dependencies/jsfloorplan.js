//
//  JavaScript FloorPlan 3D.
//
//   Copyright (C) 2009, 2010 by Christian Mayer
//   jsfloorplan (at) ChristianMayer.de
//
//   This program is free software; you can redistribute it and/or modify
//   it under the terms of the GNU General Public License as published by
//   the Free Software Foundation; either version 2 of the License, or
//   (at your option) any later version.
//
//   This program is distributed in the hope that it will be useful,
//   but WITHOUT ANY WARRANTY; without even the implied warranty of
//   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//   GNU General Public License for more details.
//
//   You should have received a copy of the GNU General Public License
//   along with this program; if not, write to the
//   Free Software Foundation, Inc.,
//   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
//
//////////////////////////////////////////////////////////////////////////////

(function(e,t){var n=1,r=function(i,s){function O(e,t){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))}function M(e,t,n,r){M.arguments.length==3&&(r=M.arguments[2],n=M.arguments[1],t=Math.cos(M.arguments[0]),e=Math.sin(M.arguments[0]));var i=new Object;return i.x=r.x+t*(n.x-r.x)-e*(n.y-r.y),i.y=r.y+e*(n.x-r.x)+t*(n.y-r.y),i}function _(e,t){var n=new Object;return n.x=e.x+t.x,n.y=e.y+t.y,n}function D(e,t){var n=e.y>=0?1-e.x:e.x+3,r=t.y>=0?1-t.x:t.x+3;return n-r}function I(e,t){if(N)return;A=!1;var n=u/a,r=.1,s=1e4;m=new THREE.WebGLRenderer({antialias:!0}),v=new THREE.PerspectiveCamera(f,n,r,s),d=new THREE.Scene,d.add(v),v.position.z=300,m.setSize(u,a);var o=2048,l=1024;m.shadowCameraNear=.1,m.shadowCameraFar=100,m.shadowCameraFov=45,m.shadowMapBias=.0039,m.shadowMapDarkness=.5,m.shadowMapWidth=o,m.shadowMapHeight=l,m.shadowMapEnabled=!0,g=new THREE.PointLight(16777215),b=new THREE.AmbientLight(16777215),g.position.x=10,g.position.y=50,g.position.z=130,y=new THREE.SpotLight(16777215),y.position.set(0,1500,1e3),y.target.position.set(0,0,0),y.castShadow=!0;var c=new THREE.Geometry;c.vertices.push(new THREE.Vertex(y.position)),c.vertices.push(new THREE.Vertex(y.target.position)),w=new THREE.Line(c,p),d.add(w),d.add(t),d.add(y),d.add(b);var h=$(i);h.append(m.domElement)}function q(e,t,n,r){var i=Math.sin(e)*Math.cos(t),s=Math.cos(e)*Math.cos(t),o=Math.sin(t);v.up=new THREE.Vector3(-Math.sin(e)*Math.sin(t),-Math.cos(e)*Math.sin(t),Math.cos(t)),v.position=new THREE.Vector3(i*n+r.x,s*n+r.y,n*o+r.z),v.lookAt(r),g.position=v.position}function R(){q(E.currentAzimut,E.currentElevation,E.currentDistance,E.currentTarget);var e=Math.sin(E.lightAzimut)*Math.cos(E.lightElevation),t=Math.cos(E.lightAzimut)*Math.cos(E.lightElevation),n=Math.sin(E.lightElevation);y.target.position=E.currentTarget,y.position=new THREE.Vector3(e*E.lightDistance,t*E.lightDistance,n*E.lightDistance+E.currentTarget.z),y.intensity=E.lightStrength/100,w.geometry.vertices[0].position=y.position,w.geometry.vertices[1].position=y.target.position,w.geometry.__dirtyVertices=!0,E.showLightView&&(v.position=y.position,v.lookAt(y.target.position)),h.opacity!=E.fillOpacity&&(h.opacity=E.fillOpacity,h.transparent=E.fillOpacity<1,h.depthTest=!h.transparent,THREE.SceneUtils.traverseHierarchy(o.buildingProperties.Object3D,function(e){e.doubleSided=h.transparent})),o.render()}function U(e,t){var n=0,r=C[t.corners[t.corners.length-1]];for(var i in t.corners){var s=C[t.corners[i]];(r.x<e.x||s.x<e.x)&&(r.y-e.y)*(s.y-e.y)<0&&n++,r=s}return n%2}if(!(this instanceof r))return new r(i,s);var o=this;this.buildingProperties={floor:[],Object3D:new THREE.Object3D,floorNames:{}};var u=800,a=400,f=45,l=new THREE.Projector,c=new THREE.MeshLambertMaterial({color:13369344}),h=new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture("media/demo_texture_512x512.png")}),p=new THREE.LineBasicMaterial({color:39423,linewidth:2}),d,v,m,g,y,b,w,E={currentAzimut:1,currentElevation:Math.PI/2,currentDistance:10,lightAzimut:3.9,lightElevation:.25,lightStrength:80,lightDistance:50,fillOpacity:1,fillColor:new THREE.Color(16777215),showNodes:!1,showWallLines:!1,showWireframe:!1,showLightView:!1,showFloor:t},S,x=Array(),T=new Object,N=!0,C=new Object,k=new Array,L=new Array,A=!0;r.inAnimation=!1;var P=function(e){N=!1;var t=-1,r=0,i;if("building"!=e.documentElement.tagName)return alert("ERROR: Not a valid floor plan! Expected: 'building', found '"+e.documentElement.tagName+"'");i=e.documentElement;for(var s=0;s<i.childNodes.length;s++){S=i.childNodes[s];if(S.nodeType!=n)continue;if(S.tagName=="textures"){F(S);continue}if(S.tagName!="floor")return alert("ERROR: Not a valid floor plan! Expected: 'floor', found '"+S.tagName+"'");t++,o.buildingProperties.floor[t]={};var u=S.getAttribute("name");o.buildingProperties.floor[t].name=u,o.buildingProperties.floorNames[u]=t;var a=Number(S.getAttribute("height"));o.buildingProperties.floor[t].height=a,o.buildingProperties.floor[t].heightOfGround=r;var f=k.length;for(var l=0;l<S.childNodes.length;l++){var d=S.childNodes[l];if(d.nodeType!=n)continue;switch(d.tagName){case"nodes":H(d,a);break;case"walls":B(d);break;case"rooms":j(d,t)}}var v=new THREE.Object3D;for(var l=f;l<k.length;l++)C[k[l].start].neighbour.push(l+1),C[k[l].end].neighbour.push(-l-1);var m=new THREE.Object3D;m.name="nodeGroup";for(var g in C){var y=new Array,b=C[g],w=new THREE.Mesh(new THREE.SphereGeometry(.1,4,4),c);w.position=new THREE.Vector3(b.x,b.y,r),m.add(w);for(var l=0;l<C[g].neighbour.length;l++){var E=new Object;E.id=C[g].neighbour[l];var L;E.id<0?L=C[k[-E.id-1].start]:L=C[k[E.id-1].end],length=O(b,L),E.x=(L.x-b.x)/length,E.y=(L.y-b.y)/length,y.push(E)}y.sort(D);for(var l=0;l<y.length;l++){var A=(l+1)%y.length,M=Math.abs(y[l].id)-1,_=Math.abs(y[A].id)-1,P=k[M].thickness/2,I=k[_].thickness/2;k[M].startOffset&&y[l].id>0&&(P+=k[M].startOffset),k[M].endOffset&&y[l].id<0&&(P+=k[M].endOffset),k[_].startOffset&&y[A].id>0&&(I+=-k[_].startOffset),k[_].endOffset&&y[A].id<0&&(I+=-k[_].endOffset);var q=new Object;q.x=y[l].x*I+y[A].x*P,q.y=y[l].y*I+y[A].y*P;var R=y[l].x*y[A].y-y[l].y*y[A].x;Math.abs(R)<1e-5?Math.abs(P-I)<1e-5?(q.x=b.x-y[l].y*P,q.y=b.y+y[l].x*P):(alert("ERROR: A straight wall with different thicknesses is currently not supported!"),q.x=b.x-y[l].y*(P+I)/2,q.y=b.y+y[l].x*(P+I)/2):(q.x=b.x+q.x/R,q.y=b.y+q.y/R),y[l].id<0?k[M].startVertex.push(x.length):k[M].endVertex.push(x.length);if(1==y.length){var U=new Object;U.x=2*b.x-q.x,U.y=2*b.y-q.y,x.push(U)}y[A].id<0?k[_].startVertex.push(x.length):k[_].endVertex.push(x.length),x.push(q)}}v.add(m);var z=new THREE.Object3D;z.name="lineGroup";var W=new THREE.Object3D;W.name="wallGroup";for(var l=f;l<k.length;l++){var X=C[k[l].start],V=C[k[l].end],J=new THREE.Geometry;J.vertices.push(new THREE.Vertex(new THREE.Vector3(X.x,X.y,r))),J.vertices.push(new THREE.Vertex(new THREE.Vector3(V.x,V.y,r))),z.add(new THREE.Line(J,p));var K=x[k[l].startVertex[0]],Q=x[k[l].endVertex[0]],G=x[k[l].startVertex[1]],Y=x[k[l].endVertex[1]],Z=new Object;Z.x=K.x-G.x,Z.y=K.y-G.y;var et=new Object;et.x=Q.x-G.x,et.y=Q.y-G.y;var tt=new Object;tt.x=Q.x-Y.x,tt.y=Q.y-Y.y,(Z.x*et.y-Z.y*et.x)*(et.x*tt.y-et.y*tt.x)>0&&(Q=x[k[l].endVertex[1]],Y=x[k[l].endVertex[0]]);var nt=C[k[l].start],rt=C[k[l].end],it=C[k[l].start].z,st=C[k[l].end].z,ot=(G.x-K.x)*(Q.y-K.y)-(G.y-K.y)*(Q.x-K.x),ut=new THREE.Geometry,at=new THREE.Vector3(nt.y-rt.y,-nt.x+rt.x,0),ft=new THREE.Vector3(1,0,0),lt=[new poly2tri.Point(0,0),new poly2tri.Point(0,1),new poly2tri.Point(1,1),new poly2tri.Point(1,0)];lt[1].startEndMarker="start",lt[2].startEndMarker="end";var ct=[];if(k[l].holes.length){var ht=k[l].holes;for(var pt=0;pt<ht.length;pt++){var dt=O(nt,rt),vt=ht[pt].distance/dt,mt=(ht[pt].distance+ht[pt].width)/dt;vt<=0&&(vt=.001),mt>=1&&(mt=.999);var gt=(it-ht[pt].lintel)/it,yt=ht[pt].paparet/it;if(1==gt){if(yt==0)continue;lt.splice(-2,0,new poly2tri.Point(vt,1),new poly2tri.Point(vt,yt),new poly2tri.Point(mt,yt),new poly2tri.Point(mt,1));continue}if(0==yt){lt.splice(0,0,new poly2tri.Point(mt,0),new poly2tri.Point(mt,gt),new poly2tri.Point(vt,gt),new poly2tri.Point(vt,0));continue}ct.push([new poly2tri.Point(vt,yt),new poly2tri.Point(mt,yt),new poly2tri.Point(mt,gt),new poly2tri.Point(vt,gt)])}}var bt=new poly2tri.SweepContext(lt.slice(0));for(var wt=0;wt<ct.length;wt++)bt.AddHole(ct[wt]);try{poly2tri.sweep.Triangulate(bt)}catch(Et){console.log(Et)}for(var St=0;St<bt.point_count();St++)bt.GetPoint(St).id=St;var xt=[];$.each(bt.GetTriangles(),function(e,t){xt.push(new THREE.Face3(t.GetPoint(0).id,t.GetPoint(1).id,t.GetPoint(2).id))});var Tt=bt.points_,Nt=xt,Ct=[],kt=[],Lt,At,Ot=1/((Q.x-K.x)*(Q.x-K.x)+(Q.y-K.y)*(Q.y-K.y)),Mt=1/((Y.x-G.x)*(Y.x-G.x)+(Y.y-G.y)*(Y.y-G.y));for(var _t=0;_t<Tt.length;_t++){var Dt=Tt[_t],Pt={x:nt.x*(1-Dt.x)+rt.x*Dt.x,y:nt.y*(1-Dt.x)+rt.y*Dt.x},Ht=((Pt.x-K.x)*(Q.x-K.x)+(Pt.y-K.y)*(Q.y-K.y))*Ot;if(Dt.x==0||Dt.x==1)Ht=1-Dt.x;var Bt=K.x*(1-Ht)+Q.x*Ht,jt=K.y*(1-Ht)+Q.y*Ht,Ft=((Pt.x-G.x)*(Y.x-G.x)+(Pt.y-G.y)*(Y.y-G.y))*Mt;if(Dt.x==0||Dt.x==1)Ft=1-Dt.x;var It=G.x*(1-Ft)+Y.x*Ft,qt=G.y*(1-Ft)+Y.y*Ft,Rt=r+it*Dt.y;ot>0?(Ct.push(new THREE.Vertex(new THREE.Vector3(Bt,jt,Rt),at)),kt.push(new THREE.Vertex(new THREE.Vector3(It,qt,Rt),at))):(Ct.push(new THREE.Vertex(new THREE.Vector3(It,qt,Rt),at)),kt.push(new THREE.Vertex(new THREE.Vector3(Bt,jt,Rt),at))),"startEndMarker"in Dt&&("start"==Dt.startEndMarker?Lt=Ct.length-1:At=Ct.length-1)}var Ut=Ct.length;ut.vertices=Ct.concat(kt);var zt=Lt,Wt=Lt+Ut,Xt=At,Vt=At+Ut;for(var $t=0;$t<Nt.length;$t++){var Jt=new THREE.UV(Tt[Nt[$t].a].x,1-Tt[Nt[$t].a].y),Kt=new THREE.UV(Tt[Nt[$t].b].x,1-Tt[Nt[$t].b].y),Qt=new THREE.UV(Tt[Nt[$t].c].x,1-Tt[Nt[$t].c].y),Gt=new THREE.UV(1-Tt[Nt[$t].c].x,1-Tt[Nt[$t].c].y),Yt=new THREE.UV(1-Tt[Nt[$t].b].x,1-Tt[Nt[$t].b].y),Zt=new THREE.UV(1-Tt[Nt[$t].a].x,1-Tt[Nt[$t].a].y);ut.faces.push(Nt[$t]),ut.faceVertexUvs[0].push([Jt,Kt,Qt]),ut.faces.push(new THREE.Face3(Nt[$t].c+Ut,Nt[$t].b+Ut,Nt[$t].a+Ut)),ut.faceVertexUvs[0].push([Gt,Yt,Zt])}var en=ut.vertices.length;ut.vertices.push(new THREE.Vertex(new THREE.Vector3(nt.x,nt.y,r))),ut.vertices.push(new THREE.Vertex(new THREE.Vector3(nt.x,nt.y,r+it))),ut.vertices.push(new THREE.Vertex(new THREE.Vector3(rt.x,rt.y,r))),ut.vertices.push(new THREE.Vertex(new THREE.Vector3(rt.x,rt.y,r+st))),ut.faces.push(new THREE.Face3(zt,Wt,en+1)),ut.faces.push(new THREE.Face3(Vt,Xt,en+3));for(var tn=0;tn<lt.length;tn++){var nn=lt[tn].id,rn=lt[(tn+1)%lt.length].id;ut.faces.push(new THREE.Face3(nn,rn,nn+Ut)),ut.faces.push(new THREE.Face3(rn,rn+Ut,nn+Ut))}for(var sn=0;sn<ct.length;sn++)for(var tn=0;tn<ct[sn].length;tn++){var nn=ct[sn][tn].id,rn=ct[sn][(tn+1)%lt.length].id;ut.faces.push(new THREE.Face3(nn,rn,nn+Ut)),ut.faces.push(new THREE.Face3(rn,rn+Ut,nn+Ut))}ut.computeFaceNormals();var on=new THREE.Mesh(ut,h);on.castShadow=!0,on.receiveShadow=!0,W.add(on)}v.add(z),v.add(W),o.buildingProperties.floor[t].Object3D=v,o.buildingProperties.floor[t].nodeGroup=m,o.buildingProperties.floor[t].lineGroup=z,o.buildingProperties.floor[t].wallGroup=W,o.buildingProperties.Object3D.add(v),r+=a}o.buildingProperties.x_center=(o.buildingProperties.x_max-o.buildingProperties.x_min)/2,o.buildingProperties.y_center=(o.buildingProperties.y_max-o.buildingProperties.y_min)/2,o.buildingProperties.size=Math.max(o.buildingProperties.x_center,o.buildingProperties.y_center),T.x=o.buildingProperties.x_center,T.y=o.buildingProperties.y_center,T.z=o.buildingProperties.z_max/2,o.show3D(35*Math.PI/180,30*Math.PI/180,10,new THREE.Vector3(T.x,T.y,T.z))};this.loadFloorPlan=function(e){$.ajax({url:e,context:o,success:function(e){P(e)},dataType:"xml",async:!1})};var H=function(e,r){for(var i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(s.nodeType!=n)continue;var u=s.getAttribute("id"),a=new Object;a.x=Number(s.getAttribute("x")),a.y=Number(s.getAttribute("y")),a.z=Number(s.hasAttribute("z")?s.getAttribute("z"):r),a.neighbour=new Array,C[u]=a,t==o.buildingProperties.x_min?(o.buildingProperties.x_min=a.x,o.buildingProperties.x_max=a.x,o.buildingProperties.y_min=a.y,o.buildingProperties.y_max=a.y,o.buildingProperties.z_min=a.z,o.buildingProperties.z_max=a.z):(o.buildingProperties.x_min>a.x&&(o.buildingProperties.x_min=a.x),o.buildingProperties.x_max<a.x&&(o.buildingProperties.x_max=a.x),o.buildingProperties.y_min>a.y&&(o.buildingProperties.y_min=a.y),o.buildingProperties.y_max<a.y&&(o.buildingProperties.y_max=a.y),o.buildingProperties.z_min>a.z&&(o.buildingProperties.z_min=a.z),o.buildingProperties.z_max<a.z&&(o.buildingProperties.z_max=a.z))}},B=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(r.nodeType!=n)continue;var i=new Object;i.start=r.getAttribute("start"),i.startVertex=new Array,i.startOffset=Number(r.getAttribute("startoffset")),i.end=r.getAttribute("end"),i.endVertex=new Array,i.endOffset=Number(r.getAttribute("endoffset")),i.thickness=Number(r.getAttribute("thickness")),i.texture=r.getAttribute("texture"),i.texture||(i.texture=0),i.holes=new Array;for(var s=0;s<r.childNodes.length;s++){var o=r.childNodes[s];if(o.nodeType!=n)continue;var u=new Object;u.id=o.getAttribute("id"),u.distance=Number(o.getAttribute("distance")),u.width=Number(o.getAttribute("width")),u.paparet=Number(o.getAttribute("paparet")),u.lintel=Number(o.getAttribute("lintel")),i.holes.push(u)}k[k.length]=i}},j=function(e,t){L[t]=new Array;for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(i.nodeType!=n)continue;var s=new Object;s.name=i.getAttribute("name"),s.zones=new Array,s.center={x:0,y:0};var o=0,u={},a={};for(var f=0;f<i.childNodes.length;f++){var l=i.childNodes[f];if(l.nodeType!=n)continue;var c=new Object;c.onclick=l.getAttribute("onclick"),c.name=l.getAttribute("name"),c.corners=new Array;for(var h=0;h<l.childNodes.length;h++){var p=l.childNodes[h];if(p.nodeType!=n)continue;var d=p.getAttribute("nodeid");c.corners.push(d);var v=C[d].x,m=C[d].y;s.center.x+=v,s.center.y+=m;if(v<u.x||!u.x)u.x=v;if(m<u.y||!u.y)u.y=m;if(v>a.x||!a.x)a.x=v;if(m>a.y||!a.y)a.y=m;o++}s.zones.push(c)}s.center.x/=o,s.center.y/=o;var g=Math.sqrt((s.center.x-u.x)*(s.center.x-u.x)+(s.center.y-u.y)*(s.center.y-u.y)),y=Math.sqrt((s.center.x-a.x)*(s.center.x-a.x)+(s.center.y-a.y)*(s.center.y-a.y));s.size=g<y?y:g,L[t].push(s)}},F=function(e){return};this.render=function(){m.render(d,v)},this.setState=function(e,t,n){switch(e){case"showWireframe":h.wireframe=t;break;case"fillColor":h.color.setHex(parseInt(t,16));break;case"showFloor":t=parseInt(t)}E[e]=t,n&&R()},this.getState=function(e){return E[e]},this.resize=function(e,t,n){arguments.length===2||arguments.length===3?(u=e,a=t):(u=i.find("canvas").width(),a=i.find("canvas").height(),n=e),ASPECT=u/a,m.setSize(u,a),v.aspect=ASPECT,n&&R()},this.hideFloor=function(e,t){THREE.SceneUtils.traverseHierarchy(o.buildingProperties.floor[e].wallGroup,function(e){e.visible=t})},this.show3D=function(e,t,n,r){E.currentAzimut=e,E.currentElevation=t,E.currentDistance=n,E.currentTarget=r.clone(),A&&I(this,this.buildingProperties.Object3D),R()},this.moveTo=function(n,i,s,o,u,a,f,l){function p(){return h.azimut=(i-E.currentAzimut)/c,h.elevation=(s-E.currentElevation)/c,h.distance=(o-E.currentDistance)/c,h.target.sub(u,E.currentTarget),h.target.multiplyScalar(1/c),Math.abs(h.azimut*c)<1e-5&&Math.abs(h.elevation*c)<1e-5&&Math.abs(h.distance*c)<1e-4&&Math.abs(h.target.x*c)<1e-4&&Math.abs(h.target.y*c)<1e-4&&Math.abs(h.target.z*c)<1e-4}function g(){r.inAnimation=!0;var t=!0;(E.currentAzimut+h.azimut)*h.azimut<i*h.azimut?(E.currentAzimut+=h.azimut,t=!1):E.currentAzimut=i,(E.currentElevation+h.elevation)*h.elevation<s*h.elevation?(E.currentElevation+=h.elevation,t=!1):E.currentElevation=s,(E.currentDistance+h.distance)*h.distance<o*h.distance?(E.currentDistance+=h.distance,t=!1):E.currentDistance=o,(E.currentTarget.x+h.target.x)*h.target.x<u.x*h.target.x?(E.currentTarget.x+=h.target.x,t=!1):E.currentTarget.x=u.x,(E.currentTarget.y+h.target.y)*h.target.y<u.y*h.target.y?(E.currentTarget.y+=h.target.y,t=!1):E.currentTarget.y=u.y,(E.currentTarget.z+h.target.z)*h.target.z<u.z*h.target.z?(E.currentTarget.z+=h.target.z,t=!1):E.currentTarget.z=u.z,q(E.currentAzimut,E.currentElevation,E.currentDistance,E.currentTarget),m.render(d,v),a&&a(),t?(r.inAnimation=!1,f&&f()):e.requestAnimationFrame(g)}A&&I(this.buildingProperties.Object3D);var c=l==t||!l?1:100,h={azimut:0,elevation:0,distance:0,target:new THREE.Vector3};p(),r.inAnimation||g()},this.moveToRoom=function(e,n,r,i,s,u){var a=new THREE.Vector3,l;typeof e=="string"&&(e=this.buildingProperties.floorNames[e]);if(e in this.buildingProperties.floor){n?(a.x=n.center.x,a.y=n.center.y,l=n.size/Math.tan(f*Math.PI/180/2)):(a.x=this.buildingProperties.x_center,a.y=this.buildingProperties.y_center,l=this.buildingProperties.size/Math.tan(f*Math.PI/180/2)),a.z=this.buildingProperties.floor[e].heightOfGround+this.buildingProperties.floor[e].height/2;if(r){var c=e<E.showFloor?e:E.showFloor,h=e<E.showFloor?E.showFloor:e,p=o.buildingProperties.floor.length-1;for(;p>=0;p--)o.hideFloor(p,c<=p&&p<=h)}return this.moveTo(e,E.currentAzimut,E.currentElevation,l,a,s,function(){if(r){var n=o.buildingProperties.floor.length-1;for(;n>=0;n--)o.hideFloor(n,n==e)}o.render(),u!==t&&u()},i),E.showFloor=e,a}return a},this.selectRoom=function(e,t){var n=L[t];for(var r in n){var i=n[r];for(var s in i.zones)if(U(e,i.zones[s]))return{room:n[r],zone:i.zones[s]}}return{}},this.sceen2building=function(e,t,n){var r=new THREE.Vector3(e/u*2-1,-(t/a)*2+1,.5);l.unprojectVector(r,v);var i=r.subSelf(v.position).normalize(),s=(n-v.position.z)/i.z;return new THREE.Vector3(v.position.x+s*i.x,v.position.y+s*i.y,v.position.z+s*i.z)},this.building2screen=function(e){var t=e.clone();return l.projectVector(t,v),{x:(t.x+1)/2*u,y:-(t.y-1)/2*a}},this.translateMouseEvent=function(e){var t=e.data.JSFloorPlan3D,n=t.buildingProperties.floor[E.showFloor],r=n.heightOfGround+n.height,i=t.sceen2building(e.offsetX,e.offsetY,r);e.room=t.selectRoom(i,E.showFloor),e.data.callback&&e.data.callback(e)},typeof s=="string"&&this.loadFloorPlan(s)};e.JSFloorPlan3D=r})(window),window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}());