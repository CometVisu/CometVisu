!function(){var e={dependsOn:{"qx.Class":{usage:"dynamic",require:!0},"cv.ui.structure.pure.AbstractWidget":{require:!0},"cv.ui.common.Refresh":{require:!0},"cv.ui.common.Update":{require:!0},"cv.ui.common.Operate":{require:!0},"cv.parser.pure.WidgetParser":{defer:"runtime"},"qx.util.Uri":{},"qx.event.Timer":{},"qx.event.message.Bus":{},"cv.Config":{},"cv.util.String":{},"cv.ui.PopupHandler":{},"cv.util.Tree":{},"qx.event.Registration":{},"cv.data.Model":{},"cv.io.BackendConnections":{},"cv.Transform":{},"qx.io.request.Xhr":{},"qx.util.ResourceManager":{},"qx.dom.Element":{},"cv.util.ScriptLoader":{defer:"runtime"},"cv.ui.structure.WidgetFactory":{defer:"runtime"}}};qx.Bootstrap.executePendingDefers(e);qx.Class.define("cv.plugins.RssLog",{extend:cv.ui.structure.pure.AbstractWidget,include:[cv.ui.common.Refresh,cv.ui.common.Update,cv.ui.common.Operate],properties:{src:{check:"String",nullable:!0,transform:"normalizeUrl",apply:"_applySrc"},database:{check:"String",nullable:!0},delay:{check:"Number",init:0},filter:{check:"String",nullable:!0},datetime:{check:"Boolean",init:!0},mode:{check:"String",init:"last"},limit:{check:"Number",init:0},timeformat:{check:"String",nullable:!0},itemoffset:{check:"Number",init:0},itemack:{check:["modify","display","disable"],init:"modify"},future:{check:"String",nullable:!0},width:{check:"String",nullable:!0},height:{check:"String",nullable:!0}},statics:{parse:function(e,t,s,i){var r=cv.parser.pure.WidgetParser.parseElement(this,e,t,s,i,this.getAttributeToPropertyMappings());cv.parser.pure.WidgetParser.parseFormat(e,t);cv.parser.pure.WidgetParser.parseAddress(e,t);cv.parser.pure.WidgetParser.parseRefresh(e,t);return r},getAttributeToPropertyMappings:function(){return{src:{},database:{},delay:{default:0,transform:parseInt},width:{},height:{},filter:{},datetime:{default:!0,transform:function(e){return"boolean"==typeof e?e:"true"===e}},mode:{default:"last"},limit:{default:0,transform:parseFloat},timeformat:{},itemack:{default:"modify"},future:{},query:{}}}},members:{__P_15_0:null,__P_15_1:null,__P_15_2:null,__P_15_3:null,__P_15_4:!1,__P_15_5:null,__P_15_6:null,__P_15_7:null,__P_15_8:null,normalizeUrl:function(e){this.__P_15_3={};if(e&&e.indexOf("?")>0){var t=qx.util.Uri.parseUri(e);e=e.substring(0,e.indexOf("?"));this.__P_15_3=t.queryKey}this.getDatabase()&&(this.__P_15_3.database=this.getDatabase());return e},_applySrc:function(e){e.match(/rsslog_mysql\.php/)&&this.error("Use of rsslog_mysql.php is depreciated. Please consult the documentation.");this.__P_15_4=!e.match(/rsslog\.php/)&&!e.match(/rsslog_mysql\.php/)&&!e.match(/rsslog_oh\.php/)},_getInnerDomString:function(){var e="";this.getWidth()&&(e+="width:"+this.getWidth()+";");this.getHeight()&&(e+="height:"+this.getHeight());return'<div class="actor rsslogBody"><div class="rsslog_inline" id="rss_'+this.getPath()+'" style="'+e+'"></div></div>'},_setupRefreshAction:function(){var e=this;this._timer=new qx.event.Timer(this.getRefresh());this._timer.addListener("interval",(function(){e.refreshRSSlog()}));this._timer.start()},_onDomReady:function(){if(!this.$$domReady){cv.plugins.RssLog.superclass.prototype._onDomReady.call(this);qx.event.message.Bus.subscribe("path."+this.getParentPage().getPath()+".beforePageChange",this.refreshRSSlog,this);this.__P_15_1='<span class="mappedValue"></span><span>{text}</span>';this.getDatetime()&&(this.__P_15_1="{date}: "+this.__P_15_1);this.__P_15_2="li";cv.Config.currentPageId===this.getParentPage().getPath()&&this.refreshRSSlog()}},_update:function(){var e=this;setTimeout((function(){return e.refreshRSSlog()}),this.getDelay())},_action:function(){var e=cv.util.String.htmlStringToDomElement('<div class="rsslog_popup" id="rss_'+this.getPath()+'_big"/>'),t=document.querySelector("#"+this.getPath()+" .label"),s=t&&t.innerText||"",i=cv.ui.PopupHandler.showPopup("rsslog",{title:s,content:e}),r=cv.util.Tree.getParent(e,"div",null,1)[0];Object.entries({height:"90%",width:"90%",margin:"auto"}).forEach((function(e){r.style[e[0]]=e[1]}));this._timer&&this._timer.stop();qx.event.Registration.addListener(e,"tap",(function(e){e.stopPropagation()}),this);qx.event.Registration.addListener(i,"close",(function(){if(i.getCurrentDomElement()&&i.getCurrentDomElement().classList.contains("popup")&&"modify"===this.getItemack()){qx.event.Timer.once((function(){this.refreshRSSlog()}),this,100);var e;for(var t in this.getAddress()){e=this.getAddress()[t];cv.data.Model.isWriteAddress(e)&&cv.io.BackendConnections.getClient(e.backendType).write(t,cv.Transform.encode(this.getAddress()[t],0))}}}),this);i.getCurrentDomElement().querySelector(".main").style.overflow="auto";this.refreshRSSlog(!0)},refreshRSSlog:function(e){if(this.getSrc()){this.__P_15_0||(this.__P_15_4?this.error("external sources are no longer supported"):this.__P_15_9());this.__P_15_0.setUserData("big",e);this.__P_15_0 instanceof qx.io.request.Xhr&&this.__P_15_0.send();var t=this.getRefresh();void 0!==t&&t&&this._timer&&this._timer.isEnabled()&&this._timer.start()}else this.error("no src given, aborting RSS-Log refresh")},__P_15_9:function(){var e=this,t=this.getSrc(),s=Object.assign({},this.__P_15_3);this.getFilter()&&(s.f=this.getFilter());this.getLimit()&&(s.limit=this.getLimit());this.getFuture()&&(s.future=this.getFuture());s.j=1;this.__P_15_0=new qx.io.request.Xhr(qx.util.ResourceManager.getInstance().toUri(t));this.__P_15_0.set({accept:"application/json",requestData:s,method:"GET"});this.__P_15_0.addListener("success",this.__P_15_10,this);this.__P_15_0.addListener("error",(function(s){e.error("C: #rss_%s, Error: %s, Feed: %s",e.getPath(),s.getTarget().getResponse(),t)}))},__P_15_11:function(e,t){t.replaceChildren();t.appendChild(e);var s=parseInt(t.dataset.last_rowcount,10)||0;e.innerHTML='<li class="rsslogRow odd" id="dummydiv">.</li>';var i=t.querySelector("#dummydiv"),r=i.getBoundingClientRect(),a=Math.round(r.bottom-r.top);i.parentNode.removeChild(i);if(0!==a){var n=t.parentNode.parentNode,o=n.getBoundingClientRect(),_=Math.round(o.bottom-o.top),l=n.querySelector(".label");if(l){var c=l.getBoundingClientRect();_-=Math.round(c.bottom-c.top)}s=Math.floor(_/a)}t.dataset.last_rowcount=s;return s},__P_15_10:function(e){var t=e.getTarget().getResponse();if("string"!=typeof t)this.__P_15_12(t.responseData.feed.entries);else{this.error("Expected JSON, but got response MIME:",e.getTarget().getResponseContentType());this.error(t)}},__P_15_12:function(e){var t=this.__P_15_0.getUserData("big"),s="#rss_"+this.getPath()+(!0===t?"_big":""),i=document.querySelector(s),r=!0===t?this.getItemack():"modify"===this.getItemack()?"display":this.getItemack();this.debug("ID: "+i.getAttribute("id")+", Feed: "+this.getSrc());var a=document.createElement("ul"),n=this.__P_15_11(a,i),o=e.length;this.debug("C: #"+this.getPath()+", "+o+" element(s) found, "+n+" displayrow(s) available");var _=0;if(o>n){"first"===this.getMode()&&(_=o-n);if("rollover"===this.getMode()){(_=parseInt(i.dataset.itemoffset,10)||0)===o&&(_=0);i.dataset.itemoffset=_+1}}var l="rsslogodd",c=_+n;c=c>o?o:c;this.__P_15_5=(new Date).strftime("%d");this.__P_15_6=!1;this.__P_15_8=!1;this.__P_15_7=!1;for(var d=_;d<c;d++){this.debug("C: #"+this.getPath()+", processing item: "+d+" of "+o);var g=d,h=e[g=d>=o?g-=o:g],u=this.__P_15_13(h,t),p=qx.dom.Element.create("li",{class:"rsslogRow "+l});p.innerHTML=u;if(h.mapping&&""!==h.mapping){var m=this.applyMapping("disable"===r?0:h.state,h.mapping),f=p.querySelector(".mappedValue");this.defaultValue2DOM(m,f)}if(this.__P_15_6&&0!==g){p.classList.add("rsslog_separator");this.__P_15_8=!0}else this.__P_15_8=!1;!0===this.__P_15_8&&p.classList.add("rsslog_prevday");this.__P_15_7&&p.classList.add("rsslogodd"===l?"rsslog_futureeven":"rsslog_futureodd");p.dataset.id=h.id;p.dataset.mapping=h.mapping;if(h.tags){var v=p.querySelector("span");if(Array.isArray(h.tags)){h.tags.filter((function(e){return""!==e})).length>0&&v.classList.add.apply(v.classList,h.tags)}else v.classList.add(h.tags)}"1"===h.state&&"disable"!==r&&p.classList.add("rsslog_ack");"modify"===r&&qx.event.Registration.addListener(p,"tap",this._onTap,this);a.appendChild(p);l="rsslogodd"===l?"rsslogeven":"rsslogodd"}},__P_15_13:function(e,t){var s="";if(this.__P_15_4)return t?'<b><a href="'+e.getLink()+'">'+e.getTitle()+"</a></b><br/>"+e.getDescription():"<b>"+e.getTitle()+"</b><br/>"+e.getDescription();s=(s=this.__P_15_1).replace(/\{text\}/,e.content);var i=new Date(e.publishedDate);if(i){s=this.getTimeformat()?s.replace(/\{date\}/,i.strftime(this.getTimeformat())+"&nbsp;"):s.replace(/\{date\}/,i.toLocaleDateString()+" "+i.toLocaleTimeString()+"&nbsp;");var r=i.strftime("%d");this.__P_15_6=this.__P_15_5>0&&this.__P_15_5!==r;this.__P_15_5=r;this.__P_15_7=i>new Date}else s=s.replace(/\{date\}/,"");return s},_onTap:function(e){var t=e.getCurrentTarget(),s=t.dataset.id,i=t.dataset.mapping;t.classList.toggle("rsslog_ack");var r=+t.classList.contains("rsslog_ack");if(i&&""!==i){var a=this.applyMapping(r,i),n=t.querySelector(".mappedValue");n.replaceChildren();this.defaultValue2DOM(a,n)}var o=new qx.io.request.Xhr(this.__P_15_0.getUrl());o.set({method:"GET",requestData:Object.assign({},this.__P_15_3,{u:s,state:r}),accept:"application/json"});o.send()}},defer:function(e){cv.util.ScriptLoader.getInstance().addStyles("plugins/rsslog/rsslog.css");cv.parser.pure.WidgetParser.addHandler("rsslog",cv.plugins.RssLog);cv.ui.structure.WidgetFactory.registerClass("rsslog",e)}});cv.plugins.RssLog.$$dbClassInfo=e}();qx.$$packageData[12]={locales:{},resources:{},translations:{}};
//# sourceMappingURL=package-12.js.map