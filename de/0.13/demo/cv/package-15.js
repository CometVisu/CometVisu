!function(){var e={dependsOn:{"qx.Class":{usage:"dynamic",require:!0},"cv.ui.structure.AbstractWidget":{construct:!0,require:!0},"cv.ui.common.Refresh":{require:!0},"cv.ui.common.Update":{require:!0},"cv.parser.WidgetParser":{defer:"runtime"},"qx.event.Timer":{},"cv.IconHandler":{},"cv.core.notifications.Router":{},"qx.locale.Manager":{},"cv.util.ScriptLoader":{defer:"runtime"},"cv.ui.structure.WidgetFactory":{defer:"runtime"}}};qx.Bootstrap.executePendingDefers(e);qx.Class.define("cv.plugins.tr064.CallList",{extend:cv.ui.structure.AbstractWidget,include:[cv.ui.common.Refresh,cv.ui.common.Update],construct:function(e){var t=this;cv.ui.structure.AbstractWidget.constructor.call(this,e);this.__P_22_0={};this.addListenerOnce("domReady",function(){t.refreshCalllist("initial")})},statics:{parse:function(e,t,r,n){var i=cv.parser.WidgetParser.parseElement(this,e,t,r,n,this.getAttributeToPropertyMappings());cv.parser.WidgetParser.parseFormat(e,t);cv.parser.WidgetParser.parseAddress(e,t);cv.parser.WidgetParser.parseRefresh(e,t);return i},getAttributeToPropertyMappings:function(){return{device:{},max:{transform:function(e){return+e}},columns:{default:"type;date;nameOrCaller;tam"},TAM:{default:"phone_answering"},TAMColor:{default:""},TAMwait:{default:"control_reload"},TAMwaitColor:{default:""},TAMplay:{default:"audio_play"},TAMplayColor:{default:""},TAMstop:{default:"phone_answering"},TAMstopColor:{default:""},typeIncoming:{default:"phone_call_in"},typeIncomingColor:{default:""},typeMissed:{default:"phone_missed_in"},typeMissedColor:{default:""},typeOutgoing:{default:"phone_call_out"},typeOutgoingColor:{default:""},typeActiveIncoming:{default:"phone_ring_in"},typeActiveIncomingColor:{default:""},typeRejectedIncoming:{default:"phone_call_end_in"},typeRejectedIncomingColor:{default:""},typeActiveOutgoing:{default:"phone_ring_out"},typeActiveOutgoingColor:{default:""},typeUnknown:{default:"text_question_mark"},typeUnknownColor:{default:""}}}},events:{tr064ListRefreshed:"qx.event.type.Event"},properties:{device:{check:"String",init:""},max:{check:"Number",init:0},columns:{check:"String"},TAM:{check:"String"},TAMColor:{check:"String"},TAMwait:{check:"String"},TAMwaitColor:{check:"String"},TAMplay:{check:"String"},TAMplayColor:{check:"String"},TAMstop:{check:"String"},TAMstopColor:{check:"String"},typeIncoming:{check:"String"},typeIncomingColor:{check:"String"},typeMissed:{check:"String"},typeMissedColor:{check:"String"},typeOutgoing:{check:"String"},typeOutgoingColor:{check:"String"},typeActiveIncoming:{check:"String"},typeActiveIncomingColor:{check:"String"},typeRejectedIncoming:{check:"String"},typeRejectedIncomingColor:{check:"String"},typeActiveOutgoing:{check:"String"},typeActiveOutgoingColor:{check:"String"},typeUnknown:{check:"String"},typeUnknownColor:{check:"String"}},members:{__P_22_1:"",__P_22_2:void 0,__P_22_3:!1,__P_22_0:null,_getInnerDomString:function(){return'<div class="actor"><table class="TR064_calllist"><tr><td>Loading TR-064...</td></tr></table></div>'},_setupRefreshAction:function(){this._timer=new qx.event.Timer(this.getRefresh());this._timer.addListener("interval",function(){this.__P_22_3||this.refreshCalllist("timer")},this);this._timer.start()},_update:function(e,t){this.__P_22_3||this.refreshCalllist("update")},_displayCalllist:function(){var e=this,t=this.getDomElement().getElementsByClassName("TR064_calllist")[0],r=this.__P_22_1?this.__P_22_1.replace(/.*sid=/,""):"",n="",i={0:{name:this.getTypeUnknown(),color:this.getTypeUnknownColor()},1:{name:this.getTypeIncoming(),color:this.getTypeIncomingColor()},2:{name:this.getTypeMissed(),color:this.getTypeMissedColor()},3:{name:this.getTypeOutgoing(),color:this.getTypeOutgoingColor()},9:{name:this.getTypeActiveIncoming(),color:this.getTypeActiveIncomingColor()},10:{name:this.getTypeRejectedIncoming(),color:this.getTypeRejectedIncomingColor()},11:{name:this.getTypeActiveOutgoing(),color:this.getTypeActiveOutgoingColor()}};this.__P_22_2.forEach(function(t){var o="",c=t.Type in i?i[t.Type]:i[0];t.Path&&(o='<audio preload="none"><source src="resource/plugins/tr064/proxy.php?device='+e.getDevice()+"&uri="+t.Path+"%26sid="+r+'"></audio><div class="tam clickable">'+cv.IconHandler.getInstance().getIconElement(e.getTAM(),"*","*",e.getTAMColor(),"","",!0)+"</div>");n+="<tr>";e.getColumns().split(";").forEach(function(e){switch(e){case"type":n+="<td>"+cv.IconHandler.getInstance().getIconElement(c.name,"*","*",c.color,"","",!0)+"</td>";break;case"date":n+="<td>"+t.Date+"</td>";break;case"name":n+="<td>"+t.Name+"</td>";break;case"caller":n+="<td>"+t.Caller+"</td>";break;case"nameOrCaller":""!==t.Name?n+="<td>"+t.Name+"</td>":n+="<td>"+t.Caller+"</td>";break;case"tam":n+="<td>"+o+"</td>"}});n+="</tr>"});t.innerHTML=n;for(var o=t.getElementsByClassName("tam"),c=0;c<o.length;c++)o[c].addEventListener("click",function(){e.__P_22_4(this)})},_getCallListURI:function(){var e=this,t="resource/plugins/tr064/soap.php?device="+this.getDevice()+"&location=upnp/control/x_contact&uri=urn:dslforum-org:service:X_AVM-DE_OnTel:1&fn=GetCallList";window.fetch(t).then(function(t){if(t.ok)return t.json();cv.core.notifications.Router.dispatchMessage("cv.tr064.error",{title:qx.locale.Manager.tr("TR-064 communication error"),severity:"urgent",message:qx.locale.Manager.tr('Reading URL "%1" failed with status "%2": "%2"',t.url,t.status,t.statusText)});e.__P_22_1="<fail>";return null}).then(function(r){if("string"==typeof r){e.__P_22_1=r;e.refreshCalllist("getCallListURI")}else{cv.core.notifications.Router.dispatchMessage("cv.tr064.error",{title:qx.locale.Manager.tr("TR-064 communication response error"),severity:"urgent",message:qx.locale.Manager.tr('Reading URL "%1" failed with content: "%2"',t,JSON.stringify(r))});e.__P_22_1="<fail>"}})},refreshCalllist:function(e){this.__P_22_3=!0;if("<fail>"!==this.__P_22_1)if(""!==this.__P_22_1){var t=this,r="resource/plugins/tr064/proxy.php?device="+this.getDevice()+"&uri="+this.__P_22_1+"%26max="+this.getMax();window.fetch(r).then(function(e){if(e.ok)return e.text();cv.core.notifications.Router.dispatchMessage("cv.tr064.error",{title:qx.locale.Manager.tr("TR-064 communication error"),severity:"urgent",message:qx.locale.Manager.tr('Reading URL "%1" failed with status "%2": "%2"',e.url,e.status,e.statusText)});return"<xml/>"}).then(function(e){return(new window.DOMParser).parseFromString(e,"text/xml")}).then(function(e){t.__P_22_2=[];for(var r=e.getElementsByTagName("Call"),n=0;n<r.length;n++){for(var i=r[n].children,o={},c=0;c<i.length;c++)o[i[c].nodeName]=i[c].textContent;t.__P_22_2.push(o)}t._displayCalllist();t.__P_22_3=!1;t.fireEvent("tr064ListRefreshed")}).catch(function(e){cv.core.notifications.Router.dispatchMessage("cv.tr064.error",{title:qx.locale.Manager.tr("TR-064 communication error"),severity:"urgent",message:qx.locale.Manager.tr('refreshCalllist() error: "%1"',JSON.stringify(e))});t.error("TR-064 refreshCalllist() error:",e)})}else this._getCallListURI()},__P_22_4:function(e){var t=this,r=e.previousElementSibling;if(!this.__P_22_0[r]){r.addEventListener("ended",function(){t.__P_22_5(e)});this.__P_22_0[r]=!0}r.readyState<4&&this.__P_22_6(e);if(r.paused){var n=r.play();void 0!==n&&n.then(function(){t.__P_22_7(e)}).catch(function(){})}else{r.pause();r.currentTime=0;this.__P_22_5(e)}},__P_22_6:function(e){e.innerHTML=cv.IconHandler.getInstance().getIconElement(this.getTAMwait(),"*","*",this.getTAMwaitColor(),"","",!0)},__P_22_7:function(e){e.innerHTML=cv.IconHandler.getInstance().getIconElement(this.getTAMplay(),"*","*",this.getTAMplayColor(),"","",!0)},__P_22_5:function(e){e.innerHTML=cv.IconHandler.getInstance().getIconElement(this.getTAMstop(),"*","*",this.getTAMstopColor(),"","",!0)}},defer:function(e){cv.util.ScriptLoader.getInstance().addStyles("plugins/tr064/tr064.css");cv.parser.WidgetParser.addHandler("calllist",cv.plugins.tr064.CallList);cv.ui.structure.WidgetFactory.registerClass("calllist",e)}});cv.plugins.tr064.CallList.$$dbClassInfo=e}();qx.$$packageData[15]={locales:{},resources:{},translations:{en:{},de:{"TR-064 communication error":"TR-064 Kommunikations-Fehler",'Reading URL "%1" failed with status "%2": "%2"':'Lesen der URL "%1" mit Status "%2" fehlgeschlagen: "%2"',"TR-064 communication response error":"TR-064 Kommunikation-Antwort-Fehler",'Reading URL "%1" failed with content: "%2"':'Lesen der URL  "%1" nicht mÃ¶glich. Inhalt: "%2"','refreshCalllist() error: "%1"':'refreshCalllist() Fehler: "%1"'}}};
//# sourceMappingURL=package-15.js.map