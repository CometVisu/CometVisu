!function(){var e={dependsOn:{"qx.Class":{usage:"dynamic",require:!0},"cv.ui.structure.AbstractWidget":{require:!0},"cv.ui.common.Refresh":{require:!0},"cv.ui.common.Update":{require:!0},"cv.ui.common.Operate":{require:!0},"cv.parser.WidgetParser":{defer:"runtime"},"qx.util.Uri":{},"qx.event.Timer":{},"qx.event.message.Bus":{},"cv.Config":{},"cv.util.String":{},"cv.ui.PopupHandler":{},"cv.util.Tree":{},"qx.event.Registration":{},"cv.data.Model":{},"cv.TemplateEngine":{},"cv.Transform":{},"qx.io.request.Xhr":{},"qx.data.store.Yql":{},"qx.util.ResourceManager":{},"qx.dom.Element":{},"cv.util.ScriptLoader":{defer:"runtime"},"cv.ui.structure.WidgetFactory":{defer:"runtime"}}};qx.Bootstrap.executePendingDefers(e);qx.Class.define("cv.plugins.RssLog",{extend:cv.ui.structure.AbstractWidget,include:[cv.ui.common.Refresh,cv.ui.common.Update,cv.ui.common.Operate],properties:{src:{check:"String",nullable:!0,transform:"normalizeUrl",apply:"_applySrc"},filter:{check:"String",nullable:!0},datetime:{check:"Boolean",init:!0},mode:{check:"String",init:"last"},limit:{check:"Number",init:0},timeformat:{check:"String",nullable:!0},itemoffset:{check:"Number",init:0},itemack:{check:["modify","display","disable"],init:"modify"},future:{check:"String",nullable:!0},width:{check:"String",nullable:!0},height:{check:"String",nullable:!0},model:{check:"qx.data.Array",nullable:!0,apply:"_applyModel"}},statics:{parse:function(e,t,s,r){var i=cv.parser.WidgetParser.parseElement(this,e,t,s,r,this.getAttributeToPropertyMappings());cv.parser.WidgetParser.parseFormat(e,t);cv.parser.WidgetParser.parseAddress(e,t);cv.parser.WidgetParser.parseRefresh(e,t);return i},getAttributeToPropertyMappings:function(){return{src:{},width:{},height:{},filter:{},datetime:{default:!0,transform:function(e){return"boolean"==typeof e?e:"true"===e}},mode:{default:"last"},limit:{default:0,transform:parseFloat},timeformat:{},itemack:{default:"modify"},future:{},query:{}}}},members:{__request:null,__html:null,__wrapper:null,__fixedRequestData:null,__external:!1,__separatordate:null,__separatoradd:null,__isFuture:null,__separatorprevday:null,normalizeUrl:function(e){this.__fixedRequestData={};if(e&&e.indexOf("?")>0){var t=qx.util.Uri.parseUri(e);e=e.substring(0,e.indexOf("?"));this.__fixedRequestData=t.queryKey}return e},_applySrc:function(e){this.__external=!e.match(/rsslog\.php/)&&!e.match(/rsslog_mysql\.php/)&&!e.match(/rsslog_oh\.php/)},_getInnerDomString:function(){var e="";this.getWidth()&&(e+="width:"+this.getWidth()+";");this.getHeight()&&(e+="height:"+this.getHeight());return'<div class="actor rsslogBody"><div class="rsslog_inline" id="rss_'+this.getPath()+'" style="'+e+'"></div></div>'},_setupRefreshAction:function(){this._timer=new qx.event.Timer(this.getRefresh());this._timer.addListener("interval",function(){this.refreshRSSlog()},this);this._timer.start()},_onDomReady:function(){if(!this.$$domReady){cv.plugins.RssLog.prototype._onDomReady.base.call(this);qx.event.message.Bus.subscribe("path."+this.getParentPage().getPath()+".beforePageChange",this.refreshRSSlog,this);this.__html='<span class="mappedValue"></span><span>{text}</span>';this.getDatetime()&&(this.__html="{date}: "+this.__html);this.__wrapper="li";cv.Config.currentPageId===this.getParentPage().getPath()&&this.refreshRSSlog()}},_update:function(){this.refreshRSSlog()},_action:function(){var e=cv.util.String.htmlStringToDomElement('<div class="rsslog_popup" id="rss_'+this.getPath()+'_big"/>'),t=document.querySelector("#"+this.getPath()+" .label").innerText||"",s=cv.ui.PopupHandler.showPopup("rsslog",{title:t,content:e}),r=cv.util.Tree.getParent(e,"div",null,1)[0];Object.entries({height:"90%",width:"90%",margin:"auto"}).forEach(function(e){r.style[e[0]]=e[1]});this._timer&&this._timer.stop();qx.event.Registration.addListener(e,"tap",function(e){e.stopPropagation()},this);qx.event.Registration.addListener(s,"close",function(){if(s.getCurrentDomElement()&&s.getCurrentDomElement().classList.contains("popup")&&"modify"===this.getItemack()){qx.event.Timer.once(function(){this.refreshRSSlog()},this,100);for(var e in this.getAddress())cv.data.Model.isWriteAddress(this.getAddress()[e])&&cv.TemplateEngine.getInstance().visu.write(e,cv.Transform.encode(this.getAddress()[e][0],0))}},this);s.getCurrentDomElement().querySelector(".main").style.overflow="auto";this.refreshRSSlog(!0)},refreshRSSlog:function(e){if(this.getSrc()){this.__request||(this.__external?this.__refreshYql():this.__refreshRss());this.__request.setUserData("big",e);this.__request instanceof qx.io.request.Xhr?this.__request.send():this.__request instanceof qx.data.store.Yql&&this.__request.reload();var t=this.getRefresh();void 0!==t&&t&&this._timer&&this._timer.isEnabled()&&this._timer.start()}else this.error("no src given, aborting RSS-Log refresh")},__refreshRss:function(){var e=this.getSrc(),t=Object.assign({},this.__fixedRequestData);this.getFilter()&&(t.f=this.getFilter());this.getLimit()&&(t.limit=this.getLimit());this.getFuture()&&(t.future=this.getFuture());t.j=1;this.__request=new qx.io.request.Xhr(qx.util.ResourceManager.getInstance().toUri(e));this.__request.set({accept:"application/json",requestData:t,method:"GET"});this.__request.addListener("success",this.__updateRssContent,this);this.__request.addListener("error",function(t){this.error("C: #rss_%s, Error: %s, Feed: %s",this.getPath(),t.getTarget().getResponse(),e)},this)},__refreshYql:function(){if(!this.__request){this.__request=new qx.data.store.Yql("SELECT * FROM rss WHERE url='"+this.getSrc()+"'",{manipulateData:function(e){return e.query.results?e.query.results.item||e.query.results.entry:[]}});this.__request.bind("model",this,"model")}},_applyModel:function(e,t){t&&t.removeListener("change",this.__updateYqlContent,this);if(e){this.__updateYqlContent();e.addListener("change",this.__updateYqlContent,this)}},__prepareContentElement:function(e,t){t.innerHTML="";t.appendChild(e);var s=parseInt(t.dataset.last_rowcount,10)||0;e.innerHTML='<li class="rsslogRow odd" id="dummydiv">.</li>';var r=t.querySelector("#dummydiv"),i=r.getBoundingClientRect(),a=Math.round(i.bottom-i.top);r.parentNode.removeChild(r);if(0!==a){var n=t.parentNode.parentNode,o=n.getBoundingClientRect(),l=Math.round(o.bottom-o.top),u=n.querySelector(".label");if(u){var d=u.getBoundingClientRect();l-=Math.round(d.bottom-d.top)}s=Math.floor(l/a)}t.dataset.last_rowcount=s;return s},__updateRssContent:function(e){var t=e.getTarget().getResponse();"string"!=typeof t?this.__updateContent(t.responseData.feed.entries):this.error(t)},__updateYqlContent:function(){this.__updateContent(this.getModel().toArray())},__updateContent:function(e){var t=this.__request.getUserData("big"),s="#rss_"+this.getPath()+(!0===t?"_big":""),r=document.querySelector(s),i=!0===t?this.getItemack():"modify"===this.getItemack()?"display":this.getItemack();this.debug("ID: "+r.getAttribute("id")+", Feed: "+this.getSrc());var a=document.createElement("ul"),n=this.__prepareContentElement(a,r),o=e.length;this.debug("C: #"+this.getPath()+", "+o+" element(s) found, "+n+" displayrow(s) available");var l=0;if(o>n){"first"===this.getMode()&&(l=o-n);if("rollover"===this.getMode()){(l=parseInt(r.dataset.itemoffset,10)||0)===o&&(l=0);r.dataset.itemoffset=l+1}}var u="rsslogodd",d=l+n;d=d>o?o:d;this.__separatordate=(new Date).strftime("%d");this.__separatoradd=!1;this.__separatorprevday=!1;this.__isFuture=!1;for(var h=l;h<d;h++){this.debug("C: #"+this.getPath()+", processing item: "+h+" of "+o);var c=h,g=e[c=h>=o?c-=o:c],p=this.__getItemHtml(g,t),_=qx.dom.Element.create("li",{class:"rsslogRow "+u});_.innerHTML=p;if(g.mapping&&""!==g.mapping){var m=this.applyMapping("disable"===i?0:g.state,g.mapping),f=_.querySelector(".mappedValue"),v=this;this.defaultValue2DOM(m,function(e){v._applyValueToDom(f,e)})}if(this.__separatoradd&&0!==c){_.classList.add("rsslog_separator");this.__separatorprevday=!0}else this.__separatorprevday=!1;!0===this.__separatorprevday&&_.classList.add("rsslog_prevday");this.__isFuture&&_.classList.add("rsslogodd"===u?"rsslog_futureeven":"rsslog_futureodd");_.dataset.id=g.id;_.dataset.mapping=g.mapping;if(g.tags){var q=_.querySelector("span");Array.isArray(g.tags)?q.classList.add.apply(q.classList,g.tags):q.classList.add(g.tags)}"1"===g.state&&"disable"!==i&&_.classList.add("rsslog_ack");"modify"===i&&qx.event.Registration.addListener(_,"tap",this._onTap,this);a.appendChild(_);u="rsslogodd"===u?"rsslogeven":"rsslogodd"}},__getItemHtml:function(e,t){var s="";if(this.__external)return t?'<b><a href="'+e.getLink()+'">'+e.getTitle()+"</a></b><br/>"+e.getDescription():"<b>"+e.getTitle()+"</b><br/>"+e.getDescription();s=(s=this.__html).replace(/\{text\}/,e.content);var r=new Date(e.publishedDate);if(r){s=this.getTimeformat()?s.replace(/\{date\}/,r.strftime(this.getTimeformat())+"&nbsp;"):s.replace(/\{date\}/,r.toLocaleDateString()+" "+r.toLocaleTimeString()+"&nbsp;");var i=r.strftime("%d");this.__separatoradd=this.__separatordate>0&&this.__separatordate!==i;this.__separatordate=i;this.__isFuture=r>new Date}else s=s.replace(/\{date\}/,"");return s},_onTap:function(e){var t=e.getCurrentTarget(),s=t.dataset.id,r=t.dataset.mapping;t.classList.toggle("rsslog_ack");var i=+t.classList.contains("rsslog_ack");if(r&&""!==r){var a=this.applyMapping(i,r),n=t.querySelector(".mappedValue");n.innerHTML="";var o=this;this.defaultValue2DOM(a,function(e){o._applyValueToDom(n,e)})}var l=new qx.io.request.Xhr(this.__request.getUrl());l.set({method:"GET",requestData:Object.assign({},this.__fixedRequestData,{u:s,state:i}),accept:"application/json"});l.send()}},defer:function(e){cv.util.ScriptLoader.getInstance().addStyles("plugins/rsslog/rsslog.css");cv.parser.WidgetParser.addHandler("rsslog",cv.plugins.RssLog);cv.ui.structure.WidgetFactory.registerClass("rsslog",e)}});cv.plugins.RssLog.$$dbClassInfo=e}();
//# sourceMappingURL=part-13.js.map