!function(){var e={dependsOn:{"qx.Class":{usage:"dynamic",require:!0},"cv.ui.structure.AbstractWidget":{require:!0},"cv.ui.common.Refresh":{require:!0},"cv.ui.common.Update":{require:!0},"cv.parser.WidgetParser":{defer:"runtime"},"qx.event.Timer":{},"cv.IconHandler":{},"cv.util.ScriptLoader":{defer:"runtime"},"cv.ui.structure.WidgetFactory":{defer:"runtime"}}};qx.Bootstrap.executePendingDefers(e);qx.Class.define("cv.plugins.tr064.CallList",{extend:cv.ui.structure.AbstractWidget,include:[cv.ui.common.Refresh,cv.ui.common.Update],statics:{parse:function(e,t,i,r){var n=cv.parser.WidgetParser.parseElement(this,e,t,i,r,this.getAttributeToPropertyMappings());cv.parser.WidgetParser.parseFormat(e,t);cv.parser.WidgetParser.parseAddress(e,t);cv.parser.WidgetParser.parseRefresh(e,t);return n},getAttributeToPropertyMappings:function(){return{device:{},max:{transform:function(e){return+e}},columns:{default:"type;date;nameOrCaller;tam"},TAM:{default:"phone_answering"},TAMColor:{default:""},TAMwait:{default:"control_reload"},TAMwaitColor:{default:""},TAMplay:{default:"audio_play"},TAMplayColor:{default:""},TAMstop:{default:"phone_answering"},TAMstopColor:{default:""},typeIncoming:{default:"phone_call_in"},typeIncomingColor:{default:""},typeMissed:{default:"phone_missed_in"},typeMissedColor:{default:""},typeOutgoing:{default:"phone_call_out"},typeOutgoingColor:{default:""},typeActiveIncoming:{default:"phone_ring_in"},typeActiveIncomingColor:{default:""},typeRejectedIncoming:{default:"phone_call_end_in"},typeRejectedIncomingColor:{default:""},typeActiveOutgoing:{default:"phone_ring_out"},typeActiveOutgoingColor:{default:""},typeUnknown:{default:"text_question_mark"},typeUnknownColor:{default:""}}}},events:{tr064ListRefreshed:"qx.event.type.Event"},properties:{device:{check:"String",init:""},max:{check:"Number",init:0},columns:{check:"String"},TAM:{check:"String"},TAMColor:{check:"String"},TAMwait:{check:"String"},TAMwaitColor:{check:"String"},TAMplay:{check:"String"},TAMplayColor:{check:"String"},TAMstop:{check:"String"},TAMstopColor:{check:"String"},typeIncoming:{check:"String"},typeIncomingColor:{check:"String"},typeMissed:{check:"String"},typeMissedColor:{check:"String"},typeOutgoing:{check:"String"},typeOutgoingColor:{check:"String"},typeActiveIncoming:{check:"String"},typeActiveIncomingColor:{check:"String"},typeRejectedIncoming:{check:"String"},typeRejectedIncomingColor:{check:"String"},typeActiveOutgoing:{check:"String"},typeActiveOutgoingColor:{check:"String"},typeUnknown:{check:"String"},typeUnknownColor:{check:"String"}},members:{__calllistUri:"",__calllistList:void 0,__refreshingCalllist:!1,__TAMeventAttached:{},_getInnerDomString:function(){this.refreshCalllist("initial");return'<div class="actor"><table class="TR064_calllist"><tr><td>Loading TR-064...</td></tr></table></div>'},_setupRefreshAction:function(){this._timer=new qx.event.Timer(this.getRefresh());this._timer.addListener("interval",function(){this.__refreshingCalllist||this.refreshCalllist("timer")},this);this._timer.start()},_update:function(e,t){this.__refreshingCalllist||this.refreshCalllist("update")},_displayCalllist:function(){var e=this,t=this.getDomElement().getElementsByClassName("TR064_calllist")[0],i=this.__calllistUri?this.__calllistUri.replace(/.*sid=/,""):"",r="",n={0:{name:this.getTypeUnknown(),color:this.getTypeUnknownColor()},1:{name:this.getTypeIncoming(),color:this.getTypeIncomingColor()},2:{name:this.getTypeMissed(),color:this.getTypeMissedColor()},3:{name:this.getTypeOutgoing(),color:this.getTypeOutgoingColor()},9:{name:this.getTypeActiveIncoming(),color:this.getTypeActiveIncomingColor()},10:{name:this.getTypeRejectedIncoming(),color:this.getTypeRejectedIncomingColor()},11:{name:this.getTypeActiveOutgoing(),color:this.getTypeActiveOutgoingColor()}};this.__calllistList.forEach(function(t){var l="",s=t.Type in n?n[t.Type]:n[0];t.Path&&(l='<audio preload="none"><source src="resource/plugins/tr064/proxy.php?device='+e.getDevice()+"&uri="+t.Path+"%26sid="+i+'"></audio><div class="tam clickable">'+cv.IconHandler.getInstance().getIconText(e.getTAM(),"*","*",e.getTAMColor())+"</div>");r+="<tr>";e.getColumns().split(";").forEach(function(e){switch(e){case"type":r+="<td>"+cv.IconHandler.getInstance().getIconText(s.name,"*","*",s.color)+"</td>";break;case"date":r+="<td>"+t.Date+"</td>";break;case"name":r+="<td>"+t.Name+"</td>";break;case"caller":r+="<td>"+t.Caller+"</td>";break;case"nameOrCaller":""!==t.Name?r+="<td>"+t.Name+"</td>":r+="<td>"+t.Caller+"</td>";break;case"tam":r+="<td>"+l+"</td>"}});r+="</tr>"});t.innerHTML=r;for(var l=t.getElementsByClassName("tam"),s=0;s<l.length;s++)l[s].addEventListener("click",function(){e.__playTAM(this)})},_getCallListURI:function(){var e=this,t="resource/plugins/tr064/soap.php?device="+this.getDevice()+"&location=upnp/control/x_contact&uri=urn:dslforum-org:service:X_AVM-DE_OnTel:1&fn=GetCallList";window.fetch(t).then(function(t){if(t.ok)return t.json();console.error('Error: reading URL "'+t.url+" failed with status "+t.status+": "+t.statusText);e.__calllistUri="<fail>"}).then(function(i){if("string"==typeof i){e.__calllistUri=i;e.refreshCalllist("getCallListURI")}else{console.error('Error: reading URL "'+t+" failed with content:",i);e.__calllistUri="<fail>"}})},refreshCalllist:function(e){this.__refreshingCalllist=!0;if("<fail>"!==this.__calllistUri)if(""!==this.__calllistUri){var t=this,i="resource/plugins/tr064/proxy.php?device="+this.getDevice()+"&uri="+this.__calllistUri+"%26max="+this.getMax();window.fetch(i).then(function(e){if(e.ok)return e.text();console.error('Error: reading URL "'+e.url+" failed with status "+e.status+": "+e.statusText);return"<xml/>"}).then(function(e){return(new window.DOMParser).parseFromString(e,"text/xml")}).then(function(e){t.__calllistList=[];for(var i=e.getElementsByTagName("Call"),r=0;r<i.length;r++){for(var n=i[r].children,l={},s=0;s<n.length;s++)l[n[s].nodeName]=n[s].textContent;t.__calllistList.push(l)}t._displayCalllist();t.__refreshingCalllist=!1;t.fireEvent("tr064ListRefreshed")}).catch(function(e){console.error("TR-064 refreshCalllist() error:",e)})}else this._getCallListURI()},__playTAM:function(e){var t=this,i=e.previousElementSibling;if(!this.__TAMeventAttached[i]){i.addEventListener("ended",function(){t.__TAMstop(e)});this.__TAMeventAttached[i]=!0}i.readyState<4&&this.__TAMwait(e);if(i.paused){var r=i.play();void 0!==r&&r.then(function(){t.__TAMplay(e)}).catch(function(){})}else{i.pause();i.currentTime=0;this.__TAMstop(e)}},__TAMwait:function(e){e.innerHTML=cv.IconHandler.getInstance().getIconText(this.getTAMwait(),"*","*",this.getTAMwaitColor())},__TAMplay:function(e){e.innerHTML=cv.IconHandler.getInstance().getIconText(this.getTAMplay(),"*","*",this.getTAMplayColor())},__TAMstop:function(e){e.innerHTML=cv.IconHandler.getInstance().getIconText(this.getTAMstop(),"*","*",this.getTAMstopColor())}},defer:function(e){cv.util.ScriptLoader.getInstance().addStyles("plugins/tr064/tr064.css");cv.parser.WidgetParser.addHandler("calllist",cv.plugins.tr064.CallList);cv.ui.structure.WidgetFactory.registerClass("calllist",e)}});cv.plugins.tr064.CallList.$$dbClassInfo=e}();
//# sourceMappingURL=part-17.js.map