{"version":3,"sources":["../../../source/class/cv/plugins/CalendarList.js"],"names":["qx","Bootstrap","executePendingDefers","$$dbClassInfo","Class","define","extend","cv","ui","structure","AbstractWidget","include","common","Refresh","properties","width","check","init","height","src","days","nullable","maxquantity","statics","calendars","parse","xml","path","flavour","pageType","data","parser","WidgetParser","parseElement","this","getAttributeToPropertyMappings","parseRefresh","querySelectorAll","forEach","cal","calData","type","getAttribute","userid","magiccookie","hasAttribute","push","transform","value","parseInt","members","_getInnerDomString","getPath","getHeight","getWidth","_onDomReady","plugins","CalendarList","prototype","base","call","refreshAction","_setupRefreshAction","_timer","event","Timer","getRefresh","addListener","_refreshAction","start","calendarList","getActor","getSrc","getMaxquantity","$","calendarListlocal","util","ResourceManager","getInstance","toUri","calendar","defer","addHandler","WidgetFactory","registerClass","jQuery","fn","options","html","wrapper","dataType","datetime","each","o","c","formData","i","length","ajax","url","error","xhr","status","e","console","log","attr","success","result","color","where","items","calendarListEntries","itemnum","date","item","itemHtml","ix","calendarName","StartDate","StartTime","EndDate","EndTime","replace","description","$row","append"],"mappings":"wSAACA,GAAEC,UAAUC,qBAAqBC,GA2BjCH,GAAEI,MAAMC,OAAO,2BACdC,OAAQC,GAAGC,GAAGC,UAAUC,eACxBC,SAAUJ,GAAGC,GAAGI,OAAOC,SAOvBC,YACEC,OACEC,MAAO,SACPC,KAAM,IAERC,QACEF,MAAO,SACPC,KAAM,IAERE,KACEH,MAAO,SACPC,KAAM,yCAERG,MACEJ,MAAO,SACPK,UAAU,GAEZC,aACEN,MAAO,SACPK,UAAU,IASdE,SACEC,aAYAC,MAAO,SAAUC,EAAKC,EAAMC,EAASC,GACnC,IAAIC,EAAOvB,GAAGwB,OAAOC,aAAaC,aAAaC,KAAMR,EAAKC,EAAMC,EAASC,EAAUK,KAAKC,kCACxF5B,GAAGwB,OAAOC,aAAaI,aAAaV,EAAKC,GACzCO,KAAKV,UAAUG,MACfD,EAAIW,iBAAiB,YAAYC,QAAQ,SAAUC,GACjD,IAAIC,GACFC,KAAMF,EAAIG,aAAa,QACvBC,OAAQJ,EAAIG,aAAa,UACzBE,YAAaL,EAAIM,aAAa,eAAiBN,EAAIG,aAAa,eAAiB,GACjFtB,KAAMmB,EAAIM,aAAa,QAAUN,EAAIG,aAAa,QAAUZ,EAAKV,MAEnEc,KAAKV,UAAUG,GAAMmB,KAAKN,IACzBN,MACH,OAAOJ,GAGTK,+BAAgC,WAC9B,OACEpB,OACEgC,UAAW,SAAUC,GACnB,OAAOA,EAAQ,SAAWA,EAAQ,IAAM,KAG5C9B,QACE6B,UAAW,SAAUC,GACnB,OAAOA,EAAQ,UAAYA,EAAQ,IAAM,KAG7C1B,aACEyB,UAAW,SAAUC,GACnB,OAAOA,EAAQC,SAASD,GAAS,OAGrC5B,MACE2B,UAAW,SAAUC,GACnB,OAAOA,EAAQC,SAASD,GAAS,UAY3CE,SACEC,mBAAoB,WAClB,MAAO,wFACiDjB,KAAKkB,UAAY,YAAclB,KAAKmB,YAAcnB,KAAKoB,WAAa,kBAI9HC,YAAa,WACXhD,GAAAiD,QAAAC,aAAAC,UAAAH,YAAAI,KAAAC,KAAA1B,MACAA,KAAK2B,iBAGPC,oBAAqB,WACnB5B,KAAK6B,OAAS,IAAI/D,GAAGgE,MAAMC,MAAM/B,KAAKgC,cACtChC,KAAK6B,OAAOI,YAAY,WAAYjC,KAAKkC,eAAgBlC,MACzDA,KAAK6B,OAAOM,SAGdD,eAAgB,WACd,IAAIE,EAAepC,KAAKqC,WAEpBpD,EAAMe,KAAKsC,SACXlD,EAAcY,KAAKuC,iBACnBjD,EAAYjB,GAAGiD,QAAQC,aAAajC,UAAUU,KAAKkB,WAGvDsB,EAAE,WACAA,EAAEJ,GAAcK,mBACdxD,IAAKnB,GAAG4E,KAAKC,gBAAgBC,cAAcC,MAAM5D,GACjDG,YAAaA,EACb0D,SAAUxD,MAGd,OAAO,IAIXyD,MAAO,SAAU1D,GACfhB,GAAGwB,OAAOC,aAAakD,WAAW,eAAgB3D,GAClDhB,GAAGC,GAAGC,UAAU0E,cAAcC,cAAc,eAAgB7D,OAG/D,SAAUmD,GACTW,OAAOC,GAAGhF,QACRqE,kBAAmB,SAAUY,GAS3BA,EAAUF,OAAO/E,QAPfa,IAAK,GACLC,KAAM,GACNoE,KAAM,qCACNC,QAAS,KACTC,SAAU,OACVC,UAAU,GAEsBJ,GAElC,OAAOrD,KAAK0D,KAAK,WACf,IAAIC,EAAIN,EACJO,EAAIT,OAAOnD,MAEf,GAAc,KAAV2D,EAAE1E,IAAN,CASA,IAJA,IAAI4E,GACFzE,YAAeuE,EAAEvE,aAGV0E,EAAI,EAAGA,EAAIH,EAAEb,SAASiB,OAAQD,IAAK,CAC1C,IACIvD,EAAO,OAASuD,EAChBrD,EAAS,SAAWqD,EACpBpD,EAAc,cAAgBoD,EAC9B5E,EAAO,OAAS4E,EACpBD,EALmB,eAAiBC,GAKXA,EACzBD,EAAStD,GAAQoD,EAAEb,SAASgB,GAAGvD,KAC/BsD,EAASpD,GAAUkD,EAAEb,SAASgB,GAAGrD,OACjCoD,EAASnD,GAAeiD,EAAEb,SAASgB,GAAGpD,YACtCmD,EAAS3E,GAAQyE,EAAEb,SAASgB,GAAG5E,KAGjCiE,OAAOa,MACLC,IAAKN,EAAE1E,IACPsB,KAAM,OACNX,KAAMiE,EACNL,SAAUG,EAAEH,SACZU,MAAO,SAAUC,EAAKC,EAAQC,GAC5BC,QAAQC,IAAI,sCAAuC/B,EAAEoB,GAAGY,KAAK,MAAOH,EAAGV,EAAE1E,MAE3EwF,QAAS,SAAUC,GACjBd,EAAEN,KAAK,IAMP,IALA,IAGIqB,EAAeC,EAHfC,EAAQH,EAAOtC,aAAa0C,oBAC5BC,EAAUF,EAAMd,OAChBiB,EAAO,GAGFlB,EAAI,EAAGA,EAAIiB,EAASjB,IAAK,CAChC,IAAImB,EAAOJ,EAAMf,GACboB,EAAWvB,EAAEL,KAEjBqB,EAAQ,UACR,IAAK,IAAIQ,EAAK,EAAGA,EAAKxB,EAAEb,SAASiB,OAAQoB,IACvC,GAAIF,EAAKG,eAAiBD,EAAI,CAE1BR,GAD2C,IAAzChB,EAAEb,SAASqC,GAAIxE,aAAa,SACtBgD,EAAEb,SAASqC,GAAI3E,aAAa,SAE5B,UAQV0E,EAAW,WALmC,IAA1CvB,EAAEb,SAASqC,GAAIxE,aAAa,UACrBgD,EAAEb,SAASqC,GAAI3E,aAAa,UAE5B,yBAEoB,UAInCwE,EAAOC,EAAKI,UACW,UAAnBJ,EAAKK,YACPN,EAAOA,EAAO,KAAOC,EAAKK,WAExBL,EAAKI,YAAcJ,EAAKM,SAAWN,EAAKK,YAAcL,EAAKO,UAC7DR,GAAc,OAEZC,EAAKI,YAAcJ,EAAKM,QAC1BP,EAAOA,EAAOC,EAAKM,QAAU,KAAON,EAAKO,QAErCP,EAAKK,YAAcL,EAAKO,UAC1BR,GAAcC,EAAKO,SAIvBN,EAAWA,EAASO,QAAQ,WAAYR,EAAKS,aAE3Cd,EADiB,KAAfK,EAAKL,MACC,KAAOK,EAAKL,MAAQ,IAEpBK,EAAKL,MAGfM,GADAA,EAAWA,EAASO,QAAQ,YAAab,IACrBa,QAAQ,WAAYT,GAGxC,IAAIW,EAAOnD,EAAE,sBAAwBmC,EAAQ,MAAMiB,OAAOV,GAAUU,OAAO,eAG3EhC,EAAEgC,OAAOD,YAtFbrB,QAAQC,IAAI,sCAlBrB,CA+GEpB,QArRF9E,GAAEiD,QAAQC,aAAatD,cAAgBA","sourcesContent":["/* CalendarList.js \n * \n * copyright (c) 2010-2017, Christian Mayer and the CometVisu contributers.\n * \n * This program is free software; you can redistribute it and/or modify it\n * under the terms of the GNU General Public License as published by the Free\n * Software Foundation; either version 3 of the License, or (at your option)\n * any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for\n * more details.\n *\n * You should have received a copy of the GNU General Public License along\n * with this program; if not, write to the Free Software Foundation, Inc.,\n * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA\n */\n\n\n/**\n * @author mclb\n * @since 2014\n *\n * @ignore(jQuery.*)\n * @asset(plugins/calendarlist/*)\n */\nqx.Class.define('cv.plugins.CalendarList', {\n  extend: cv.ui.structure.AbstractWidget,\n  include: [cv.ui.common.Refresh],\n\n  /*\n  ******************************************************\n    PROPERTIES\n  ******************************************************\n  */\n  properties: {\n    width: {\n      check: \"String\",\n      init: ''\n    },\n    height: {\n      check: \"String\",\n      init: ''\n    },\n    src: {\n      check: \"String\",\n      init: \"plugins/calendarlist/calendarlist.php\"\n    },\n    days: {\n      check: \"Number\",\n      nullable: true\n    },\n    maxquantity: {\n      check: \"Number\",\n      nullable: true\n    }\n  },\n\n  /*\n  ******************************************************\n    STATICS\n  ******************************************************\n  */\n  statics: {\n    calendars: {},\n\n    /**\n     * Parses the widgets XML configuration and extracts the given information\n     * to a simple key/value map.\n     *\n     * @param xml {Element} XML-Element\n     * @param path {String} internal path of the widget\n     * @param flavour {String} Flavour of the widget\n     * @param pageType {String} Page type (2d, 3d, ...)\n     * @return {Map} extracted data from config element as key/value map\n     */\n    parse: function (xml, path, flavour, pageType) {\n      var data = cv.parser.WidgetParser.parseElement(this, xml, path, flavour, pageType, this.getAttributeToPropertyMappings());\n      cv.parser.WidgetParser.parseRefresh(xml, path);\n      this.calendars[path] = [];\n      xml.querySelectorAll('calendar').forEach(function (cal) {\n        var calData = {\n          type: cal.getAttribute('type'),\n          userid: cal.getAttribute('userid'),\n          magiccookie: cal.hasAttribute('magiccookie') ? cal.getAttribute('magiccookie') : '',\n          days: cal.hasAttribute('days') ? cal.getAttribute('days') : data.days\n        };\n        this.calendars[path].push(calData);\n      }, this);\n      return data;\n    },\n\n    getAttributeToPropertyMappings: function () {\n      return {\n        'width': {\n          transform: function (value) {\n            return value ? \"width:\" + value + \";\" : \"\";\n          }\n        },\n        'height': {\n          transform: function (value) {\n            return value ? \"height:\" + value + \";\" : \"\";\n          }\n        },\n        'maxquantity': {\n          transform: function (value) {\n            return value ? parseInt(value) : null;\n          }\n        },\n        'days': {\n          transform: function (value) {\n            return value ? parseInt(value) : null;\n          }\n        }\n      };\n    }\n  },\n\n  /*\n  ******************************************************\n    MEMBERS\n  ******************************************************\n  */\n  members: {\n    _getInnerDomString: function () {\n      return '<div class=\"actor calendarListBody\">' +\n        '<div class=\"calendarList_inline\" id=\"calendarList' + this.getPath() + '\" style=\"' + this.getHeight() + this.getWidth() + '\"></div>' +\n        '</div>';\n    },\n\n    _onDomReady: function () {\n      this.base(arguments);\n      this.refreshAction();\n    },\n\n    _setupRefreshAction: function() {\n      this._timer = new qx.event.Timer(this.getRefresh());\n      this._timer.addListener('interval', this._refreshAction, this);\n      this._timer.start();\n    },\n\n    _refreshAction: function () {\n      var calendarList = this.getActor();\n\n      var src = this.getSrc();\n      var maxquantity = this.getMaxquantity();\n      var calendars = cv.plugins.CalendarList.calendars[this.getPath()];\n\n      // TODO: replace jQuery\n      $(function () {\n        $(calendarList).calendarListlocal({\n          src: qx.util.ResourceManager.getInstance().toUri(src),\n          maxquantity: maxquantity,\n          calendar: calendars\n        });\n      });\n      return false;\n    }\n  },\n\n  defer: function (statics) {\n    cv.parser.WidgetParser.addHandler(\"calendarlist\", statics);\n    cv.ui.structure.WidgetFactory.registerClass(\"calendarlist\", statics);\n  }\n});\n(function ($) {\n  jQuery.fn.extend({\n    calendarListlocal: function (options) {\n      var defaults = {\n        src: '',\n        days: 30,\n        html: '<span>{date}: {text}{where}</span>',\n        wrapper: 'li',\n        dataType: 'json',\n        datetime: true\n      };\n      options = jQuery.extend(defaults, options);\n\n      return this.each(function () {\n        var o = options;\n        var c = jQuery(this);\n\n        if (o.src === '') {\n          console.log('calendarListlocal: no src URL');\n          return; // avoid the request\n        }\n\n        var formData = {\n          'maxquantity': o.maxquantity\n        };\n\n        for (var i = 0; i < o.calendar.length; i++) {\n          var calendarname = 'calendarname' + i;\n          var type = 'type' + i;\n          var userid = 'userid' + i;\n          var magiccookie = 'magiccookie' + i;\n          var days = 'days' + i;\n          formData[calendarname] = i; //o.calendar[i].textContent;\n          formData[type] = o.calendar[i].type;\n          formData[userid] = o.calendar[i].userid;\n          formData[magiccookie] = o.calendar[i].magiccookie;\n          formData[days] = o.calendar[i].days;\n        }\n\n        jQuery.ajax({\n          url: o.src,\n          type: 'POST',\n          data: formData,\n          dataType: o.dataType,\n          error: function (xhr, status, e) {\n            console.log('C: #%s, Error: %s, calendarList: %s', $(c).attr('id'), e, o.src);\n          },\n          success: function (result) {\n            c.html('');\n            var items = result.calendarList.calendarListEntries;\n            var itemnum = items.length;\n            var date = '';\n            var color, format, where;\n\n            for (var i = 0; i < itemnum; i++) {\n              var item = items[i];\n              var itemHtml = o.html;\n\n              color = '#FFFFFF';\n              for (var ix = 0; ix < o.calendar.length; ix++) {\n                if (item.calendarName === ix) {\n                  if (o.calendar[ix].hasAttribute('color') === true) {\n                    color = o.calendar[ix].getAttribute('color');\n                  } else {\n                    color = '#FFFFFF';\n                  }\n\n                  if (o.calendar[ix].hasAttribute('format') === true) {\n                    format = o.calendar[ix].getAttribute('format');\n                  } else {\n                    format = '{date}: {text}{where}';\n                  }\n                  itemHtml = '<span>' + format + '</span>';\n                }\n              }\n\n              date = item.StartDate;\n              if (item.StartTime !== '00:00') {\n                date = date + ', ' + item.StartTime;\n              }\n              if (item.StartDate !== item.EndDate || item.StartTime !== item.EndTime) {\n                date = date + ' - ';\n              }\n              if (item.StartDate !== item.EndDate) {\n                date = date + item.EndDate + ', ' + item.EndTime;\n              } else {\n                if (item.StartTime !== item.EndTime) {\n                  date = date + item.EndTime;\n                }\n              }\n\n              itemHtml = itemHtml.replace(/\\{text\\}/, item.description);\n              if (item.where !== '') {\n                where = ' (' + item.where + ')';\n              } else {\n                where = item.where;\n              }\n              itemHtml = itemHtml.replace(/\\{where\\}/, where);\n              itemHtml = itemHtml.replace(/\\{date\\}/, date);\n              //console.log('%i: %s', i, itemHtml);\n\n              var $row = $('<span style=\"color:' + color + '\">').append(itemHtml).append('</span><br>');\n              //console.log('%i: %s', i, $row);\n\n              c.append($row);\n            }\n          }\n        });\n      });\n    }\n  });\n})(jQuery);"]}