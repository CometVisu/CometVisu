!function(){var t={dependsOn:{"qx.Class":{usage:"dynamic",require:!0},"cv.ui.structure.AbstractWidget":{construct:!0,require:!0},"cv.ui.common.Operate":{require:!0},"cv.ui.common.Refresh":{require:!0},"qx.util.Function":{construct:!0},"cv.parser.WidgetParser":{},"cv.data.Model":{},"cv.TemplateEngine":{},"qx.io.request.Xhr":{},"cv.core.notifications.Router":{},"qx.locale.Manager":{},"qx.event.Timer":{},"qx.dom.Element":{},"cv.ui.PopupHandler":{},"qx.event.Registration":{},"cv.util.ScriptLoader":{defer:"runtime"}}};qx.Bootstrap.executePendingDefers(t);qx.Class.define("cv.plugins.diagram.AbstractDiagram",{extend:cv.ui.structure.AbstractWidget,include:[cv.ui.common.Operate,cv.ui.common.Refresh],type:"abstract",construct:function(t){cv.ui.structure.AbstractWidget.constructor.call(this,t);this._debouncedLoadDiagramData=qx.util.Function.debounce(this.loadDiagramData.bind(this),200)},statics:{cache:{},parse:function(t,e,i,r,a){a=a?Object.assign(a,this.getAttributeToPropertyMappings()):this.getAttributeToPropertyMappings();cv.parser.WidgetParser.parseElement(this,t,e,i,r,a);cv.parser.WidgetParser.parseRefresh(t,e);var s=t.getAttribute("legend")||"both";return cv.data.Model.getInstance().setWidgetData(e,{content:this.getDiagramElements(t),legendInline:["both","inline"].indexOf(s)>=0,legendPopup:["both","popup"].indexOf(s)>=0})},getAttributeToPropertyMappings:function(){return{series:{default:"day"},seriesStart:{default:"end-month"},seriesEnd:{default:"now"},seriesResolution:{default:300,transform:parseInt},period:{default:1,transform:parseInt},legendposition:{default:"ne"},timeformat:{},timeformatTooltip:{default:"%d.%m.%Y %H:%M"},zoomYAxis:{transform:function(t){return"true"===t}},title:{target:"title"},refresh:{},gridcolor:{default:"#81664B"},previewlabels:{transform:function(t){return"true"===t}},popup:{transform:function(t){return"true"===t}},tooltip:{transform:function(t){return"true"===t}}}},getDiagramElements:function(t){var e={axes:[],axesnum:0,ts:[],tsnum:0},i=[];t.querySelectorAll("axis").forEach(function(t){var r=t.getAttribute("unit")||"";e.axes[e.axesnum]={axisLabel:t.getAttribute("label")||null,position:t.getAttribute("position")||"left",min:t.getAttribute("min")||null,max:t.getAttribute("max")||null,unit:r,tickDecimals:t.getAttribute("decimals")||null,tickFormatter:function(t,e){return t.toFixed(e.tickDecimals)+r}};e.axesnum++;i[t.textContent]=e.axesnum},this);t.querySelectorAll("influx,rrd").forEach(function(t){var r="rrd"===t.tagName?t.textContent:t.getAttribute("measurement"),a="true"===(t.getAttribute("steps")||"false"),s=t.getAttribute("fillMissing");e.ts[e.tsnum]={tsType:t.tagName,src:r,color:t.getAttribute("color"),label:t.getAttribute("label")||r,axisIndex:i[t.getAttribute("yaxis")]||1,steps:a,fill:"true"===(t.getAttribute("fill")||"false"),scaling:parseFloat(t.getAttribute("scaling"))||1,cFunc:t.getAttribute("consolidationFunction")||("rrd"===t.tagName?"AVERAGE":"MEAN"),fillTs:null===s?a?"previous":"linear":s,resol:parseInt(t.getAttribute("resolution")),offset:parseInt(t.getAttribute("offset")),style:t.getAttribute("style")||"lines",align:t.getAttribute("align")||"center",barWidth:t.getAttribute("barWidth")||1};if("influx"===t.tagName){e.ts[e.tsnum].filter=this.getInfluxFilter(t,"AND");e.ts[e.tsnum].field=t.getAttribute("field");e.ts[e.tsnum].authentication=t.getAttribute("authentication")}else{var n=t.getAttribute("datasourceIndex")||0;n<0&&(n=0);e.ts[e.tsnum].dsIndex=n}e.tsnum++},this);return e},getInfluxFilter:function(t,e){for(var i=t.children,r=i.length,a="",s=0;s<r;s++){var n=i[s];""!==a&&(a+=" "+e+" ");switch(n.tagName){case"and":a+=this.getInfluxFilter(n,"AND");break;case"or":a+=this.getInfluxFilter(n,"OR");break;case"tag":a+=n.getAttribute("key")+" "+n.getAttribute("operator")+" '"+n.getAttribute("value")+"'"}}return e?"("+a+")":a},lookupTsCache:function(t,e,i,r,a,s,n,o,l){var c,u,g=cv.TemplateEngine.getInstance().visu,d=g.getResourcePath("charts",{src:t.src,start:e,end:i});if("influx"!==t.tsType&&null!==d)c=u=d;else{u=("influx"===t.tsType?"resource/plugins/diagram/influxfetch.php?ts="+t.src:g.getResourcePath("rrd")+"?rrd="+encodeURIComponent(t.src)+".rrd")+"&ds="+encodeURIComponent(t.cFunc)+"&start="+("rrd"===t.tsType?e:encodeURIComponent(e))+"&end="+("rrd"===t.tsType?i:encodeURIComponent(i))+"&res="+encodeURIComponent(r)+(t.fillTs?"&fill="+encodeURIComponent(t.fillTs):"")+(t.filter?"&filter="+encodeURIComponent(t.filter):"")+(t.field?"&field="+encodeURIComponent(t.field):"")+(t.authentication?"&auth="+encodeURIComponent(t.authentication):"");c=u+("rrd"===t.tsType?"|"+t.dsIndex:"")}var h=!(c in this.cache);if(n||h||!("data"in this.cache[c])||void 0!==s&&Date.now()-this.cache[c].timestamp>1e3*s){h&&(this.cache[c]={waitingCallbacks:[]});this.cache[c].waitingCallbacks.push([o,l]);if(1===this.cache[c].waitingCallbacks.length){this.cache[c].xhr&&this.cache[c].xhr.dispose();var p=new qx.io.request.Xhr(u);g.authorize(p);p.set({accept:"application/json"});p.addListener("success",function(e){this._onSuccess(t,c,e,a)},this);p.addListener("statusError",function(e){this._onStatusError(t,c,e)},this);this.cache[c].xhr=p;p.send()}}else o(this.cache[c].data,l)},_onSuccess:function(t,e,i,r){var a=i.getTarget().getResponse();if(null!==a){var s=cv.TemplateEngine.getInstance().visu;if(s.hasCustomChartsDataProcessor(a))a=s.processChartsData(a);else{for(var n=Number.isFinite(t.offset)?1e3*t.offset:0,o=new Array(a.length),l=0,c=a.length;l<c;l++)"rrd"===t.tsType?o[l]=[a[l][0]+n,parseFloat(a[l][1][t.dsIndex])*t.scaling]:o[l]=[a[l][0]+n,parseFloat(a[l][1])*t.scaling];a=o}}var u=Date.now();if(r&&a.length>0){var g=Array.from(a[a.length-1]);g[0]=u;a.push(g)}this.cache[e].data=a;this.cache[e].timestamp=u;this.cache[e].waitingCallbacks.forEach(function(t){t[0](a,t[1])},this);this.cache[e].waitingCallbacks.length=0},_onStatusError:function(t,e,i){cv.core.notifications.Router.dispatchMessage("cv.diagram.error",{title:qx.locale.Manager.tr("Diagram communication error"),severity:"urgent",message:qx.locale.Manager.tr("URL: %1<br/><br/>Response:</br>%2",JSON.stringify(e),i._target._transport.responseText)});window.console.error("Diagram _onStatusError",t,e,i);var r=[];this.cache[e].data=r;this.cache[e].timestamp=Date.now();this.cache[e].waitingCallbacks.forEach(function(t){t[0](r,t[1])},this);this.cache[e].waitingCallbacks.length=0}},properties:{content:{check:"Object",init:{}},title:{check:"String",nullable:!0,apply:"_applyTitle"},series:{check:["hour","day","week","month","year","fullday","custom"],init:"day"},seriesStart:{check:"String",init:"end-month"},seriesEnd:{check:"String",init:"now"},seriesResolution:{check:"Number",init:300},forceNowDatapoint:{check:"Boolean",init:!0},period:{check:"Number",init:1},legendInline:{check:"Boolean",init:!0},legendPopup:{check:"Boolean",init:!0},legendposition:{check:["nw","ne","sw","se"],init:"ne"},timeformat:{check:"String",nullable:!0},timeformatTooltip:{check:"String",init:"%d.%m.%Y %H:%M"},zoomYAxis:{check:"Boolean",init:!1},gridcolor:{check:"String",init:"#81664B"},previewlabels:{check:"Boolean",init:!1},popup:{check:"Boolean",init:!1},tooltip:{check:"Boolean",init:!1}},members:{_init:null,popupplot:null,plot:null,plotted:null,_timerPopup:null,__P_18_0:!1,_applyTitle:function(t){t&&this.setLabel('<div class="label">'+t+"</div>")},_setupRefreshAction:function(){if(this.getRefresh()){if(!this._timer){this._timer=new qx.event.Timer(this.getRefresh());this._timer.addListener("interval",function(){this.loadDiagramData(this.plot,!1,!0)},this)}if(!this._timerPopup){this._timerPopup=new qx.event.Timer(this.getRefresh());this._timerPopup.addListener("interval",function(){this.loadDiagramData(this.popupplot,!1,!0)},this)}}},_stopRefresh:function(t){t&&t.isEnabled()&&t.stop()},_startRefresh:function(t,e){if(t){t.isEnabled()||t.start();!0===e&&t.fireEvent("interval")}},_action:function(){var t=qx.dom.Element.create("div",{class:"diagram",id:this.getPath()+"_big",style:"height: 90%"});this._init=!0;cv.ui.PopupHandler.showPopup("diagram",{title:this.getLabel(),content:t,page:this.getParentPage().getPath()}).addListener("close",function(){this._stopRefresh(this._timerPopup);qx.event.Registration.removeAllListeners(t);if(this.popupplot){this.popupplot.shutdown();this.popupplot=null}},this);var e=t.parentNode;Object.entries({height:"100%",width:"95%",margin:"auto"}).forEach(function(t){e.style[t[0]]=t[1]});t.innerHTML="";qx.event.Registration.addListener(t,"tap",function(t){t.stopPropagation()},this);this.initDiagram(!0);this._startRefresh(this._timerPopup,!0)},initDiagram:function(t){if(this._init){this._init=!1;t=t||this.__P_18_0;var e={canvas:!0,tooltip:this.getTooltip(),tooltipOpts:{content:"<center>%x<br/>%y</center>",xDateFormat:this.getTimeformatTooltip(),shifts:{x:20,y:10},defaultTheme:!1},zoom:{interactive:t,trigger:"dblclick",amount:1.5},pan:{interactive:t,cursor:"move",frameRate:20,triggerOnDrag:!1},yaxes:JSON.parse(JSON.stringify(this.getContent().axes)),xaxes:[{mode:"time",timeformat:this.getTimeformat()}],legend:{show:t&&this.isLegendPopup()||!t&&this.isLegendInline(),backgroundColor:"#101010",position:this.getLegendposition()},grid:{show:!0,aboveData:!1,color:this.getGridcolor(),backgroundColor:"#000000",tickColor:this.getGridcolor(),markingsColor:this.getGridcolor(),borderColor:this.getGridcolor(),hoverable:!0},touch:{pan:t?"x":"none",scale:t?"x":"none",autoWidth:!1,autoHeight:!1,delayTouchEnded:500,callback:null,simulClick:!0,tapThreshold:150,dbltapThreshold:200,tapPrecision:30}};e.yaxes.forEach(function(t){Object.assign(t,{axisLabelColour:this.getGridcolor(),color:this.getGridcolor()})},this);e.xaxes.forEach(function(t){Object.assign(t,{axisLabelColour:this.getGridcolor(),color:this.getGridcolor()})},this);t&&Object.assign(e,{yaxis:{isPopup:!0,zoomRange:!!this.getZoomYAxis()&&[null,null]},xaxis:{zoomRange:[null,null],panRange:[null,null]}});if(this.getTooltip()){e.grid.hoverable=!0;e.grid.clickable=!0}if(!t&&!this.getPreviewlabels()){Object.assign(e,{xaxes:[{ticks:0,mode:e.xaxes[0].mode}]});0===e.yaxes.length&&(e.yaxes[0]={});e.yaxes.forEach(function(t){Object.assign(t,{ticks:0,axisLabel:null})},this)}var i=t?$("#"+this.getPath()+"_big"):$("#"+this.getPath()+" .actor div");i.empty();var r=$.plot(i,[],e);if(t){this.debug("popup plot generated");this.popupplot=r}else{this.debug("plot generated");this.plot=r}this.plotted=!0;var a=this;i.bind("plotpan",function(e,i){a._debouncedLoadDiagramData(i,t,!1)}).bind("plotzoom",function(){a.loadDiagramData(r,t,!1)}).bind("touchended",function(){a.loadDiagramData(r,t,!1)}).bind("tap",function(){var e=$(this).closest(".widget_container")[0];if(!t&&void 0!==e){var i=$(this).closest(".actor")[0],r=e.id;void 0!==i&&r.length>0&&a.action()}});t||r.getPlaceholder().unbind("touchstart").unbind("touchmove").unbind("touchend");this.loadDiagramData(r,t,!1)}},getSeriesSettings:function(t,e){var i={start:null,end:null,res:null};if("custom"===this.getSeries()){i.start=this.getSeriesStart();i.end=this.getSeriesEnd();i.res=this.getSeriesResolution()}else{var r={hour:{res:60,start:"hour",end:"now"},day:{res:300,start:"day",end:"now"},fullday:{res:300,start:"day",end:"midnight+24hour"},week:{res:1800,start:"week",end:"now"},month:{res:21600,start:"month",end:"now"},year:{res:432e3,start:"year",end:"now"}}[this.getSeries()];if(!r)return null;i.start="end-"+this.getPeriod()+r.start;i.end=r.end;i.res=this.getSeriesResolution()?this.getSeriesResolution():r.res}t.datamin&&t.datamax&&e&&(i.start=(t.min/1e3).toFixed(0));return i},loadDiagramData:function(t,e,i){if(t){var r=this.getSeriesSettings(t.getAxes().xaxis,e);if(r){var a=[],s=0,n=0;this.getContent().ts.forEach(function(e,o){var l=Number.isFinite(e.resol)?e.resol:r.res,c=this.getForceNowDatapoint(),u=this.getRefresh()?this.getRefresh():l;cv.plugins.diagram.AbstractDiagram.lookupTsCache(e,r.start,r.end,l,c,u,i,function(i){s++;if(null!==i){n++;a[o]={label:e.label,color:e.color,data:i,yaxis:parseInt(e.axisIndex),bars:{show:"bars"===e.style,fill:e.fill,barWidth:parseInt(e.barWidth),align:e.align},lines:{show:"lines"===e.style,steps:e.steps,fill:e.fill,zero:!1},points:{show:"points"===e.style,fill:e.fill}}}if(s===this.getContent().tsnum){var r;if(n===s)r=a;else{r=[];for(var l=-1,c=0;c<n;c++)for(var u=l+1;u<a.length;u++)if(null!==a[u]){r[c]=a[u];l=u;break}}t.setData(r);t.setupGrid();t.draw();a=[]}}.bind(this))},this)}}}},destruct:function(){this._timerPopup&&this._disposeObjects("_timerPopup")},defer:function(){cv.util.ScriptLoader.getInstance().addScripts(["plugins/diagram/dep/flot/jquery.flot.min.js","plugins/diagram/dep/flot/jquery.flot.touch.min.js","plugins/diagram/dep/flot/jquery.flot.canvas.min.js","plugins/diagram/dep/flot/jquery.flot.resize.min.js","plugins/diagram/dep/flot/jquery.flot.time.min.js","plugins/diagram/dep/flot/jquery.flot.axislabels.js","plugins/diagram/dep/flot/jquery.flot.tooltip.min.js","plugins/diagram/dep/flot/jquery.flot.navigate.min.js"],[0])}});cv.plugins.diagram.AbstractDiagram.$$dbClassInfo=t}();!function(){var t={dependsOn:{"qx.Class":{usage:"dynamic",require:!0},"cv.plugins.diagram.AbstractDiagram":{construct:!0,require:!0},"qx.event.message.Bus":{},"qx.util.DeferredCall":{},"cv.parser.WidgetParser":{defer:"runtime"},"cv.ui.structure.WidgetFactory":{defer:"runtime"}}};qx.Bootstrap.executePendingDefers(t);qx.Class.define("cv.plugins.diagram.Diagram",{extend:cv.plugins.diagram.AbstractDiagram,construct:function(t){this._init=!0;cv.plugins.diagram.AbstractDiagram.constructor.call(this,t)},properties:{width:{check:"String",nullable:!0},height:{check:"String",nullable:!0}},statics:{parse:function(t,e,i,r){return cv.plugins.diagram.AbstractDiagram.parse(t,e,i,r,this.getAttributeToPropertyMappings())},getAttributeToPropertyMappings:function(){return{width:{transform:function(t){return t?parseInt(t)+"px":null}},height:{transform:function(t){return t?parseInt(t)+"px":null}}}}},members:{__P_19_0:null,_onDomReady:function(){if(!this.$$domReady){var t=this.getParentPage().getPath(),e=qx.event.message.Bus;this.setRestartOnVisible(!0);e.subscribe("path."+t+".beforePageChange",function(){this._init||this.loadDiagramData(this.plot,!1,!1)},this);e.subscribe("page."+t+".appear",function(){this._init&&this.initDiagram(!1)},this);this.isVisible()?new qx.util.DeferredCall(function(){this._init?this.initDiagram(!1):this.loadDiagramData(this.plot,!1,!1)},this).schedule():this.__P_19_0=this.addListener("changeVisible",function(t){if(t.getData()){this._init?this.initDiagram(!1):this.loadDiagramData(this.plot,!1,!1);this.removeListenerById(this.__P_19_0);this.__P_19_0=null}},this);this.$$domReady=!0;this.initListeners()}},_getInnerDomString:function(){return'<div class="actor clickable" style="height: 100%; min-height: 40px;"><div class="'+(this.getPreviewlabels()?"diagram_inline":"diagram_preview")+'" style="'+("min-height: 40px"+(this.getWidth()?";width:"+this.getWidth():"")+(this.getHeight()?";height:"+this.getHeight():";height: 100%"))+'">loading...</div></div>'}},defer:function(t){cv.parser.WidgetParser.addHandler("diagram",t);cv.ui.structure.WidgetFactory.registerClass("diagram",t)}});cv.plugins.diagram.Diagram.$$dbClassInfo=t}();!function(){var t={dependsOn:{"qx.Class":{usage:"dynamic",require:!0},"cv.plugins.diagram.AbstractDiagram":{construct:!0,require:!0},"cv.ui.common.Update":{require:!0},"cv.parser.WidgetParser":{defer:"runtime"},"cv.ui.structure.WidgetFactory":{defer:"runtime"}}};qx.Bootstrap.executePendingDefers(t);qx.Class.define("cv.plugins.diagram.Info",{extend:cv.plugins.diagram.AbstractDiagram,include:[cv.ui.common.Update],construct:function(t){this._init=!1;cv.plugins.diagram.AbstractDiagram.constructor.call(this,t)},statics:{parse:function(t,e,i,r){var a=cv.plugins.diagram.AbstractDiagram.parse(t,e,i,r);cv.parser.WidgetParser.parseAddress(t,e);cv.parser.WidgetParser.parseFormat(t,e);return a}},members:{_getInnerDomString:function(){return'<div class="actor clickable switchUnpressed"><div class="value">-</div></div>'},_update:function(t,e){return void 0!==t&&void 0!==e?this.defaultUpdate(t,e,this.getDomElement(),!0,this.getPath()):null}},defer:function(t){cv.parser.WidgetParser.addHandler("diagram_info",t);cv.ui.structure.WidgetFactory.registerClass("diagram_info",t)}});cv.plugins.diagram.Info.$$dbClassInfo=t}();qx.$$packageData[3]={locales:{},resources:{},translations:{en:{},de:{"Diagram communication error":"Diagram Kommunikations-Fehler","URL: %1<br/><br/>Response:</br>%2":"URL: %1<br/><br/>Antwort:</br>%2"}}};
//# sourceMappingURL=package-3.js.map