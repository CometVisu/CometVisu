/**
 * Javascript-Representation of a configuration
 *
 * These classes are used to load a visu-configuration, making it's attributes and nodes available in Javascript
 *
 *
 * LICENSE: This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 3
 * of the License, or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://opensource.org/licenses/gpl-license.php>;.
 *
 * @category    editor
 * @package     CometVisu
 * @author      Julian Makowski (julian at makowskis dot de)
 * @copyright   2012 Julian Makowski
 * @license     GPLv3 or later, http://opensource.org/licenses/gpl-license.php
 * @version     SVN: $Id$
 * @link        http://cometvisu.de
 * @since       2012-10-10
 * @requires    Schema.js, Messages.js, Result.js, ListenerEvent.js
 */

/**
 * creator of unique IDs
 * source: http://arguments.callee.info/2008/10/31/generating-unique-ids-with-javascript/
 * no license mentioned.
 */

var Configuration=function(e){if(e==undefined||e==""||!e.match(/\.xml$/))throw Messages.loader.filenameInvalid;var t=this,n=e,r={},i={};t.rootNodes=[],t.isMaster=!0,t.load=function(){$.ajax(n,{dataType:"xml",cache:!1,success:function(e){i=$(e),s(),$(document).trigger("configuration_loaded")},error:function(e,t,n){var r=new Result(!1,Messages.configuration.loadingError,[t,n]);$(document).trigger("configuration_loading_error",[r])}})},t.save=function(e){e==undefined&&(e=n);var r=t.getAsSerializable();$.ajax("editor/bin/save_config.php",{dataType:"json",data:{config:e,data:JSON.stringify(r)},type:"POST",cache:!1,success:function(e){if(e==undefined||typeof e.success=="undefined"){var t=new Result(!1,Messages.configuration.savingErrorUnknown);$(document).trigger("configuration_saving_error",[t]);return}if(e.success==0){var n;typeof e.message!="undefined"&&(n=e.message);var t=new Result(!1,Messages.configuration.savingError,[n]);$(document).trigger("configuration_saving_error",[t]);return}$(document).trigger("configuration_saving_success")},error:function(e,t,n){var r=new Result(!1,Messages.configuration.savingErrorServer,[t,n]);$(document).trigger("configuration_saving_error",[r])}})},t.getSchemaFilename=function(){var e=i.children().attr("xsi:noNamespaceSchemaLocation");if(e==undefined||e=="")throw Messages.configuration.schemaNotFound;var t="";return-1!=n.lastIndexOf("/")&&(t=n.substring(0,n.lastIndexOf("/")+1)),t+e},t.setSchema=function(e){if(e==undefined||typeof e!="object")throw"internal problem: improper usage of Configuration (not an object)";r=e,$.each(t.rootNodes,function(e,t){var n=t.name;if(typeof r.allowedRootElements[n]=="undefined")throw"schema is not valid for this configuration, can not find root-level element "+n;var i=r.allowedRootElements[n];t.setSchemaElement(i)})},t.isValid=function(){if($.isEmptyObject(r))throw"internal problem: improper usage of Configuration (no schema set)";var e=!0;return $.each(t.rootNodes,function(t,n){var i=n.name;if(typeof r.allowedRootElements[i]=="undefined"){e=!1;return}e=e&&n.isValid()}),e},t.getAsSerializable=function(){var e=[];return $.each(t.rootNodes,function(t,n){e.push(n.getAsSerializable())}),e},t.attachGlobalListener=function(e){if(typeof e.ConfigurationElementEventListener!="function")throw"programming error: listener is not compatible";o.push(e)},t.informGlobalListeners=function(e,t){if(o.length==0)return;var n=new ListenerEvent(e,t);$.each(o,function(e,t){t.ConfigurationElementEventListener(n)})};var s=function(){i.children().each(function(){var e=new ConfigurationElement(this,t);t.rootNodes.push(e)})};t.load();var o=[]},ConfigurationElement=function(e,t){var n=this,r=function(){var e={};if(c[0].nodeType!=1)return e;var t=c.get(0);return typeof t.attributes!="undefined"&&$.each(t.attributes,function(t,r){r.name.match(/:/)?n.systemAttributes[r.name]=r.value:e[r.name]=r.value}),e},i=function(){var e=[];return c[0].nodeType!=1?e:(c.contents().each(function(){if(this.nodeType!=1){if(this.nodeValue.trim()=="")return;if(this.nodeType==8)return}var t=new ConfigurationElement(this,n);e.push(t)}),e)},s=function(){return c.clone().find("*").remove().end().text()};n.getUID=function(){return d},n.setSchemaElement=function(e){h=e,e.isMixed==0&&$.each(n.children,function(e,t){t.name=="#text"&&t.remove()}),n.children.length>0&&$.each(n.children,function(t,n){var r=n.name,i=e.getSchemaElementForElementName(r);if(i==undefined)throw"xsd does not match this configuration, or configuration is not valid for "+r;n.setSchemaElement(i)})},n.getSchemaElement=function(){return h},n.isValid=function(){var e=!0;$.each(n.attributes,function(t,n){if(typeof h.allowedAttributes[t]=="undefined"){f("invalid",{type:"attribute_disallowed",item:t}),e=!1;return}e=e&&h.allowedAttributes[t].isValueValid(n)});if(!1===e)return!1;$.each(h.allowedAttributes,function(t,r){0==r.isOptional&&(typeof n.attributes[t]=="undefined"||n.attributes[t]==undefined)&&(f("invalid",{type:"attribute_missing",item:t}),e=!1)});if(!1===e)return!1;var t=h.getChildrenRegex(";",!0),r=regexFromString(t),i="";for(var o=0,u=n.children.length;o<u;o++){var a=n.children[o];if(a.name=="#text"){if(!1===h.isMixed&&!1===h.isTextContentAllowed()){f("invalid",{type:"text_not_allowed"}),e=!1;return}}else i+=a.name+";";if(!1===a.isValid()){e=!1;return}}if(0==r.test(i))return f("invalid",{type:"regex_not_matched",regex:t,children:i}),!1;if(n.children.length==0||h.isMixed){var l=s();l.trim()!=""&&(e=e&&h.isValueValid(l),e==0&&f("invalid",{type:"value_invalid"}))}return e},n.setAttributeValue=function(e,t){var r=h.allowedAttributes[e].isValueValid(t);if(0==r){var i=h.allowedAttributes[e].getTypeString();return new Result(!1,Messages.validity.valueInvalidForType,[i])}return n.attributes[e]=t,f("attributeChangedValue",{item:e,newValue:t}),new Result(!0)},n.setTextValue=function(e){e=$.trim(e);var t=h.isValueValid(e);return 0==t?new Result(!1,Messages.validity.valueInvalid):(n.value=e,f("elementChangedValue",{newValue:e}),new Result(!0))},n.removeChildNode=function(e){var t=$.inArray(e,n.children);t!=-1&&n.children.splice(t,1)},n.remove=function(){if(typeof l.isMaster!="undefined"&&l.isMaster==1)return;l.removeChildNode(n)},n.appendChildNode=function(e){if(n==e)throw"programming error: self and new-node are identical";n.children.push(e),e.setParentNode(n),u()};var o=undefined,u=function(){var e=$.extend([],n.children);o==undefined&&(o=h.getAllowedElementsSorting()),e.sort(a),n.children=e},a=function(e,t){var n=o[e.name],r=o[t.name];if(n==undefined||r==undefined)return 0;if(n==r)return 0;typeof n!="string"&&(n=n.toString()),typeof r!="string"&&(r=r.toString());var i=n.split("."),s=r.split(".");for(var u=0;u<i.length;++u){if(i[u]<s[u])return-1;if(i[u]>s[u])return 1}return 0};n.setParentNode=function(e){l=e},n.getChildren=function(){return n.children},n.setChildren=function(e){n.children=e},n.addChildAtPosition=function(e,t){t>n.children.length&&(t=n.children.length),n.children.splice(t,0,e),u()},n.createChildNode=function(e){if(!1===h.isChildElementAllowed(e))throw"element "+n.name+" does not allow child of type "+e;var t;e=="#text"?t=document.createTextNode(""):t=$("<"+e+" />",h.getSchemaDOM());var r=new ConfigurationElement(t,n);return r.setSchemaElement(h.getSchemaElementForElementName(e)),r.initFromScratch(),n.appendChildNode(r),r},n.isChildCreatable=function(e){if(!1===h.isChildElementAllowed(e))return!1;var t=h.getBoundsForElementName(e),r=0;return $.each(n.children,function(t,n){n.name==e&&++r}),t!=undefined&&t.max<=r?!1:!0},n.initFromScratch=function(){h.defaultValue!=undefined&&n.setTextValue(h.defaultValue),$.each(h.allowedAttributes,function(e,t){t.defaultValue!=undefined&&n.setAttributeValue(e,t.defaultValue)}),n.children=[];var e=h.getRequiredElements();$.each(e,function(e,t){n.createChildNode(t)})},n.getAllowedElements=function(){return h==undefined?undefined:h.getAllowedElements()},n.isRemovable=function(){if(l==undefined||typeof l.isMaster!="undefined"&&l.isMaster==1)return!1;var e=l.children,t=l.getSchemaElement().getChildBounds(),r=h.getBounds(),i=1;t!=undefined&&(i=t.min),i*=r.min;var s=0;return $.each(e,function(e,t){t.name==n.name&&++s}),i>=s?!1:!0},n.attachListener=function(e){if(typeof e.ConfigurationElementEventListener!="function")throw"programming error: listener is not compatible";p.push(e)},n.clearListeners=function(){p=[]},n.setSelf=function(e){n=e};var f=function(e,t){l.informGlobalListeners(e,t);if(p.length==0)return;var n=new ListenerEvent(e,t);$.each(p,function(e,t){t.ConfigurationElementEventListener(n)})};n.informGlobalListeners=function(e,t){l.informGlobalListeners(e,t)},n.getParentElement=function(){return l},n.getDuplicateForParent=function(e){var t,r;return n.name=="#text"?r=document.createTextNode(""):r=$("<"+n.name+" />",h.getSchemaDOM()),t=new ConfigurationElement(r,e),t.setSchemaElement(h),t.attributes=$.extend({},n.attributes),t.value=n.value,$.each(n.children,function(e,n){var r=n.getDuplicateForParent(t);t.appendChildNode(r)}),t},n.getAsSerializable=function(){var e={};return e.nodeName=n.name,e.attributes=$.extend({},n.attributes,n.systemAttributes),n.children.length==0&&(e.nodeValue=n.value.trim()),e.children=[],$.each(n.children,function(t,n){e.children.push(n.getAsSerializable())}),e};var l=t,c=$(e),h=undefined;n.name=c.get(0).nodeName,c.get(0).nodeType!=1&&(n.name="#text"),n.systemAttributes={},n.attributes=r(),n.children=i(),n.value=s();var p=[],d=uniqueID()},uniqueID=function(){var e=1;return function(){return e++}}();