/**
 * Javascript-Representation of an XSD/Schema
 *
 * The classes in this file are able to load an XML-Schema/XSD from a give URL, and
 * create an object-oriented representation of it. This includes the ability to check for validity of
 * values, as well as having a tree-like structure of allowed elements and attributes.
 *
 *
 * LICENSE: This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 3
 * of the License, or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://opensource.org/licenses/gpl-license.php>;.
 *
 * @category    editor
 * @package     CometVisu
 * @author      Julian Makowski (julian at makowskis dot de)
 * @copyright   2012 Julian Makowski
 * @license     GPLv3 or later, http://opensource.org/licenses/gpl-license.php
 * @version     SVN: $Id$
 * @link        http://cometvisu.de
 * @since       2012-10-03
 * @requires    Messages.js
 */

var Schema=function(e){if(e==undefined||e==""||!e.match(/\.xsd$/))throw"no, empty or invalid filename given, can not instantiate without one";var t=this,n=e,r={};t.allowedRootElements={};var i=function(){$.ajax(n,{dataType:"xml",cache:!1,success:function(e){r=$(e),s(),$(document).trigger("schema_loaded")}})},s=function(){var e=fixNamespace("xsd\\:schema > xsd\\:element");$(e,r).each(function(){var e=$(this).attr("name");t.allowedRootElements[e]=new SchemaElement(this,t)})},o={};t.getReferencedNode=function(e,n){if(typeof o[e]!="undefined"&&typeof o[e][n]!="undefined")return o[e][n];var i="xsd\\:schema > xsd\\:"+e+'[name="'+n+'"]';i=fixNamespace(i);var s=$(i,r);return s.is("[ref]")&&(s=t.getReferencedNode(e,s.attr("ref"))),typeof o[e]=="undefined"&&(o[e]={}),o[e][n]=s,s};var u={};t.getTypeNode=function(e,t){if(typeof u[e]!="undefined"&&typeof u[e][t]!="undefined")return u[e][t];var n=fixNamespace("xsd\\:"+e+'Type[name="'+t+'"]'),i=$(n,r);if(i.length!=1)throw"schema/xsd appears to be invalid, "+e+'Type "'+t+'" can not be found';return typeof u[e]=="undefined"&&(u[e]={}),u[e][t]=i,i};var a=undefined;t.getTextNodeSchemaElement=function(){if(a==undefined){var e=$("<element />",t.getSchemaDOM()).attr({name:"#text",type:"xsd:string"});a=new SchemaElement(e,t)}return a},t.getSchemaDOM=function(){return r},i()},SchemaSimpleType=function(e,t){if(typeof e=="undefined"||e==undefined)throw"can not proceed, have problem with unset node";var n=this,r=function(e){var t=$(e);if(t.is(fixNamespace("xsd\\:attribute[ref]"))){var i=t.attr("ref");t=s.getReferencedNode("attribute",i);if(t.length!=1)throw"schema/xsd appears to be invalid, can not find element "+i}if(t.is(fixNamespace("xsd\\:attribute[type], xsd\\:element[type], [name=#text][type]"))){var u=t.attr("type");if(!u.match(/^xsd:/)){var a=s.getReferencedNode("simpleType",u);r(a)}else n.baseType=u;o.isOptional=t.is('[use="optional"]');return}var f=t.find(fixNamespace("> xsd\\:restriction, > xsd\\:extension, > xsd\\:simpleType > xsd\\:restriction, > xsd\\:simpleType > xsd\\:extension"));f.each(function(){var e=$(this).attr("base");if(!e.match(/^xsd:/)){var t=s.getReferencedNode("simpleType",e);r(t)}else n.baseType=e}),f.find(fixNamespace("> xsd\\:pattern")).each(function(){var e=$(this).attr("value");o.pattern.push(e)}),f.find(fixNamespace("> xsd\\:enumeration")).each(function(){var e=$(this).attr("value");o.enumerations.push(e)}),n.baseType==undefined&&(n.baseType="xsd:anyType"),o.bases.push(n.baseType)};n.isValueValid=function(e){if(n.baseType==undefined)throw"something is wrong, do not have a baseType for type";if(e==""&&o.isOptional==1)return!0;if(-1==n.baseType.search(/^xsd:/)){var t=s.getTypeNode("simple",n.baseType),r=new SchemaSimpleType(t,s);return r.isValueValid(e)}switch(n.baseType){case"xsd:string":case"xsd:anyURI":case"xsd:anyType":if(typeof e!="string")return!1;break;case"xsd:decimal":if(!e.match(/^[-+]?[0-9]*(\.[0-9]+)?$/))return!1;break;case"xsd:nonNegativeInteger":if(!e.match(/^[+]?[0-9]+$/))return!1;break;case"xsd:integer":if(!e.match(/^[-+]?[0-9]+$/))return!1;break;case"xsd:float":if(!e.match(/^[-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?$/))return!1;break;case"xsd:boolean":if(!e.match(/^(true|false|0|1)$/))return!1;break;default:throw"not implemented baseType "+n.baseType}if(o.enumerations.length>0&&-1==$.inArray(e,o.enumerations))return!1;if(o.pattern.length>0){var i=!0;$.each(o.pattern,function(t,n){var r=regexFromString("^"+n+"$");0==r.test(e)&&(i=!1)});if(0==i)return!1}return!0},n.getEnumeration=function(){return n.baseType=="xsd:boolean"?["true","false"]:o.enumerations},n.setIsOptional=function(e){o.isOptional=o.isOptional||e};var i=$(e),s=t;if(s==undefined)throw"programming error, schema is not defined";var o={pattern:[],enumerations:[],bases:[],isOptional:undefined};n.baseType=undefined,r(i)},SchemaAttribute=function(e,t){var n=this,r=function(e){var t=$(e);if(t.is("[name]"))return t.attr("name");if(t.is("[ref]")){var n=t.attr("ref"),r=u.getReferencedNode("attribute",n);if(r.length!=1)throw"schema/xsd appears to be invalid, can not find element "+n;return r.attr("name")}return"unknown"};n.isValueValid=function(e){return a.isValueValid(e)},n.getTypeString=function(){var e=a.baseType;return e.match(/xsd\:/)?e.replace(/xsd\:/,""):Messages.schema.complexType};var i=undefined;n.getAppinfo=function(){if(undefined!=i)return i;var e=[];$.each(o.find(fixNamespace("> xsd\\:annotation > xsd\\:appinfo")),function(t,n){var r=$(n).text();e.push(r)});if(o.is("[ref]")){var t=o.attr("ref"),n=u.getReferencedNode("attribute",t);$.each(n.find(fixNamespace("> xsd\\:annotation > xsd\\:appinfo")),function(t,n){var r=$(n).text();e.push(r)})}return i=e,e};var s=undefined;n.getDocumentation=function(){if(undefined!=s)return s;var e=[],t=Messages.language,n="> xsd\\:annotation > xsd\\:documentation[xml\\:lang="+t+"]";$.each(o.find(fixNamespace(n)),function(t,n){var r=$(n).text();e.push(r)});if(o.is("[ref]")){var r=o.attr("ref"),i=u.getReferencedNode("attribute",r);$.each(i.find(fixNamespace(n)),function(t,n){var r=$(n).text();e.push(r)})}return s=e,e},n.getEnumeration=function(){return a.getEnumeration()};var o=$(e),u=t;if(u==undefined)throw"programming error, schema is not defined";n.isOptional=o.attr("use")=="required"?!1:!0,n.name=r(o),n.defaultValue=o.attr("default");var a=new SchemaSimpleType(o,u);a.setIsOptional(n.isOptional)},SchemaElement=function(e,t){var n=this;n.type="element";var r=function(e){var t=$(e);if(t.is("[name]"))return t.attr("name");if(t.is("[ref]")){var n=t.attr("ref"),r=a.getReferencedNode("element",n);if(r.length!=1)throw"schema/xsd appears to be invalid, can not find element "+n;return r.attr("name")}return"unknown"},i=function(){var e;return f.is("[type]")?f.attr("type").match(/^xsd:/)?e=f:e=a.getTypeNode("complex",f.attr("type")):f.is("[ref]")||(e=f.find(fixNamespace("> xsd\\:complexType"))),e};n.getAllowedContent=function(){if(!0===d)return c;if(l.children(fixNamespace("xsd\\:simpleContent")).length>0)c._text=new SchemaSimpleType(l.children(fixNamespace("xsd\\:simpleContent")),a);else if(l.children(fixNamespace("xsd\\:choice, xsd\\:sequence, xsd\\:group")).length>0){var e=l.children(fixNamespace("xsd\\:choice, xsd\\:sequence, xsd\\:group")).get(0);switch(e.nodeName){case"xsd:choice":case"choice":c._grouping=new SchemaChoice(e,a);break;case"xsd:sequence":case"sequence":c._grouping=new SchemaSequence(e,a);break;case"xsd:group":case"group":c._grouping=new SchemaGroup(e,a)}delete e}else{if(!l.is("[type]")||!l.attr("type").match(/^xsd:/))return c;c._text=new SchemaSimpleType(l,a)}var t=l.find(fixNamespace("> xsd\\:element"),f);return t.each(function(){var e=new SchemaElement(this),t=e.name;c[t]=e}),d=!0,c},n.setIsSortable=function(e){p=e},n.isSortable=function(){return p},n.areChildrenSortable=function(){var e=n.getAllowedContent();return e._grouping==undefined?undefined:!e._grouping.elementsHaveOrder},n.getRequiredElements=function(){var e=n.getAllowedContent();return e._grouping!=undefined?e._grouping.getRequiredElements():[]},n.getAllowedElements=function(){var e=n.getAllowedContent(),t={};return e._grouping!=undefined&&$.extend(t,e._grouping.getAllowedElements()),!0===n.isMixed&&(t["#text"]=a.getTextNodeSchemaElement()),t},n.getAllowedElementsSorting=function(){var e=n.getAllowedContent();return e._grouping!=undefined?e._grouping.getAllowedElementsSorting():undefined},n.getChildBounds=function(){var e=n.getAllowedContent();return e._grouping==undefined?undefined:!0===e._grouping.hasMultiLevelBounds()?undefined:e._grouping.getBounds()},n.getBoundsForElementName=function(e){var t=n.getAllowedContent();return t._grouping.getBoundsForElementName(e)},n.getBounds=function(){return h};var s=function(){var e={},t=l.find(fixNamespace("> xsd\\:attribute, > xsd\\:simpleContent > xsd\\:extension > xsd\\:attribute")),n=l.find(fixNamespace("> xsd\\:attributeGroup, > xsd\\:simpleContent > xsd\\:extension > xsd\\:attributeGroup"));return n.each(function(){var e={};$(this).is("[ref]")?e=a.getReferencedNode("attributeGroup",$(this).attr("ref")):e=$(this),e.children(fixNamespace("xsd\\:attribute")).each(function(){t.push(this)})}),t.each(function(){var t=new SchemaAttribute(this,a);e[t.name]=t}),e};n.isTextContentAllowed=function(){if(n.isMixed==1)return!0;var e=n.getAllowedContent();return e._text!=undefined&&e._text!=0?!0:!1},n.isChildElementAllowed=function(e){if(e=="#text")return n.isTextContentAllowed();var t=n.getAllowedContent();return t._grouping==undefined?!1:t._grouping!=undefined?t._grouping.isElementAllowed(e):!1};var o=undefined;n.getAppinfo=function(){if(undefined!=o)return o;var e=[];return $.each(f.find(fixNamespace("> xsd\\:annotation > xsd\\:appinfo")),function(t,n){var r=$(n).text();e.push(r)}),f.find(fixNamespace("> xsd\\:complexType")).length==0&&$.each(l.find(fixNamespace("> xsd\\:annotation > xsd\\:appinfo")),function(t,n){var r=$(n).text();e.push(r)}),o=e,e};var u=undefined;n.getDocumentation=function(){if(undefined!=u)return u;var e=[],t=Messages.language,n="> xsd\\:annotation > xsd\\:documentation[xml\\:lang="+t+"]";return $.each(f.find(fixNamespace(n)),function(t,n){var r=$(n).text();e.push(r)}),f.find(fixNamespace("> xsd\\:complexType")).length==0&&$.each(l.find(fixNamespace(n)),function(t,n){var r=$(n).text();e.push(r)}),u=e,e},n.getSchemaElementForElementName=function(e){if(e=="#text")return!1===n.isTextContentAllowed()?undefined:a.getTextNodeSchemaElement();var t=n.getAllowedContent();return t._grouping==undefined?undefined:t._grouping.isElementAllowed(e)?t._grouping.getSchemaElementForElementName(e):undefined},n.getSchemaDOM=function(){return a.getSchemaDOM()},n.isValueValid=function(e){if(0==n.isTextContentAllowed())return!1;if(!0===n.isMixed)return!0;var t=n.getAllowedContent();return t._text.isValueValid(e)},n.getRegex=function(e,t){if(typeof e=="undefined"||e==undefined)e="";var r="(";t&&(r+="?:"),r+=n.name+e+")";var i="",s="";h.min!=undefined&&h.min!="unbounded"&&(i=h.min),h.max!=undefined&&h.max!="unbounded"&&(s=h.max);if(i!=""||s!="")r+="{"+i+","+s+"}";return r},n.getChildrenRegex=function(e,t){if(typeof e=="undefined"||e==undefined)e="";var r=n.getAllowedContent();if(r._grouping==undefined)return"^";var i=r._grouping.getRegex(e,t);return i};var a=t;if(a==undefined)throw"programming error, schema is not defined";var f=$(e),l=i();n.name=r(f),n.allowedAttributes=s();var c={_grouping:undefined,_text:!1},h={min:f.attr("minOccurs")!=undefined?f.attr("minOccurs"):0,max:f.attr("maxOccurs")!=undefined?f.attr("maxOccurs"):"unbounded"},p=undefined;n.isMixed=l.is("[mixed=true]"),n.defaultValue=f.attr("default");var d=!1},SchemaChoice=function(e,t){var n=this;n.type="choice",n.elementsHaveOrder=!1;var r=function(){f={min:s.attr("minOccurs")!=undefined?s.attr("minOccurs"):1,max:s.attr("maxOccurs")!=undefined?s.attr("maxOccurs"):1};var e=s.find(fixNamespace("> xsd\\:element"));e.each(function(){var e=new SchemaElement(this,o);e.setIsSortable(!0);var t=e.name;u[t]=e}),$.each(s.find(fixNamespace("> xsd\\:choice")),function(e,t){a.push(new SchemaChoice(t,o))}),$.each(s.find(fixNamespace("> xsd\\:sequence")),function(e,t){a.push(new SchemaSequence(t,o))}),$.each(s.find(fixNamespace("> xsd\\:group")),function(e,t){a.push(new SchemaGroup(t,o))})};n.isElementAllowed=function(e){if(typeof u[e]!="undefined")return!0;for(var t=0;t<a.length;++t)if(1==a[t].isElementAllowed(e))return!0;return!1},n.getSchemaElementForElementName=function(e){if(typeof u[e]!="undefined")return u[e];for(var t=0;t<a.length;++t)if(1==a[t].isElementAllowed(e))return a[t].getSchemaElementForElementName(e);return undefined},n.getRequiredElements=function(){return[]},n.getAllowedElements=function(){var e={};return $.each(u,function(t,n){e[t]=n}),$.each(a,function(t,n){$.extend(e,n.getAllowedElements())}),e},n.getAllowedElementsSorting=function(e){var t={};return $.each(u,function(n,r){var i="x";e!==undefined&&(i=e+"."+i);if(r.type=="element")t[r.name]=i;else{var s=r.getAllowedElementsSorting(i);$.extend(t,s)}}),$.each(a,function(n,r){var i="x";e!==undefined&&(i=e+"."+i);if(r.type=="element")t[r.name]=i;else{var s=r.getAllowedElementsSorting(i);$.extend(t,s)}}),t};var i=undefined;n.getRegex=function(e,t){if(i!=undefined)return i;var n="";n="(",t&&(n+="?:");var r=[];return $.each(u,function(n,i){r.push(i.getRegex(e,t))}),$.each(a,function(n,i){r.push(i.getRegex(e,t))}),n+=r.join("|"),n+=")",n+="{",f.min!="unbounded"&&(n+=f.min==undefined?1:f.min),n+=",",f.max!="unbounded"&&(n+=f.max==undefined?1:f.max),n+="}",i=n,n},n.hasMultiLevelBounds=function(){return a.length>0?!0:!1},n.getBounds=function(){return f},n.getBoundsForElementName=function(e){return!0===n.isElementAllowed(e)?n.getBounds():undefined};var s=$(e),o=t;if(o==undefined)throw"programming error, schema is not defined";var u={},a=[],f={min:undefined,max:undefined};r()},SchemaGroup=function(e,t){var n=this;n.type="group",n.elementsHaveOrder=undefined;var r=function(){a={min:s.attr("minOccurs")!=undefined?s.attr("minOccurs"):1,max:s.attr("maxOccurs")!=undefined?s.attr("maxOccurs"):1};var e=s;e.is("[ref]")&&(e=o.getReferencedNode("group",e.attr("ref"))),$.each(e.find(fixNamespace("> xsd\\:choice")),function(e,t){u.push(new SchemaChoice(t,o))}),$.each(e.find(fixNamespace("> xsd\\:sequence")),function(e,t){u.push(new SchemaSequence(t,o))}),u.length>0&&(u=[u[0]])};n.isElementAllowed=function(e){for(var t=0;t<u.length;++t)if(1==u[t].isElementAllowed(e))return!0;return!1},n.getSchemaElementForElementName=function(e){for(var t=0;t<u.length;++t)if(1==u[t].isElementAllowed(e))return u[t].getSchemaElementForElementName(e);return undefined},n.getRequiredElements=function(){return u[0].getRequiredElements()},n.getAllowedElements=function(){return u[0].getAllowedElements()},n.getAllowedElementsSorting=function(e){var t={};return $.each(n.getAllowedElements(),function(n,r){var i="x";e!==undefined&&(i=e+"."+i);if(r.type=="element")t[r.name]=i;else{var s=r.getAllowedElementsSorting(i);$.extend(t,s)}}),t};var i=undefined;n.getRegex=function(e,t){if(i!=undefined)return i;var n="";return $.each(u,function(r,i){n="(",t&&(n+="?:"),n+=i.getRegex(e,t)+")"}),n+="{",a.min!="unbounded"&&(n+=a.min==undefined?1:a.min),n+=",",a.max!="unbounded"&&(n+=a.max==undefined?1:a.max),n+="}",i=n,n},n.hasMultiLevelBounds=function(){return u.length>0?!0:!1},n.getBounds=function(){return a},n.getBoundsForElementName=function(e){return u[0].getBoundsForElementName(e)};var s=$(e),o=t;if(o==undefined)throw"programming error, schema is not defined";var u=[],a={min:undefined,max:undefined};r()},SchemaSequence=function(e,t){var n=this;n.type="sequence",n.elementsHaveOrder=!0;var r=function(){l={min:s.attr("minOccurs")!=undefined?s.attr("minOccurs"):1,max:s.attr("maxOccurs")!=undefined?s.attr("maxOccurs"):1};var e=s.children();e.each(function(){var e=$(this),t=undefined;switch(this.nodeName){case"xsd:element":case"element":t=new SchemaElement(this,o),t.setIsSortable(!1),u[t.name]=t;break;case"xsd:choice":case"choice":t=new SchemaChoice(this,o),f.push(t);break;case"xsd:sequence":case"sequence":t=new SchemaSequence(this,o),f.push(t);break;case"xsd:group":case"group":t=new SchemaGroup(this,o),f.push(t)}a.push(t)})};n.isElementAllowed=function(e){if(typeof u[e]!="undefined")return!0;for(var t=0;t<f.length;++t)if(1==f[t].isElementAllowed(e))return!0;return!1},n.getSchemaElementForElementName=function(e){if(typeof u[e]!="undefined")return u[e];for(var t=0;t<f.length;++t)if(1==f[t].isElementAllowed(e))return f[t].getSchemaElementForElementName(e);return undefined},n.getRequiredElements=function(){if(l.min==0)return[];var e=[];return $.each(u,function(t,n){if(n.getBounds().min>0)for(var r=0;r<n.getBounds().min;++r)e.push(t)}),$.each(f,function(t,n){var r=n.getRequiredElements();if(r.length>0)for(t=0;t<r.length;++t)e.push(r[t])}),e},n.getAllowedElements=function(){var e={};return $.each(u,function(t,n){e[t]=n}),$.each(f,function(t,n){$.extend(e,n.getAllowedElements())}),e},n.getAllowedElementsSorting=function(e){var t={};return $.each(a,function(n,r){var i=n;e!==undefined&&(i=e+"."+n);if(r.type=="element")t[r.name]=i;else{var s=r.getAllowedElementsSorting(i);$.extend(t,s)}}),t};var i;n.getRegex=function(e,t){if(i!=undefined)return i;var n="";n="(",t&&(n+="?:");var r=[];return $.each(a,function(n,i){r.push(i.getRegex(e,t))}),n+=r.join(""),n+=")",n+="{",l.min!="unbounded"&&(n+=l.min==undefined?1:l.min),n+=",",l.max!="unbounded"&&(n+=l.max==undefined?1:l.max),n+="}",i=n,n},n.hasMultiLevelBounds=function(){return f.length>0?!0:!1},n.getBounds=function(){return l},n.getBoundsForElementName=function(e){if(typeof u[e]!="undefined"){var t=u[e].getBounds(),r=n.getBounds(),i={min:1,max:1};return t.min=="unbounded"||r.min=="unbounded"?i.min="unbounded":(t.min!="undefined"&&(i.min=t.min),r.min!="undefined"&&(i.min=i.min*r.min)),t.max=="unbounded"||r.max=="unbounded"?i.max="unbounded":(t.max!="undefined"&&(i.max=t.max),r.max!="undefined"&&(i.max=i.max*r.max)),i}var s=undefined,o;for(var a=0;a<f.length;++a){o=f[a].getBoundsForElementName(e);if(undefined!==o){s=o;break}}return s};var s=$(e),o=t;if(o==undefined)throw"programming error, schema is not defined";var u={},a=[],f=[],l={min:undefined,max:undefined};r()},regexFromString=function(e,t){return t==undefined&&(t=""),new RegExp(e,t)},fixNamespace=function(e){return 1==$.browser.webkit&&(e.match(",")||(e=e.replace(/(>\s*)xsd\\:(\S*)/g,"$1$2"),e=e.replace(/xsd\\:(\S*[=]+[^\s,$]*)(\s|,|$)/g,"$1$2"))),e};