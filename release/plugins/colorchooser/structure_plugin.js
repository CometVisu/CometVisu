/*!
 * Farbtastic: jQuery color picker plug-in v1.3u
 *
 * Licensed under the GPL license:
 *   http://www.gnu.org/licenses/gpl.html
 */

/* structure_plugin.js (c) 2010 by Christian Mayer [CometVisu at ChristianMayer dot de]
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 3 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA
*/

(function(e){e.fn.farbtastic=function(t){return e.farbtastic(this,t),this},e.farbtastic=function(t,n){var t=e(t).get(0);return t.farbtastic||(t.farbtastic=new e._farbtastic(t,n))},e._farbtastic=function(t,n){var r=this;e(t).html('<div class="farbtastic"><div class="color"></div><div class="wheel"></div><div class="overlay"></div><div class="h-marker marker"></div><div class="sl-marker marker"></div></div>');var i=e(".farbtastic",t);r.wheel=e(".wheel",t).get(0),r.radius=84,r.square=100,r.width=194,navigator.appVersion.match(/MSIE [0-6]\./)&&e("*",i).each(function(){if(this.currentStyle.backgroundImage!="none"){var t=this.currentStyle.backgroundImage;t=this.currentStyle.backgroundImage.substring(5,t.length-2),e(this).css({backgroundImage:"none",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=crop, src='"+t+"')"})}}),r.linkTo=function(t){typeof r.callback=="object"&&e(r.callback).unbind("keyup",r.updateValue),r.color=null;if(typeof t=="function")r.callback=t;else if(typeof t=="object"||typeof t=="string")r.callback=e(t),r.callback.bind("keyup",r.updateValue),r.callback.get(0).value&&r.setColor(r.callback.get(0).value);return this},r.updateValue=function(e){this.value&&this.value!=r.color&&r.setColor(this.value)},r.setColor=function(e){var t=r.unpack(e);return r.color!=e&&t&&(r.color=e,r.rgb=t,r.hsl=r.RGBToHSL(r.rgb),r.updateDisplay()),this},r.setHSL=function(e){return r.hsl=e,r.rgb=r.HSLToRGB(e),r.color=r.pack(r.rgb),r.updateDisplay(),this},r.widgetCoords=function(t){var n=e(r.wheel).offset();return{x:t.pageX-n.left-r.width/2,y:t.pageY-n.top-r.width/2}},r.mousedown=function(t){document.dragging||(e(document).bind("mousemove",r.mousemove).bind("mouseup",r.mouseup),document.dragging=!0);var n=r.widgetCoords(t);return r.circleDrag=Math.max(Math.abs(n.x),Math.abs(n.y))*2>r.square,r.mousemove(t),!1},r.mousemove=function(e){var t=r.widgetCoords(e);if(r.circleDrag){var n=Math.atan2(t.x,-t.y)/6.28;n<0&&(n+=1),r.setHSL([n,r.hsl[1],r.hsl[2]])}else{var i=Math.max(0,Math.min(1,-(t.x/r.square)+.5)),s=Math.max(0,Math.min(1,-(t.y/r.square)+.5));r.setHSL([r.hsl[0],i,s])}return!1},r.mouseup=function(){e(document).unbind("mousemove",r.mousemove),e(document).unbind("mouseup",r.mouseup),document.dragging=!1},r.updateDisplay=function(){var t=r.hsl[0]*6.28;e(".h-marker",i).css({left:Math.round(Math.sin(t)*r.radius+r.width/2)+"px",top:Math.round(-Math.cos(t)*r.radius+r.width/2)+"px"}),e(".sl-marker",i).css({left:Math.round(r.square*(.5-r.hsl[1])+r.width/2)+"px",top:Math.round(r.square*(.5-r.hsl[2])+r.width/2)+"px"}),e(".color",i).css("backgroundColor",r.pack(r.HSLToRGB([r.hsl[0],1,.5]))),typeof r.callback=="object"?(e(r.callback).css({backgroundColor:r.color,color:r.hsl[2]>.5?"#000":"#fff"}),e(r.callback).each(function(){this.value&&this.value!=r.color&&(this.value=r.color)})):typeof r.callback=="function"&&r.callback.call(r,r.color)},r.pack=function(e){var t=Math.round(e[0]*255),n=Math.round(e[1]*255),r=Math.round(e[2]*255);return"#"+(t<16?"0":"")+t.toString(16)+(n<16?"0":"")+n.toString(16)+(r<16?"0":"")+r.toString(16)},r.unpack=function(e){if(e.length==7)return[parseInt("0x"+e.substring(1,3))/255,parseInt("0x"+e.substring(3,5))/255,parseInt("0x"+e.substring(5,7))/255];if(e.length==4)return[parseInt("0x"+e.substring(1,2))/15,parseInt("0x"+e.substring(2,3))/15,parseInt("0x"+e.substring(3,4))/15]},r.HSLToRGB=function(e){var t,n,r,i,s,o=e[0],u=e[1],a=e[2];return n=a<=.5?a*(u+1):a+u-a*u,t=a*2-n,[this.hueToRGB(t,n,o+.33333),this.hueToRGB(t,n,o),this.hueToRGB(t,n,o-.33333)]},r.hueToRGB=function(e,t,n){return n=n<0?n+1:n>1?n-1:n,n*6<1?e+(t-e)*n*6:n*2<1?t:n*3<2?e+(t-e)*(.66666-n)*6:e},r.RGBToHSL=function(e){var t,n,r,i,s,o,u=e[0],a=e[1],f=e[2];return t=Math.min(u,Math.min(a,f)),n=Math.max(u,Math.max(a,f)),r=n-t,o=(t+n)/2,s=0,o>0&&o<1&&(s=r/(o<.5?2*o:2-2*o)),i=0,r>0&&(n==u&&n!=a&&(i+=(a-f)/r),n==a&&n!=f&&(i+=2+(f-u)/r),n==f&&n!=u&&(i+=4+(u-a)/r),i/=6),[i,s,o]},e("*",i).mousedown(r.mousedown),r.setColor("#000000"),n&&r.linkTo(n)}})(jQuery),define("plugins/colorchooser/farbtastic/farbtastic",function(){}),define("plugins/colorchooser/structure_plugin",["structure_custom","css!plugins/colorchooser/farbtastic/farbtastic.css","plugins/colorchooser/farbtastic/farbtastic"],function(e){e.prototype.addCreator("colorchooser",{create:function(e,t){var n=$(e),r=templateEngine.design.setWidgetLayout(n,t),i='<div class="widget clearfix colorChooser'+r+'">',s=n.find("label")[0];i+=s?'<div class="label">'+s.textContent+"</div>":"";var o=templateEngine.design.makeAddressList(n,function(e,t,n,r){return[!0,r]},t),u='<div class="actor" />',a=templateEngine.widgetDataInsert(t,{address:o,value_r:0,value_g:0,value_b:0,bus_r:0,bus_g:0,bus_b:0,rateLimiter:!1,type:"colorChooser"});return templateEngine.postDOMSetupFns.push(function(){var e=$("#"+t+" .actor");e.farbtastic(function(t){function n(e){var t=!1,r=a.address,i=a.value_r,s=a.value_g,o=a.value_b,u=a.bus_r,f=a.bus_g,l=a.bus_b;for(var c in r){if(!(r[c][1]&2))continue;switch(r[c][2]){case"r":var h=Transform[r[c][0]].encode(i);h!=Transform[r[c][0]].encode(u)&&(templateEngine.visu.write(c,h),t=!0);break;case"g":var h=Transform[r[c][0]].encode(s);h!=Transform[r[c][0]].encode(f)&&(templateEngine.visu.write(c,h),t=!0);break;case"b":var h=Transform[r[c][0]].encode(o);h!=Transform[r[c][0]].encode(l)&&(templateEngine.visu.write(c,h),t=!0);break;case"rgb":var p=[i*255/100,s*255/100,o*255/100],d=[u*255/100,f*255/100,l*255/100],h=Transform[r[c][0]].encode(p),o=Transform[r[c][0]].encode(d);if(h[0]!=o[0]||h[1]!=o[1]||h[2]!=o[2])templateEngine.visu.write(c,h),t=!0}}t?(a.bus_r=a.value_r,a.bus_g=a.value_g,a.bus_b=a.value_b,a.rateLimiter=!0,setTimeout(function(){n(e)},250)):a.rateLimiter=!1}a.value_r=parseInt(t.substring(1,3),16)*100/255,a.value_g=parseInt(t.substring(3,5),16)*100/255,a.value_b=parseInt(t.substring(5,7),16)*100/255,a.rateLimiter==0&&n(e)})}),i+u+"</div>"},update:function(e,t){function n(e){var t=parseInt(e).toString(16);return t.length==1?"0"+t:t}var r=$(this),i=templateEngine.widgetDataGetByElement(this),s=templateEngine.transformDecode(i.address[e][0],t),o=jQuery.farbtastic(r.find(".actor")),u=o.color||"#000000";switch(i.address[e][2]){case"r":i.bus_r=s,u=u.substring(0,1)+n(s*255/100)+u.substring(3);break;case"g":i.bus_g=s,u=u.substring(0,3)+n(s*255/100)+u.substring(5);break;case"b":i.bus_b=s,u=u.substring(0,5)+n(s*255/100)+u.substring(7);break;case"rgb":i.bus_r=s[0],i.bus_g=s[1],i.bus_b=s[2],u=u.substring(0,1)+n(s[0])+n(s[1])+n(s[2])+u.substring(7)}o.setColor(u)}})});