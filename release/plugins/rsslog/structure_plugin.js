/* structure_plugin.js (c) 2011 by Michael Markstaller [devel@wiregate.de]
 * rsslog (c) 2012 by Jan N. Klug [jan.n.klug@rub.de]
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 3 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA
*/

//console.log('C: #%s, Success, Feed: %s', $(c).attr('id'), o.src);

//console.log('C: #%s, %i element(s) found, %i displayrow(s) available', $(c).attr('id'), itemnum, displayrows);

//console.log('C: #%s, processing item: %i of %i', $(c).attr('id'), i, itemnum);

define("plugins/rsslog/structure_plugin",["structure_custom","css!plugins/rsslog/rsslog"],function(VisuDesign_Custom){function refreshRSSlog(data,isBig){var src=data.src,filter=data.filter;filter&&(src.match(/\?/)?src+="&f="+filter:src+="?f="+filter);var refresh=data.refresh,limit=data.limit;return $("#"+data.id+(isBig?"_big":"")).rssfeedlocal({src:src,datetime:eval(data.datetime),mode:data.mode,timeformat:data.timeformat,itemack:data.itemack}),typeof refresh!="undefined"&&refresh&&window.setTimeout(function(){refreshRSSlog(data,isBig)},refresh*1e3),!1}VisuDesign_Custom.prototype.addCreator("rsslog",{create:function(e,t,n,r){var i=$(e),s=templateEngine.design.setWidgetLayout(i,t),o=templateEngine.design.extractLabel(i.find("label")[0],n),u="rss_"+t,a=!1,f='<div class="widget clearfix rsslog '+s+'" >';o&&(f+=o),f+='<div class="actor rsslogBody"><div class="rsslog_inline" id="'+u+'" style="',i.attr("width")&&(f+="width:"+i.attr("width")+";"),i.attr("height")&&(f+="height:"+i.attr("height")),f+='"></div></div>',f+="</div>";var l=templateEngine.widgetDataInsert(t,{id:u,src:i.attr("src"),filter:i.attr("filter"),refresh:i.attr("refresh"),datetime:i.attr("datetime")||!0,mode:i.attr("mode")||"last",timeformat:i.attr("timeformat"),itemoffset:0,itemack:0});return templateEngine.bindActionForLoadingFinished(function(){refreshRSSlog(l)}),$(window).bind("scrolltopage",function(e,n){var r=templateEngine.getParentPageFromPath(t);r!=null&&n==r.attr("id")&&refreshRSSlog(l)}),f},action:function(e,t,n){if(n)return;var r=templateEngine.widgetDataGet(e),i=$('<div class="rsslog_popup" id="'+r.id+'_big"/>');templateEngine.showPopup("rsslog",{title:$("#"+e+" .label").text()||"",content:i}),i.parent("div").css({height:"90%",width:"90%",margin:"auto"}),r.refresh="",r.itemack=1,$(i).bind("click",function(e){e.stopPropagation()}).bind("remove",function(){refreshRSSlog(r)}),$(i).parent().css("overflow","auto"),refreshRSSlog(r,!0)}}),function(e){jQuery.fn.extend({rssfeedlocal:function(t){var n={src:"",html:"<span>{text}</span>",wrapper:"li",dataType:"json",datetime:!0},t=jQuery.extend(n,t);return t.datetime&&(t.html="{date}: "+t.html),this.each(function(){var n=t,r=jQuery(this),i=!1;if(n.src==""){console.log("rssfeedlocal: no src URL");return}if(!n.src.match(/rsslog\.php/)&&!n.src.match(/rsslog_mysql\.php/)){i=!0;var s="plugins/rsslog/rsslog_external.php?url=";n.src=s.concat(n.src)}else n.src.match(/\?/)?n.src+="&j":n.src+="?j";jQuery.ajax({url:n.src,type:"GET",dataType:n.dataType,error:function(t,i,s){console.log("C: #%s, Error: %s, Feed: %s",e(r).attr("id"),s,n.src)},success:function(t){r.html("");var i=r.data("last_rowcount")||0,s=e('<li class="rsslogRow odd" id="dummydiv">.</li>').appendTo(r),u=s.height();s.remove();if(u!=0){var a=r.parent().parent(),f=a.height()-e(".label",a).height();i=Math.floor(f/u)}r.data("last_rowcount",i);var l=t.responseData.feed.entries,h=l.length,p=0;h>i&&(n.mode=="first"&&(p=h-i),n.mode=="rollover"&&(p=r.data("itemoffset")||0,p==h&&(p=0),r.data("itemoffset",p+1)));var d="rsslogodd",v=p+i;v=v>h?h:v;var m=(new Date).strftime("%d"),g=!1,y=!1;for(var b=p;b<v;b++){var w=b;w=b>=h?w-=h:w;var E=l[w],S=n.html;S=S.replace(/{text}/,E.content);var x=new Date(E.publishedDate);if(x){S=n.timeformat?S.replace(/{date}/,x.strftime(n.timeformat)+"&nbsp;"):S.replace(/{date}/,x.toLocaleDateString()+" "+x.toLocaleTimeString()+"&nbsp;");var T=x.strftime("%d");g=m>0&&m!=T,m=T}else S=S.replace(/{date}/,"");var N=e('<li class="rsslogRow '+d+'">').append(S);g&&(N.addClass("rsslog_separator"),y=!0),y==1&&N.addClass(" rsslog_prevday"),N.data("id",E.id);if(E.tags){var C=e("span",N);e.each(E.tags,function(e,t){C.addClass(t)})}E.state==1&&N.addClass("rsslog_ack"),n.itemack&&N.bind("click",function(){var t=e(this),r=t.data("id");t.toggleClass("rsslog_ack");var i=t.hasClass("rsslog_ack"),s=n.src.split("?")[0]+"?u="+r+"&state="+Number(i);jQuery.ajax({url:s,type:"GET",error:function(e,t,n){console.log("ID: #%s, Error: %s, URL: %s",r,n,s)}})}),r.append(N),d=d=="rsslogodd"?"rsslogeven":"rsslogodd"}e("li",r).wrapAll("<ul>")}})})}})}(jQuery)});