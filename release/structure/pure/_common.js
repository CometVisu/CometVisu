/* _common.js (c) 2010 by Christian Mayer [CometVisu at ChristianMayer dot de]
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 3 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA
 */

define(["jquery"],function(e){function n(){var t=this;this.creators={},this.addCreator=function(e,t){this.creators[e]=t},this.getCreator=function(e){return this.creators[e]===undefined?this.creators.unknown:this.creators[e]};var n={};this.addPopup=function(e,t){n[e]=t,n[e].type=e},this.getPopup=function(e){var t=n[e];return t===undefined?n.unknown:n[e]},this.addPopup("unknown",{create:function(t){var n=!1,i=e('<div class="popup" style="display:none"/><div class="popup_background" style="display:none" />').appendTo("body");i.addClass(this.type),t.title&&i.filter(".popup").append(e('<div class="head" />').append(t.title)),t.content&&i.filter(".popup").append(e('<div class="main" />').append(t.content)),t.width&&(i.width(t.width),reposition=!0),t.height&&(i.height(t.height),reposition=!0);var s={x:-1,y:-1,w:0,h:0},o;if(t.position)if(t.position.offset){var u=t.position.offset();s.x=u.left,s.y=u.top,s.w=t.position.width(),s.h=t.position.height()}else t.position.hasOwnProperty("x")&&(s.x=t.position.x),t.position.hasOwnProperty("y")&&(s.y=t.position.y),t.position.hasOwnProperty("w")&&(s.w=t.position.w),t.position.hasOwnProperty("h")&&(s.h=t.position.h),s.w==0&&s.h==0&&(o=5);t.align!==undefined&&(o=t.align);var a=r(s,{w:i.outerWidth(),h:i.outerHeight()},{w:e(window).width(),h:e(window).height()},o);return i.css("left",a.x),i.css("top",a.y),i.bind("close",this.close),i.bind("click",function(){return i.trigger("close"),!1}),i.css("display","block"),i},close:function(e){e.currentTarget.remove()}}),this.addPopup("info",e.extend(!0,{},this.getPopup("unknown"))),this.addPopup("warning",e.extend(!0,{},this.getPopup("unknown"))),this.addPopup("error",e.extend(!0,{},this.getPopup("unknown"))),this.defaultValueHandling=function(e,t,n){if(undefined!==e)var r=n.address[e][0],i=templateEngine.transformDecode(r,t);else var r="",i=t;n.basicvalue=i,i=templateEngine.map(i,n.mapping),n.precision&&(i=Number(i).toPrecision(n.precision)),n.format&&(i=sprintf(n.format,i)),n.value=i;if(undefined!==i&&i.constructor==Date)switch(r){case"DPT:10.001":i=i.toLocaleTimeString();break;case"DPT:11.001":i=i.toLocaleDateString();break;case"OH:datetime":i=i.toLocaleDateString();break;case"OH:time":i=i.toLocaleTimeString()}return i},this.defaultUpdate=function(n,r,i,s,o){var u=i||e(this),a=templateEngine.widgetData[o],f=s?u.find('.actor:has(".value")'):u,l=t.defaultValueHandling(n,r,a);templateEngine.setWidgetStyling(f,a.basicvalue,a.styling),a.align&&u.addClass(a.align);var c=u.find(".value");c.empty();if(undefined!==l)if("string"==typeof l||"number"==typeof l)c.append(l);else if("function"==typeof l)l(c);else if(!Array.isArray(l)){var u=l.cloneNode();l.getContext&&fillRecoloredIcon(u),c.append(u)}else for(var h=0;h<l.length;h++){var p=l[h];if(!p)continue;if("string"==typeof p||"number"==typeof p)c.append(p);else if("function"==typeof p)p(c);else{var u=p.cloneNode();p.getContext&&fillRecoloredIcon(u),c.append(u)}}else c.append("-");return l},this.defaultUpdate3d=function(e,t,n){var r=e.data.layout,i=t.building2screen(new THREE.Vector3(r.x,r.y,r.z));e.data.element.css("left",i.x+"px"),e.data.element.css("top",i.y+"px");var s=!0;r.floorFilter&&(s=t.getState("showFloor")==t.buildingProperties.floorNames[r.floorFilter]),e.data.element.css("display",s?"":"none")},this.extractLayout=function(e,t,n){typeof defaultValue=="undefined"&&(n=[]);var r=t=="2d"?"position:absolute;":"";return e.getAttribute("x")?r+="left:"+e.getAttribute("x")+";":n.x&&(r+="left:"+n.x+";"),e.getAttribute("y")?r+="top:"+e.getAttribute("y")+";":n.y&&(r+="top:"+n.y+";"),e.getAttribute("width")?r+="width:"+e.getAttribute("width")+";":n.width&&(r+="width:"+n.width+";"),e.getAttribute("height")?r+="height:"+e.getAttribute("height")+";":n.height&&(r+="height:"+n.height+";"),r},this.extractLayout3d=function(e){var t={};return e.getAttribute("x")&&(t.x=e.getAttribute("x")),e.getAttribute("y")&&(t.y=e.getAttribute("y")),e.getAttribute("z")&&(t.z=e.getAttribute("z")),e.getAttribute("floor")&&(t.floor=e.getAttribute("floor")),e.getAttribute("floorFilter")&&(t.floorFilter=e.getAttribute("floorFilter")),e.getAttribute("roomFilter")&&(t.roomFilter=e.getAttribute("roomFilter")),t},this.extractLabel=function(t,n,r,i){if(!t)return"";if(!r)var s='<div class="'+(undefined===r?"label":r)+'"'+(i?' style="'+i+'"':"")+">";return e(t).contents().each(function(){var t=e(this);t.is("icon")?s+=icons.getIconText(t.attr("name"),t.attr("type"),t.attr("flavour")||n,t.attr("color"),t.attr("styling")):s+=this.textContent}),s+"</div>"},this.makeAddressList=function(e,t,n){var r={};return e.find("address").each(function(){var e=this.textContent,i=this.getAttribute("transform");if(!e||!i)return;var s=3;switch(this.getAttribute("mode")){case"disable":s=0;break;case"read":s=1;break;case"write":s=2;break;case"readwrite":s=3}var o=t?t(e,i,s,this.getAttribute("variant")):[!0,undefined];s&1&&o[0]&&templateEngine.addAddress(e,n),r[e]=[i,s,o[1]];return}),r},this.setWidgetLayout=function(t,n){var r=templateEngine.widgetDataGet(n),i="";return r.colspan=t.children("layout").attr("colspan")||e("head").data("colspanDefault")||6,t.children("layout").attr("rowspan")&&(r.rowspanClass=templateEngine.rowspanClass(t.children("layout").attr("rowspan")||1),i="innerrowspan"),i},this.createDefaultWidget=function(t,n,r,s,o,u,a){var f=n.children("layout")[0],l=f?'style="'+this.extractLayout(f,o)+'"':"",c="widget clearfix "+t;n.attr("align")&&(c+=" "+n.attr("align")),c+=" "+this.setWidgetLayout(n,r),n.attr("flavour")&&(s=n.attr("flavour")),s&&(c+=" flavour_"+s),n.attr("class")&&(c+=" custom_"+n.attr("class"));var h=this.extractLabel(n.find("label")[0],s),p=this.makeAddressList(n,a,r),d=templateEngine.bindClickToWidget;n.attr("bind_click_to_widget")&&(d=n.attr("bind_click_to_widget")=="true"),templateEngine.widgetDataInsert(r,{address:p,bind_click_to_widget:d,mapping:n.attr("mapping"),styling:n.attr("styling"),format:n.attr("format"),align:n.attr("align"),path:r});var v='<div class="'+c+'" '+l+">"+h;return p&&u!=undefined&&templateEngine.postDOMSetupFns.push(function(){i.defaultUpdate(undefined,undefined,e("#"+r),!0,r)}),v},this.defaultButtonDownAnimation=function(e,t){t&&(t.classList.remove("switchUnpressed"),t.classList.add("switchPressed"))},this.defaultButtonDownAnimationInheritAction=function(e,t){t||(t=templateEngine.handleMouseEvent.widget.getElementsByClassName("actor")[0]),t.classList.remove("switchUnpressed"),t.classList.add("switchPressed")},this.defaultButtonUpAnimation=function(e,t){t&&(t.classList.remove("switchPressed"),t.classList.add("switchUnpressed"))},this.defaultButtonUpAnimationInheritAction=function(e,t){t||(t=templateEngine.handleMouseEvent.widget.getElementsByClassName("actor")[0]),t.classList.remove("switchPressed"),t.classList.add("switchUnpressed")}}function r(e,t,n,r){var i=[8,2,6,4,9,3,7,1,5,0];r!==undefined&&i.unshift(r);for(var s in i){var o={};switch(i[s]){case 0:return{x:(n.w-t.w)/2,y:(n.h-t.h)/2};case 1:o.x=e.x-t.w,o.y=e.y+e.h;break;case 2:o.x=e.x+e.w/2-t.w/2,o.y=e.y+e.h;break;case 3:o.x=e.x+e.w,o.y=e.y+e.h;break;case 4:o.x=e.x-t.w,o.y=e.y+e.h/2-t.h/2;break;case 5:o.x=e.x+e.w/2-t.w/2,o.y=e.y+e.h/2-t.h/2;break;case 6:o.x=e.x+e.w,o.y=e.y+e.h/2-t.h/2;break;case 7:o.x=e.x-t.w,o.y=e.y-t.h;break;case 8:o.x=e.x+e.w/2-t.w/2,o.y=e.y-t.h;break;case 9:o.x=e.x+e.w,o.y=e.y-t.h}if(o.x>=0&&o.y>=0&&o.x+t.w<=n.w&&o.y+t.h<=n.h)return o}return{x:0,y:0}}var t={release:0,development:1},i=new n;return{basicdesign:i,Maturity:t,placementStrategy:r}});