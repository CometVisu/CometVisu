<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>CometVisu Source: plugins/powerspectrum/structure_plugin.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.spacelab.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">CometVisu</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-lib_CometVisuClient.html">lib/CometVisuClient</a></li><li><a href="module-lib_TemplateEngine.html">lib/TemplateEngine</a></li><li><a href="module-plugins_powerspectrum_structure_plugin.html">plugins/powerspectrum/structure_plugin</a></li><li><a href="module-structure_pure.html">structure/pure</a></li><li><a href="module-structure_pure_Audio.html">structure/pure/Audio</a></li><li><a href="module-structure_pure_Break.html">structure/pure/Break</a></li><li><a href="module-structure_pure_DesignToggle.html">structure/pure/DesignToggle</a></li><li><a href="module-structure_pure_Group.html">structure/pure/Group</a></li><li><a href="module-structure_pure_Image.html">structure/pure/Image</a></li><li><a href="module-structure_pure_ImageTrigger.html">structure/pure/ImageTrigger</a></li><li><a href="module-structure_pure_Include.html">structure/pure/Include</a></li><li><a href="module-structure_pure_Info.html">structure/pure/Info</a></li><li><a href="module-structure_pure_InfoAction.html">structure/pure/InfoAction</a></li><li><a href="module-structure_pure_InfoTrigger.html">structure/pure/InfoTrigger</a></li><li><a href="module-structure_pure_Line.html">structure/pure/Line</a></li><li><a href="module-structure_pure_Multitrigger.html">structure/pure/Multitrigger</a></li><li><a href="module-structure_pure_NavBar.html">structure/pure/NavBar</a></li><li><a href="module-structure_pure_Page.html">structure/pure/Page</a></li><li><a href="module-structure_pure_PageJump.html">structure/pure/PageJump</a></li><li><a href="module-structure_pure_PushButton.html">structure/pure/PushButton</a></li><li><a href="module-structure_pure_Refresh.html">structure/pure/Refresh</a></li><li><a href="module-structure_pure_Reload.html">structure/pure/Reload</a></li><li><a href="module-structure_pure_Rgb.html">structure/pure/Rgb</a></li><li><a href="module-structure_pure_Slide.html">structure/pure/Slide</a></li><li><a href="module-structure_pure_Switch.html">structure/pure/Switch</a></li><li><a href="module-structure_pure_Text.html">structure/pure/Text</a></li><li><a href="module-structure_pure_Toggle.html">structure/pure/Toggle</a></li><li><a href="module-structure_pure_Trigger.html">structure/pure/Trigger</a></li><li><a href="module-structure_pure_Unknown.html">structure/pure/Unknown</a></li><li><a href="module-structure_pure_UrlTrigger.html">structure/pure/UrlTrigger</a></li><li><a href="module-structure_pure_Video.html">structure/pure/Video</a></li><li><a href="module-structure_pure_Web.html">structure/pure/Web</a></li><li><a href="module-structure_pure_WgPluginInfo.html">structure/pure/WgPluginInfo</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="-_anonymous_-EventHandler-Dispatcher.html"><anonymous>~EventHandler~Dispatcher</a></li><li><a href="FOO.html">FOO</a></li><li><a href="module-cometvisu-client.html">cometvisu-client</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html#debug">debug</a></li><li><a href="global.html#fadeNavbar">fadeNavbar</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#handleRead">handleRead</a></li><li><a href="global.html#initializeNavbars">initializeNavbars</a></li><li><a href="global.html#jOWM">jOWM</a></li><li><a href="global.html#list">list</a></li><li><a href="global.html#navbarSetSize">navbarSetSize</a></li><li><a href="global.html#subscribe">subscribe</a></li><li><a href="global.html#updatePageParts">updatePageParts</a></li><li><a href="global.html#write">write</a></li>
				</ul>
			</li>
			
		</ul>
		<div class="col-sm-3 col-md-3">
            <form class="navbar-form" role="search">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                    <div class="input-group-btn">
                        <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                    </div>
                </div>
            </form>
        </div>
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: plugins/powerspectrum/structure_plugin.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">/* structure_plugin.js (c) 2016 by Christian Mayer [CometVisu at ChristianMayer dot de]
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 3 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA
*/


/**
 * The powerspectrum plugin and widget creates a graph to show the power 
 * spectral data that the Enertex Smartmeter can send on the KNX bus.
 * 
 * @module plugins/powerspectrum/structure_plugin
 * @requires structure/pure
 * @author Christian Mayer
 * @since 0.10.0
 * */

require.config({
  shim: {
    'plugins/diagram/dep/flot/jquery.flot.min':          ['jquery'],
    'plugins/diagram/dep/flot/jquery.flot.canvas.min':   ['plugins/diagram/dep/flot/jquery.flot.min'],
    'plugins/diagram/dep/flot/jquery.flot.resize.min':   ['plugins/diagram/dep/flot/jquery.flot.min'],
    'plugins/diagram/dep/flot/jquery.flot.navigate.min': ['plugins/diagram/dep/flot/jquery.flot.min']
  }
});

define( ['structure_custom',
    'plugins/diagram/dep/flot/jquery.flot.min',
    'plugins/diagram/dep/flot/jquery.flot.canvas.min',
    'plugins/diagram/dep/flot/jquery.flot.resize.min',
    'plugins/diagram/dep/flot/jquery.flot.navigate.min'
  ], function( VisuDesign_Custom ) {
  "use strict";
  
  // Constants
  var
    CURRENT = 0,
    VOLTAGE = 1,
    limitEN50160_1999 = [[2,0.02],[3,0.05],[4,0.01],[5,0.06],[6,0.005],[7,0.05],
      [8,0.005],[9,0.015],[10,0.005],[11,0.035],[12,0.005],[13,0.03],[14,0.005],
      [15,0.005],[16,0.005],[17,0.02],[18,0.005],[19,0.015],[20,0.005],
      [21,0.005],[22,0.005],[23,0.015],[24,0.005],[25,0.015]
    ], // limit for voltage in ratio
    limitEN61000_3_2 = [[2,1.620],[3,3.450],[4,0.650],[5,1.710],[6,0.450],
      [7,1.160],[8,0.350],[9,0.600],[10,0.280],[11,0.500],[12,0.233],[13,0.320],
      [14,0.200],[15,0.230],[16,0.175],[17,0.203],[18,0.155],[19,0.182],
      [20,0.140],[21,0.164],[22,0.127],[23,0.150],[24,0.117],[25,0.139]
    ], // limit for current in Ampere
    referenceSin = [[],[],[]];
  
  // fix limits for better displaying
  function fixLimits( entry, index, array )
  {
    array[index][0] -= 0.5;
  }
  function lastShifted( array )
  {
    var last = array[ array.length-1 ];
    return [ last[0]+1, last[1] ];
  }
  
  limitEN50160_1999.forEach( fixLimits );
  limitEN50160_1999.push( lastShifted( limitEN50160_1999 ) );
  limitEN61000_3_2.forEach( fixLimits );
  limitEN61000_3_2.push( lastShifted( limitEN61000_3_2 ) );
  
  // fill reference
  for( var phi = 0; phi &lt; 50; phi++ )
  {
    var
      time = phi * 20 / 50; // time in milliseconds
    
    referenceSin[0].push( [ time, Math.sin( (phi      ) * Math.PI / 25 ) ] );
    referenceSin[1].push( [ time, Math.sin( (phi+ 50/3) * Math.PI / 25 ) ] );
    referenceSin[2].push( [ time, Math.sin( (phi+100/3) * Math.PI / 25 ) ] );
  }
  
  /**
   * Setup helper
   */
  function setupCurve()
  {
    return [[0,0],[0.4,0],[0.8,0],[1.2,0],[1.6,0],[2,0],[2.4,0],[2.8,0],[3.2,0],
    [3.6,0],[4,0],[4.4,0],[4.8,0],[5.2,0],[5.6,0],[6,0],[6.4,0],[6.8,0],[7.2,0],
    [7.6,0],[8,0],[8.4,0],[8.8,0],[9.2,0],[9.6,0],[10,0],[10.4,0],[10.8,0],
    [11.2,0],[11.6,0],[12,0],[12.4,0],[12.8,0],[13.2,0],[13.6,0],[14,0],
    [14.4,0],[14.8,0],[15.2,0],[15.6,0],[16,0],[16.4,0],[16.8,0],[17.2,0],
    [17.6,0],[18,0],[18.4,0],[18.8,0],[19.2,0],[19.6,0]];
  }
  function setupSpectrum( offset )
  {
    var ret_val = [];
    
    if( undefined === offset )
      offset = 0;
    
    for( var i = 2; i &lt; 52; i++ )
      ret_val.push( [ i + offset, 0 ] );
    return ret_val;
  }
  
  /**
   * Convert a spectrum to a curve
   */
  function updateCurve( input, target, phase )
  {
    var 
      inp = input[phase],
      out = target[phase],
      shift = (phase * 2 / 3 - 0.5) * Math.PI;
      
    for( var i = 0; i &lt; 50; i++ )
    {
      var
        phi  = i * Math.PI / 25,
        value = Math.cos( phi + shift ); // the base with 50 Hz
        
      // the harmonics
      for( var j = 2; j &lt; 50; j++ )
      {
        value += Math.cos( (phi+shift) * j ) * inp[j][1];
      }
      
      out[i][1] = value;
    }
  }
  
  /**
   * Little helper to setup the Flot dataset structure.
   */
  function createDatasetCurve( widgetData )
  {
    return widgetData.singlePhase ?
      [
        { label: null, data: referenceSin[0], color:13 }, // trick flot to automatically make color darker
        { label: 'L', data: widgetData.curve[0], color:1 }
      ] :
      [
        { label: null, data: referenceSin[0], color:13 },
        { label: null, data: referenceSin[1], color:14 },
        { label: null, data: referenceSin[2], color:15 },
        { label: 'L1', data: widgetData.curve[0], color:1 },
        { label: 'L2', data: widgetData.curve[1], color:2 },
        { label: 'L3', data: widgetData.curve[2], color:3 }
      ];
  }
  
  /**
   * Little helper to setup the Flot dataset structure.
   */
  function createDatasetSpectrum( widgetData )
  {
    return widgetData.singlePhase ? 
      [
        { label: widgetData.limitName, data:widgetData.displayType===VOLTAGE?limitEN50160_1999:limitEN61000_3_2, bars:{show:false}, lines:{steps:true}, color:0 },
        { label: widgetData.name1, data:widgetData.spectrum[0] , color:1}
      ] :
      [
        { label: widgetData.limitName, data:widgetData.displayType===VOLTAGE?limitEN50160_1999:limitEN61000_3_2, bars:{show:false}, lines:{steps:true}, color:0 },
        { label: widgetData.name1, data:widgetData.spectrum[0], color:1 },
        { label: widgetData.name2, data:widgetData.spectrum[1], color:2 },
        { label: widgetData.name3, data:widgetData.spectrum[2], color:3 }
      ];
  }

  /**
   * This will create a diagram to show the frequency that the Enertex 
   * Smartmeter pushes on the KNX bus.
   */
  VisuDesign_Custom.prototype.addCreator( 'powerspectrum', {
    create: function( element, path, flavour, type ) {
      var 
        $e = $(element),
        displayType = $e.attr('type') === 'current' ? CURRENT : VOLTAGE,
        singlePhase = $e.attr('singlephase') === 'true' ? true : false;
      
      // create the main structure
      function handleVariant(src, transform, mode, variant)
      {
        if( !variant )
          variant = 'spectrum'; // the default
        
        return [true, variant];
      }
    
      var ret_val = templateEngine.design.createDefaultWidget( 'powerspectrum', $e, path, flavour, type, this.update, handleVariant );
      var data = templateEngine.widgetDataInsert( path, {
        displayType: displayType,
        singlePhase: singlePhase,
        spectrum: singlePhase ? [ setupSpectrum() ] : [ setupSpectrum(-0.26), setupSpectrum(0), setupSpectrum(0.26) ],
        limitName: $e.attr('limitname') || 'limit',
        name1: $e.attr('name1') || (singlePhase ? 'L' : 'L1'),
        name2: $e.attr('name2') || 'L2',
        name3: $e.attr('name3') || 'L3',
        curve: singlePhase ? [ setupCurve() ] : [ setupCurve(), setupCurve(), setupCurve() ],
        current: []
      });

      var 
        pageId = templateEngine.getPageIdForWidgetId( element, path ),
        showCurve = $e.attr('spectrumonly') === 'true' ? false : true,
        colors = [
          $e.attr('limitcolor') || "#edc240", // default directly from flot code
          $e.attr('color1')     || "#afd8f8",
          $e.attr('color2')     || "#cb4b4b",
          $e.attr('color3')     || "#4da74d"
        ];
      
      // create the actor
      var actor = '&lt;div class="actor clickable">';
      if( showCurve )
        actor += '&lt;div class="diagram_inline curve">loading...&lt;/div>';
      actor += '&lt;div class="diagram_inline spectrum">loading...&lt;/div>&lt;/div>';
      
      templateEngine.postDOMSetupFns.push( function(){
        var 
          diagramCurve = showCurve &amp;&amp; $( '#' + path + ' .actor div.curve' ).empty(),
          optionsCurve = showCurve &amp;&amp; {
            colors: colors,
            legend: {
              show: $e.attr('showlegend') === 'true' ? true : false // default to false
            },
            xaxis: {
              show: false
            },
            yaxis: {
              show: false
            }
          },
          diagramSpectrum = $( '#' + path + ' .actor div.spectrum' ).empty(),
          optionsSpectrum = {
            colors: colors,
            series: {
              bars: {
                show: true,
                fill: 1,
                fillColor: null,
                lineWidth: 0
              }
            },
            bars: {
              align: "center",
              barWidth: singlePhase ? 0.75 : 0.25
            },
            legend: {
              show: $e.attr('showlegend') === 'false' ? false : true // default to true
            },
            xaxis: {
              show: false
            },
            yaxis: {
              show: false
            },
          };
        data.plotCurve = showCurve &amp;&amp; $.plot(diagramCurve, createDatasetCurve( data ), optionsCurve);
        data.plot = $.plot(diagramSpectrum, createDatasetSpectrum( data ), optionsSpectrum);
      });
      
      return ret_val + actor + '&lt;/div>';
    },
    update: function( ga, data ) {
      var 
        element = $(this),
        widgetData = templateEngine.widgetDataGetByElement( this ),
        addressInfo = widgetData.address[ ga ];
        
      if( addressInfo[2][0] === 'I' )
      {
        var
          phase = widgetData.singlePhase ? 1 : +(addressInfo[2][1] || 1),
          value = templateEngine.transformDecode( addressInfo[0], data );
        widgetData.current[phase-1] = value / 1000; // transform mA to A
      } else if( 
        widgetData.address[ ga ][2].substr(0,8) === 'spectrum'
        &amp;&amp; data.length === 28 ) // sanity check for 14 bytes
      {
        var 
          phase = widgetData.singlePhase ? 1 : +(addressInfo[2][8] || 1),
          index = parseInt( data.substr( 0, 2 ), 16 ),
          factor = widgetData.current[phase-1] || 1,
          values = [];

        for( var i = 0; i &lt; 13; i++ )
        {
          if( index + i &lt; 2 )
            continue;
          
          values[i] = Math.pow( 10, (parseInt( data.substr( i*2 + 2, 2 ), 16 ) - 253) / 80);
          widgetData.spectrum[phase-1][ index + i - 2 ][1] = values[i] * factor;
        }
        widgetData.plot.setData( createDatasetSpectrum( widgetData ) );
        widgetData.plot.draw();
        
        if( widgetData.plotCurve )
        {
          updateCurve( widgetData.spectrum, widgetData.curve, phase-1 );
          widgetData.plotCurve.setData( createDatasetCurve( widgetData ) );
          widgetData.plotCurve.draw();
        }
      }
    }
  });
});</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>

<div class="modal fade" id="searchResults">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Search results</h4>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div>

<footer>


	<span class="copyright">
	CometVisu Copyright © 2010-2016, Christian Mayer and the CometVisu contributers.
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
	
		on Fri Aug 26th 2016
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>
<script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			var id = $( heading ).attr( "id" );
			return id && id.replace(/\~/g, '-inner-').replace(/\./g, '-static-') || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


<script type="text/javascript">
	$(document).ready(function() {
		SearcherDisplay.init();
	});
</script>

</body>
</html>
